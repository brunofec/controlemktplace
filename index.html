<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<meta name="app-version" content="V2.7.5"/>
<title>Controle Interno de Solicitações</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<link rel="icon" href="logo.png"/>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="config.js"></script>

<style>
  :root{
    --bg:#0f1216; 
    --panel:#151a21; 
    --panel-2:#1b222b; 
    --text:#e9eef5; 
    --muted:#9aacbf;
    --primary:#4f8cff; 
    --success:#21c38a; 
    --warning:#ffbf47; 
    --danger:#ff5d5d; 
    --badge:#2a3442;
    --border:#263040; 
    --shadow:0 10px 30px rgba(0,0,0,.35); 
    --radius:16px;
    --headH:96px;
  }

  /* TEMA CLARO: override de variáveis */
  body.theme-light{
    --bg:#f3f4f6;
    --panel:#ffffff;
    --panel-2:#f9fafb;
    --text:#111827;
    --muted:#6b7280;
    --primary:#2563eb;
    --success:#16a34a;
    --warning:#f59e0b;
    --danger:#dc2626;
    --badge:#e5e7eb;
    --border:#d1d5db;
    --shadow:0 10px 30px rgba(15,23,42,.08);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif
  }
  .wrap{max-width:1600px;margin:0 auto;padding:16px}
  header{
    position:sticky;top:0;z-index:5;
    backdrop-filter:saturate(160%) blur(10px);
    background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,0));
    border-bottom:1px solid var(--border)
  }
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .brand{display:flex;align-items:center;gap:10px;min-width:240px}
  .brand h1{font-size:22px;margin:0;white-space:nowrap}
  .logo-top{height:48px;object-fit:contain}
  .actions{margin-left:auto;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  button{
    background:var(--primary);color:#fff;border:none;
    padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer;
    transition:.2s transform ease,.2s opacity ease,.2s box-shadow ease;
    box-shadow:0 8px 18px rgba(79,140,255,.25)
  }
  button:hover{transform:translateY(-1px)}
  .btn-ghost{
    background:transparent;
    border:1px solid var(--border);
    color:var(--text);
    box-shadow:none
  }
  .btn-danger{background:var(--danger)} 
  .btn-success{background:var(--success)} 
  .btn-warning{background:var(--warning);color:#10151b}
  .btn-icon{
    padding:8px 10px;border-radius:10px;min-width:36px;
    display:inline-flex;align-items:center;justify-content:center;position:relative
  }
  .btn-icon.active{
    border-color:var(--primary);
    box-shadow:0 0 0 2px rgba(79,140,255,.18) inset
  }
  .pill{padding:6px 10px;border:1px solid var(--border);border-radius:999px}
  .panel{
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:16px;box-shadow:var(--shadow)
  }
  .panel-fill{
    height:calc(100vh - var(--headH) - 24px);
    display:flex;flex-direction:column;min-height:520px
  }
  .filters{
    display:grid;
    grid-template-columns:1.2fr 1fr 1fr 1fr .9fr 1fr auto auto;
    gap:10px
  }
  input,select,textarea{
    width:100%;padding:10px 12px;border-radius:12px;
    border:1px solid var(--border);background:#0f1319;color:var(--text);
    outline:none;font-size:14px
  }
  body.theme-light input,
  body.theme-light select,
  body.theme-light textarea{
    background:#ffffff;
  }

  .table-wrap{
    flex:1;min-height:240px;overflow:auto;
    border-radius:12px;border:1px solid var(--border);
    background:var(--panel-2)
  }
  /* expansor até a margem do card/painel */
  .table-wrap.edge{margin:0 -16px;border-left:none;border-right:none;border-radius:0}
  table{width:100%;border-collapse:collapse}
  thead th{
    text-align:left;padding:12px;font-size:13px;
    letter-spacing:.02em;color:var(--muted);
    background:var(--panel-2);
    border-bottom:1px solid var(--border);
    position:sticky;top:0;z-index:1
  }
  tbody td{
    padding:12px;border-bottom:1px solid var(--border);
    vertical-align:middle;font-size:14px
  }
  tbody tr:hover{
    background:rgba(255,255,255,.02)
  }
  body.theme-light tbody tr:hover{
    background:rgba(15,23,42,.04)
  }

  .badge{
    display:inline-flex;align-items:center;gap:6px;
    padding:6px 10px;border-radius:999px;
    background:var(--badge);font-size:12px
  }
  .status-aberto{background:#24324a;color:#9fc2ff} 
  .status-tratativa{background:#243f34;color:#7eedc0}
  .status-encerrado{background:#37313e;color:#e6b4ff} 
  .status-pendente{background:#473b1e;color:#ffd58a}
  .prio-alta{border:1px solid var(--danger);color:#ff9f9f} 
  .prio-media{border:1px solid var(--warning);color:#ffd58a} 
  .prio-baixa{border:1px solid #6fb7ff;color:#a8d3ff}
  .table-actions{display:flex;gap:8px;flex-wrap:nowrap;white-space:nowrap}
  .muted{color:var(--muted)} 
  .nowrap{white-space:nowrap}

  .sak-badge{background:#402a14;color:#ffb26b;border:1px solid #5a3a1b}
  .frota-badge{background:#223348;color:#aeddff;border:1px solid #2f4e68}

  .badge-unread{
    position:absolute;top:-6px;right:-6px;
    background:#ff5d5d;color:#fff;border-radius:999px;font-size:10px;
    min-width:16px;height:16px;padding:0 4px;
    display:grid;place-items:center;
    box-shadow:0 0 0 2px var(--panel)
  }

  .watermark{
    position:fixed;left:50%;transform:translateX(-50%);
    bottom:8px;color:#7a8596;font-size:12px;
    opacity:.65;pointer-events:none
  }
  .space{height:14px}
  .hidden{display:none !important}
  .hidden-input{position:absolute;opacity:0;pointer-events:none;width:0;height:0}
  .readonly input,.readonly select,.readonly textarea{pointer-events:none;opacity:.8}

  .modal{
    position:fixed;inset:0;display:none;place-items:center;
    background:rgba(0,0,0,.45);z-index:20
  }
  .modal.show{display:grid}
  .modal .card{
    width:min(980px,96vw);max-height:92vh;overflow:auto;
    background:var(--panel);border:1px solid var(--border);
    border-radius:16px;box-shadow:var(--shadow);padding:16px
  }
  .grid-2{display:grid;grid-template-columns:1.3fr .7fr;gap:14px}
  .grid-form{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  .grid-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  .grid-4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px}

  .chat-box{
    display:flex;flex-direction:column;height:520px;
    border:1px solid var(--border);
    border-radius:12px;background:var(--panel-2)
  }
  .chat-history{
    flex:1;overflow:auto;overscroll-behavior:contain;
    padding:12px;display:flex;flex-direction:column;gap:8px
  }
  .bubble{
    max-width:80%;padding:10px 12px;border-radius:16px;
    white-space:pre-wrap;word-break:break-word;line-height:1.35
  }
  .me{
    align-self:flex-end;background:#1a2430;border:1px solid #27384b
  }
  .them{
    align-self:flex-start;background:#171321;border:1px solid #2a2538
  }
  body.theme-light .me{
    background:#e5f0ff;border-color:#bfd3ff
  }
  body.theme-light .them{
    background:#f3e8ff;border-color:#ddc3ff
  }
  .bubble time{
    display:block;font-size:11px;color:#9aacbf;
    margin-top:4px;text-align:right
  }
  .sep{display:flex;align-items:center;gap:8px;margin:8px 0}
  .sep::before,.sep::after{
    content:"";height:1px;background:var(--border);flex:1
  }
  .sep span{font-size:11px;color:var(--muted)}
  .chat-input{
    display:flex;gap:8px;padding:10px;
    border-top:1px solid var(--border)
  }
  .chat-input input{flex:1}

  /* KPIs */
  .kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .kpi-card{
    background:var(--panel-2);
    border:1px solid var(--border);
    border-radius:14px;padding:16px
  }
  .kpi-card small{color:var(--muted)} 
  .kpi-card strong{display:block;font-size:26px;margin-top:8px}
  .kpi-sub{font-size:12px;color:var(--muted);margin-top:6px}
  .charts{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
  @media (max-width:1100px){ .charts{grid-template-columns:1fr} }

  /* DM (chat usuários) */
  .dm-launcher{position:fixed;right:18px;bottom:18px;z-index:50}
  .dm-fab{
    width:56px;height:56px;border-radius:50%;
    display:grid;place-items:center;font-size:20px;
    background:var(--primary);color:#fff;
    box-shadow:0 12px 24px rgba(79,140,255,.35)
  }
  .dm-fab .badge-unread{top:-4px;right:-4px}
  .dm-panel{
    position:fixed;right:18px;bottom:86px;width:min(380px,92vw);
    height:min(560px,calc(100vh - 120px));max-height:calc(100vh - 120px);
    background:var(--panel);border:1px solid var(--border);
    border-radius:16px;box-shadow:var(--shadow);
    display:none;flex-direction:column;z-index:60;overflow:hidden
  }
  .dm-panel.show{display:flex}
  .dm-head{
    display:flex;align-items:center;gap:10px;
    padding:10px 12px;border-bottom:1px solid var(--border)
  }
  .dm-body{
    flex:1;min-height:0;
    display:grid;grid-template-rows:190px 1fr
  }
  .dm-users{overflow:auto;border-bottom:1px solid var(--border)}
  .dm-users .item{
    display:flex;align-items:center;gap:8px;
    padding:8px 12px;border-bottom:1px dashed rgba(255,255,255,.04);
    cursor:pointer
  }
  .dm-users .item:hover{background:#0f141a}
  body.theme-light .dm-users .item:hover{background:#edf2ff}
  .dm-chat{display:flex;flex-direction:column;min-height:0}
  .dm-history{
    flex:1;overflow:auto;overscroll-behavior:contain;
    padding:12px;display:flex;flex-direction:column;gap:6px;
    background:var(--panel-2)
  }
  .dm-input{
    display:flex;gap:8px;padding:10px;
    border-top:1px solid var(--border);background:var(--panel)
  }
  .dm-input input{flex:1}
  .bubble.dm{max-width:80%}
  .dm-sep{display:flex;align-items:center;gap:8px;margin:8px 0}
  .dm-sep::before,.dm-sep::after{
    content:"";height:1px;background:var(--border);flex:1
  }
  .dm-sep span{font-size:11px;color:var(--muted)}

  /* Sort + paginação */
  .sortable{cursor:pointer;user-select:none}
  .sortable .sort-icon{
    margin-left:4px;font-size:10px;opacity:.7
  }
  .pager-btn{
    padding:4px 8px;
    font-size:12px;
    border-radius:999px;
    background:transparent;
    border:1px solid var(--border);
    color:var(--text);
    cursor:pointer;
    min-width:28px;
  }
  .pager-btn[disabled]{
    opacity:.4;cursor:default
  }
  .pager-pages{display:flex;gap:6px;align-items:center}

/* Toast / notificações */
#toast{
  position:fixed;
  right:16px;
  bottom:16px;
  z-index:9999;
  display:flex;
  flex-direction:column;
  gap:8px;
  pointer-events:none;
}
#toast .t{
  background:var(--panel);
  color:#fff;
  padding:10px 14px;
  border-radius:10px;
  box-shadow:0 10px 25px rgba(0,0,0,.5);
  font-size:13px;
  opacity:0;
  transform:translateY(10px);
  transition:opacity .2s ease, transform .2s ease;
  pointer-events:auto;
}
html[data-theme='light'] #toast .t{
  background:var(--panel-2);
  color:var(--text);
}
#toast .t.show{
  opacity:1;
  transform:translateY(0);
}


  .hidden{display:none !important;}

  .notif-btn{position:relative;}
  .notif-badge{
    position:absolute;top:-4px;right:-4px;
    background:#f97316;color:#fff;border-radius:999px;
    min-width:16px;height:16px;font-size:10px;
    display:grid;place-items:center;
    padding:0 4px;
    box-shadow:0 0 0 2px var(--panel);
  }

  .notif-panel{
    position:fixed;
    top:80px;
    right:16px;
    width:320px;
    max-height:60vh;
    background:var(--panel);
    border:1px solid var(--border);
    box-shadow:var(--shadow);
    border-radius:12px;
    display:flex;
    flex-direction:column;
    z-index:1200;
  }
  body.theme-light .notif-panel{
    background:#ffffff;
  }
  .notif-head{
    padding:10px 12px;
    border-bottom:1px solid var(--border);
    display:flex;
    align-items:center;
    gap:8px;
  }
  .notif-list{
    padding:8px 0;
    overflow-y:auto;
  }
  .notif-item{
    padding:8px 12px;
    cursor:pointer;
    display:flex;
    flex-direction:column;
    gap:2px;
  }
  .notif-item:hover{
    background:rgba(255,255,255,.04);
  }
  body.theme-light .notif-item:hover{
    background:rgba(15,23,42,.04);
  }
  .notif-msg{
    font-size:13px;
  }
  .notif-meta{
    font-size:11px;
    color:var(--muted);
  }
  .notif-read .notif-msg{
    opacity:.7;
  }
  .notif-empty{
    padding:12px;
    text-align:center;
    font-size:12px;
    color:var(--muted);
  }

  /* DESATIVAR DM (chat usuários) */
  .dm-launcher,
  #dmPanel{
    display:none !important;
  }

  /* esconder botões Encerrados e Diagnóstico */
  #btnClosed,
  #btnDiag{
    display:none !important;
  }

  /* ===== UX v2.6: tabs, chips, view modes, actions menu, SLA semáforo ===== */

  /* colunas por modo (apenas lista principal) */
  #tbl.mode-operacao th:nth-child(2), #tbl.mode-operacao td:nth-child(2),
  #tbl.mode-operacao th:nth-child(5), #tbl.mode-operacao td:nth-child(5),
  #tbl.mode-operacao th:nth-child(6), #tbl.mode-operacao td:nth-child(6),
  #tbl.mode-operacao th:nth-child(10), #tbl.mode-operacao td:nth-child(10){
    display:none;
  }
  /* Operação: prioridade mais leve */
  #tbl.mode-operacao .prio-lite{opacity:.8}
  #tbl.mode-gestao th:nth-child(7), #tbl.mode-gestao td:nth-child(7){
    display:none;
  }

  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tab-btn{
    padding:8px 12px;border-radius:999px;
    background:transparent;border:1px solid var(--border);color:var(--text);
    cursor:pointer;font-weight:600;font-size:13px
  }
  .tab-btn.active{
    border-color:var(--primary);
    box-shadow:0 0 0 2px rgba(79,140,255,.18) inset;
  }
  .chipbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .chip{
    padding:6px 10px;border-radius:999px;
    border:1px solid var(--border);
    background:rgba(255,255,255,.02);
    color:var(--text);
    font-size:12px;
    cursor:pointer;
    user-select:none;
  }
  body.theme-light .chip{background:rgba(15,23,42,.03)}
  .chip.active{border-color:var(--primary); box-shadow:0 0 0 2px rgba(79,140,255,.18) inset}
  .viewmodes{display:flex;gap:8px;flex-wrap:wrap}
  .view-btn{padding:8px 10px;border-radius:12px;border:1px solid var(--border);background:transparent;color:var(--text);cursor:pointer;font-weight:600;font-size:13px}
  .view-btn.active{border-color:var(--primary); box-shadow:0 0 0 2px rgba(79,140,255,.18) inset}
  .actions-menu{position:relative;display:inline-flex}
  .menu{
    position:absolute;right:0;top:42px;min-width:180px;
    background:var(--panel);border:1px solid var(--border);
    border-radius:12px;box-shadow:var(--shadow);
    padding:6px;display:none;z-index:50
  }
  .menu.show{display:block}
  .menu button{
    width:100%;
    display:flex;align-items:center;gap:8px;justify-content:flex-start;
    padding:8px 10px;border-radius:10px;
    background:transparent;border:1px solid transparent;
    color:var(--text);box-shadow:none;font-weight:600
  }
  .menu button:hover{border-color:var(--border); background:rgba(255,255,255,.03)}
  body.theme-light .menu button:hover{background:rgba(15,23,42,.04)}
  .sla-pill{border:1px solid transparent}
  .sla-ok{background:rgba(33,195,138,.12);border-color:rgba(33,195,138,.35);color:#7eedc0}
  .sla-risk{background:rgba(255,191,71,.12);border-color:rgba(255,191,71,.35);color:#ffd58a}
  .sla-late{background:rgba(255,93,93,.12);border-color:rgba(255,93,93,.35);color:#ff9f9f}
  body.theme-light .sla-ok{color:#0f5132}
  body.theme-light .sla-risk{color:#6b3d00}
  body.theme-light .sla-late{color:#7f1d1d}
  .prio-lite{opacity:.85}


  /* ===== Enterprise UI: Tabs, Chips, KPIs, Menu, Drawer ===== */
  .kpi-strip{
    display:grid;
    grid-template-columns:repeat(4,1fr);
    gap:10px;
    margin-bottom:10px;
  }
  .kpi-mini{
    background:var(--panel-2);
    border:1px solid var(--border);
    border-radius:14px;
    padding:12px 12px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    cursor:pointer;
    user-select:none;
  }
  .kpi-mini:hover{transform:translateY(-1px)}
  .kpi-mini .label{color:var(--muted);font-size:12px}
  .kpi-mini .value{font-size:22px;font-weight:700}
  .kpi-mini .hint{font-size:11px;color:var(--muted)}
  .kpi-mini .icon{width:34px;height:34px;border-radius:12px;border:1px solid var(--border);display:grid;place-items:center}
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tab-btn{
    background:transparent;
    border:1px solid var(--border);
    color:var(--text);
    padding:8px 12px;
    border-radius:999px;
    cursor:pointer;
    font-weight:600;
    box-shadow:none;
  }
  .tab-btn.active{
    border-color:var(--primary);
    box-shadow:0 0 0 2px rgba(79,140,255,.18) inset;
  }
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{
    background:transparent;
    border:1px solid var(--border);
    color:var(--text);
    padding:8px 10px;
    border-radius:999px;
    cursor:pointer;
    box-shadow:none;
    font-weight:600;
    display:inline-flex;
    align-items:center;
    gap:8px;
  }
  .chip.active{
    border-color:var(--primary);
    box-shadow:0 0 0 2px rgba(79,140,255,.18) inset;
  }
  .chip .dot{width:8px;height:8px;border-radius:999px;background:var(--border)}
  .chip.dot-red  .dot{background:var(--danger)}
  .chip.dot-amber .dot{background:var(--warning)}
  .chip.dot-green .dot{background:var(--success)}
  .chip.dot-blue .dot{background:var(--primary)}
  .chip.dot-gray .dot{background:var(--muted)}
  .toolbar{
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
    margin-bottom:10px;
  }
  .toolbar .search{flex:1;min-width:260px}
  .view-modes{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .view-btn{background:transparent;border:1px solid var(--border);color:var(--text);padding:8px 10px;border-radius:12px;cursor:pointer;box-shadow:none;font-weight:700}
  .view-btn.active{border-color:var(--primary);box-shadow:0 0 0 2px rgba(79,140,255,.18) inset}
  .sla-pill{border:1px solid var(--border)}
  .sla-ok{border-color:rgba(33,195,138,.45); background:rgba(33,195,138,.12)}
  .sla-risk{border-color:rgba(255,191,71,.55); background:rgba(255,191,71,.14)}
  .sla-late{border-color:rgba(255,93,93,.55); background:rgba(255,93,93,.12)}
  .actions-wrap{position:relative;display:inline-flex;gap:8px;align-items:center}
  .more-menu{
    position:absolute;
    right:0;
    top:42px;
    min-width:220px;
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:14px;
    box-shadow:var(--shadow);
    padding:8px;
    z-index:99;
    display:none;
  }
  .more-menu.show{display:block}
  .more-item{
    display:flex;
    gap:10px;
    align-items:center;
    padding:10px 10px;
    border-radius:12px;
    cursor:pointer;
    color:var(--text);
    border:1px solid transparent;
    user-select:none;
  }
  .more-item:hover{
    background:rgba(255,255,255,.04);
    border-color:rgba(255,255,255,.06);
  }
  body.theme-light .more-item:hover{
    background:rgba(15,23,42,.04);
    border-color:rgba(15,23,42,.06);
  }


  /* View modes: hide/show columns */
  body[data-view="operacao"] .col-solicitante,
  body[data-view="operacao"] .col-categoria,
  body[data-view="operacao"] .col-canal,
  body[data-view="operacao"] .col-resp{
    display:none;
  }
  body[data-view="gestao"] .col-descricao,
  body[data-view="gestao"] .col-acoes{ /* keep actions, but hide some noisy cols */
  }
  body[data-view="gestao"] .col-assunto{ }
  body[data-view="gestao"] .col-codigo{ }

  /* Drawer (Filtros avançados) */
  .drawer{
    position:fixed; inset:0;
    display:none;
    z-index:2000;
    background:rgba(0,0,0,.45);
  }
  .drawer.show{display:block}
  .drawer-panel{
    position:absolute;
    right:0; top:0; bottom:0;
    width:min(420px,92vw);
    background:var(--panel);
    border-left:1px solid var(--border);
    padding:16px;
    box-shadow:var(--shadow);
    overflow:auto;
  }
  .drawer-head{display:flex;align-items:center;gap:10px}
  .drawer-head h3{margin:0;font-size:16px}
  .drawer-grid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:12px}
  .drawer-grid label{font-size:12px;color:var(--muted)}
  .drawer-grid .field{display:flex;flex-direction:column;gap:6px}
  .drawer-actions{display:flex;gap:10px;margin-top:14px}
  @media (max-width:1100px){
    .kpi-strip{grid-template-columns:repeat(2,1fr)}
  }

</style>
</head>
<body>

<!-- LOGIN -->
<section id="loginSection" style="min-height:100vh;display:none;place-items:center;padding:20px">
  <div style="width:min(420px,92vw);background:var(--panel);border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);padding:22px">
    <div class="row" style="flex-direction:column;align-items:center;gap:6px">
      <img src="logo.png" class="logo-top" alt="Logo"><h2 style="margin:0">Entrar</h2>
    </div>
    <p class="muted small">Seja Bem-Vindo!</p>
    <div class="space"></div>
    <div class="row" style="flex-direction:column;gap:10px">
      <input id="loginUser" placeholder="Usuário ou e-mail" autofocus>
      <input id="loginPass" placeholder="Senha" type="password">
      <button id="btnLogin" class="btn-success"><i class="fa fa-right-to-bracket"></i> Entrar</button>
    </div>
  </div>
</section>

<!-- APP -->
<section id="appSection" style="display:none">
  <header>
    <div class="wrap row">
      <div class="brand"><img src="logo.png" class="logo-top" alt="Logo"><h1>Controle Interno de Solicitações</h1></div>
      <div class="actions">
        <span id="whoami" class="pill"></span>
        <!-- Toggle de tema -->
        <button id="btnTheme" class="btn-ghost btn-icon" title="Alternar tema"><i id="themeIcon" class="fa fa-moon"></i></button>
        <button id="btnNotif" class="btn-ghost btn-icon notif-btn" title="Notificações">
          <i class="fa fa-bell"></i>
          <span id="notifCount" class="notif-badge hidden">0</span>
        </button>
        <button id="btnClosed" class="btn-ghost"><i class="fa fa-archive"></i> Encerrados</button>
        <button id="btnKPIs" class="btn-ghost"><i class="fa fa-chart-pie"></i> Painel KPIs</button>
        <button id="btnNew"><i class="fa fa-plus"></i> Nova</button>
        <button id="btnExportXLSX" class="btn-ghost"><i class="fa fa-file-excel"></i> Exportar</button>
        <button id="btnDiag" class="btn-ghost"><i class="fa fa-stethoscope"></i> Diagnóstico</button>
        <button id="btnLogout" class="btn-ghost">
          <i class="fa fa-right-from-bracket"></i> Sair
        </button>

      </div>
    </div>
  </header>

  <!-- Diagnóstico -->
  <div id="diagBar" class="hidden" style="background:#13202e;color:#cde2ff;border-bottom:1px solid var(--border)">
    <div class="wrap" style="display:flex;gap:16px;align-items:center;padding:8px 0;font-size:13px">
      <strong>Diagnóstico</strong>
      <span id="diagEnv"></span>
      <span id="diagUser"></span>
      <span id="diagCount"></span>
      <span id="diagErr" style="color:#ffb0b0"></span>
      <button id="diagClose" class="btn-ghost" style="margin-left:auto">Fechar</button>
    </div>
  </div>

  <!-- LISTA -->
  <main id="listPage" class="wrap">
    <section class="panel panel-fill">
      <!-- KPIs operacionais (clique para filtrar) -->
      <div class="kpi-strip" id="kpiStrip">
        <div class="kpi-mini" data-kpi="late" title="Clique para filtrar vencidos">
          <div>
            <div class="label">Vencidos</div>
            <div class="value" id="kpiLate">0</div>
            <div class="hint">SLA estourado</div>
          </div>
          <div class="icon"><i class="fa fa-triangle-exclamation"></i></div>
        </div>
        <div class="kpi-mini" data-kpi="risk" title="Clique para filtrar em risco">
          <div>
            <div class="label">Em risco</div>
            <div class="value" id="kpiRisk">0</div>
            <div class="hint">≤ 12h do prazo</div>
          </div>
          <div class="icon"><i class="fa fa-hourglass-half"></i></div>
        </div>
        <div class="kpi-mini" data-kpi="unassigned" title="Clique para filtrar sem responsável">
          <div>
            <div class="label">Sem responsável</div>
            <div class="value" id="kpiUnassigned">0</div>
            <div class="hint">Abertos/Tratativa</div>
          </div>
          <div class="icon"><i class="fa fa-user-xmark"></i></div>
        </div>
        <div class="kpi-mini" data-kpi="pendDue" title="Clique para filtrar pendências vencidas">
          <div>
            <div class="label">Pendentes vencidas</div>
            <div class="value" id="kpiPendDue">0</div>
            <div class="hint">Retomar &lt; hoje</div>
          </div>
          <div class="icon"><i class="fa fa-clock"></i></div>
        </div>
      </div>

      <!-- Tabs de fila -->
      <div class="row" style="align-items:center;gap:10px;margin-bottom:10px;justify-content:space-between">
        <div class="tabs" id="statusTabs">
          <button class="tab-btn active" data-tab="Aberto">Abertos</button>
          <button class="tab-btn" data-tab="Em tratativa">Em tratativa</button>
          <button class="tab-btn" data-tab="Pendente">Pendentes</button>
          <button class="tab-btn" data-tab="Encerrado">Encerrados</button>
          <button class="tab-btn" data-tab="Tudo">Tudo</button>
        </div>

        <div class="view-modes" title="Modos de visualização">
          <button class="view-btn active" data-view="operacao"><i class="fa fa-bolt"></i> Operação</button>
          <button class="view-btn" data-view="detalhado"><i class="fa fa-table"></i> Detalhado</button>
          <button class="view-btn" data-view="gestao"><i class="fa fa-chart-simple"></i> Gestão</button>
        </div>
      </div>

      <!-- Chips rápidos -->
      <div class="row" style="align-items:center;gap:10px;margin-bottom:10px">
        <div class="chips" id="quickChips">
          <button class="chip dot-red" data-chip="sla" data-value="late" onclick="onChipClick(event,this)"><span class="dot"></span>Vencidos</button>
          <button class="chip dot-amber" data-chip="sla" data-value="risk" onclick="onChipClick(event,this)"><span class="dot"></span>Em risco</button>
          <button class="chip dot-blue" data-chip="mine" data-value="1" onclick="onChipClick(event,this)"><span class="dot"></span>Meus</button>
          <button class="chip dot-gray" data-chip="categoria" data-value="Frota - Transportadora" onclick="onChipClick(event,this)"><span class="dot"></span>Frota</button>
          <button class="chip dot-gray" data-chip="categoria" data-value="SAK" onclick="onChipClick(event,this)"><span class="dot"></span>SAK</button>
          <button class="chip dot-gray" data-chip="canal" data-value="Mercado Livre" onclick="onChipClick(event,this)"><span class="dot"></span>Mercado Livre</button>
          <button class="chip dot-gray" data-chip="canal" data-value="Shopee" onclick="onChipClick(event,this)"><span class="dot"></span>Shopee</button>
          <button class="chip dot-green" id="chipReset"><span class="dot"></span>Reset rápido</button>
        </div>
      </div>

      <!-- Barra principal -->
      <div class="toolbar">
        <input id="fSearch" class="search" placeholder="Buscar por assunto, solicitante, código do cliente, transportadora, descrição..." oninput="onSearchInput(event)"/>
        <button id="btnAdvanced" class="btn-ghost"><i class="fa fa-sliders"></i> Filtros avançados</button>
      </div>

      <!-- Filtros avançados (drawer) -->
      <div id="advDrawer" class="drawer">
        <div class="drawer-panel">
          <div class="drawer-head">
            <h3><i class="fa fa-sliders"></i> Filtros avançados</h3>
            <div style="margin-left:auto"></div>
            <button id="advClose" class="btn-ghost btn-icon" title="Fechar"><i class="fa fa-xmark"></i></button>
          </div>

          <div class="drawer-grid">
            <div class="field">
              <label>Status</label>
              <select id="fStatus">
                <option value="">Todos</option>
                <option>Aberto</option>
                <option>Em tratativa</option>
                <option>Pendente</option>
                <option>Encerrado</option>
              </select>
            </div>

            <div class="field">
              <label>Prioridade</label>
              <select id="fPrio">
                <option value="">Todas</option>
                <option>Alta</option>
                <option>Média</option>
                <option>Baixa</option>
              </select>
            </div>

            <div class="field">
              <label>Categoria</label>
              <select id="fCategoria">
                <option value="">Todas</option>
                <option>Frota - Transportadora</option>
                <option>SAK</option>
              </select>
            </div>

            <div class="field">
              <label>Canal</label>
              <select id="fCanal">
                <option value="">Todos</option>
                <option>Mercado Livre</option>
                <option>Shopee</option>
              </select>
            </div>

            <div class="field">
              <label>SLA</label>
              <select id="fSLA">
                <option value="">Todos</option>
                <option value="ok">No prazo</option>
                <option value="risk">Risco (≤12h)</option>
                <option value="late">Vencido</option>
              </select>
            </div>

            <div class="field">
              <label>Pendências</label>
              <select id="fPend">
                <option value="">Todas</option>
                <option value="pend">Só pendentes</option>
                <option value="due">Pendentes vencidas</option>
              </select>
            </div>

            <div class="field">
              <label>Responsável</label>
              <select id="fResp">
                <option value="">Todos</option>
                <option>Bruno</option><option>Maurilio</option><option>Jessica</option><option>Anna</option>
              </select>
            </div>

            <div class="field">
              <label>Somente meus</label>
              <div class="row" style="gap:10px">
                <button id="advMine" class="btn-ghost" type="button"><i class="fa fa-user-check"></i> Alternar</button>
                <span class="muted" style="font-size:12px">Usa solicitante/responsável/criador</span>
              </div>
            </div>

            <input type="checkbox" id="fMine" class="hidden-input">
            <input type="checkbox" id="fHideClosed" class="hidden-input">

            <button id="btnClear" style="display:none"></button>
            <button id="tgMine" style="display:none"></button>
            <button id="tgHideClosed" style="display:none"></button>

          </div>

          <div class="drawer-actions">
            <button id="advClear" class="btn-ghost" type="button"><i class="fa fa-eraser"></i> Limpar</button>
            <button id="advApply" class="btn-success" type="button"><i class="fa fa-check"></i> Aplicar</button>
          </div>

          <div class="space"></div>
          <div class="badge">Dica: use chips/tabs/KPIs pra operação. Deixe isso aqui pra filtros raros.</div>
        </div>
      </div>
<div class="table-wrap edge">
        <table id="tbl">
          <thead>
            <tr>
              <!-- Cabeçalhos agora “clicáveis” para ordenar -->
              <th data-field="abertoEm" class="sortable col-abertoEm">Aberto em<span class="sort-icon"></span></th>
              <th data-field="solicitante" class="sortable col-solicitante">Solicitante<span class="sort-icon"></span></th>
              <th data-field="assunto" class="sortable col-assunto">Assunto<span class="sort-icon"></span></th>
              <th data-field="codigo" class="sortable col-codigo">Código cliente<span class="sort-icon"></span></th>
              <th data-field="categoria" class="sortable col-categoria">Categoria<span class="sort-icon"></span></th>
              <th data-field="canal" class="sortable col-canal">Canal<span class="sort-icon"></span></th>
              <th data-field="prioridade" class="sortable col-prioridade">Prioridade<span class="sort-icon"></span></th>
              <th data-field="status" class="sortable col-status">Status<span class="sort-icon"></span></th>
              <th data-field="prazo" class="sortable col-sla">SLA<span class="sort-icon"></span></th>
              <th data-field="responsavel" class="sortable col-resp">Resp.<span class="sort-icon"></span></th>
              <th class="nowrap col-acoes">Ações</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <!-- Paginação -->
      <div id="pager" class="row" style="margin-top:8px;align-items:center;justify-content:space-between;font-size:13px"></div>

      <div class="badge" style="margin-top:10px">SLA por prioridade: Alta 1 dia • Média 3 dias • Baixa 5 dias (dias úteis)</div>
    </section>
  </main>

  <!-- ENCERRADOS -->
  <main id="closedPage" class="wrap hidden">
    <section class="panel panel-fill">
      <div class="row" style="align-items:center;margin-bottom:10px">
        <h2 style="margin:0;font-size:18px">Solicitações Encerradas</h2>
        <div style="margin-left:auto;display:flex;gap:10px;align-items:center">
          <input id="fClosed" placeholder="Buscar nas encerradas...">
          <button id="btnBackList" class="btn-ghost"><i class="fa fa-table"></i> Voltar à Tabela</button>
        </div>
      </div>
      <div class="table-wrap edge">
        <table>
          <thead>
            <tr>
              <!-- ID removido -->
              <th>Aberto em</th><th>Solicitante</th><th>Assunto</th><th>Código cliente</th>
              <th>Categoria</th><th>Canal</th><th>Prioridade</th><th>Status</th><th>Resp.</th>
            </tr>
          </thead>
          <tbody id="tbodyClosed"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- KPIs -->
  <main id="kpiPage" class="wrap hidden">
    <section class="panel">
      <div class="row" style="align-items:center;gap:12px">
        <h2 style="margin:0;font-size:18px">Painel — KPIs</h2>
        <div style="margin-left:auto;display:flex;gap:10px;align-items:center">
          <label class="muted" for="kpiMonth">Mês:</label><input id="kpiMonth" type="month"/>
          <button id="btnApplyKpi" class="btn-ghost"><i class="fa fa-filter"></i> Aplicar filtro</button>
          <button id="btnBackList2" class="btn-ghost"><i class="fa fa-table"></i> Voltar à Tabela</button>
        </div>
      </div>
      <div class="space"></div>

      <div class="kpi-grid">
        <div class="kpi-card"><small>Aberto (abertos no mês)</small><strong id="mKpiAberto">0</strong></div>
        <div class="kpi-card"><small>Em tratativa (abertos no mês)</small><strong id="mKpiTratativa">0</strong></div>
        <div class="kpi-card"><small>Pendente (abertos no mês)</small><strong id="mKpiPendente">0</strong></div>
        <div class="kpi-card"><small>Encerrado (abertos no mês)</small><strong id="mKpiEncerrado">0</strong></div>
      </div>

      <div class="space"></div>
      <div class="kpi-grid">
        <div class="kpi-card"><small>Concluídos no mês</small><strong id="mKpiFechadosMes">0</strong><div class="kpi-sub" id="mKpiFechadosBase">com SLA: 0</div></div>
        <div class="kpi-card"><small>% concluídos no prazo</small><strong id="mKpiPctPrazo">0%</strong><div class="kpi-sub" id="mKpiQtdPrazo">0 de 0</div></div>
        <div class="kpi-card"><small>% concluídos vencidos</small><strong id="mKpiPctVenc">0%</strong><div class="kpi-sub" id="mKpiQtdVenc">0 de 0</div></div>
        <div class="kpi-card"><small>Mês selecionado</small><strong id="mKpiMesLabel">—</strong><div class="kpi-sub">Base dos KPIs acima</div></div>
      </div>

      <div class="charts">
        <div class="panel"><h3 style="margin:0 0 10px 0;font-size:16px">Abertos no mês — por categoria</h3><canvas id="chartAbertos"></canvas></div>
        <div class="panel"><h3 style="margin:0 0 10px 0;font-size:16px">Concluídos no mês — No prazo x Vencidos (por categoria)</h3><canvas id="chartConcluidos"></canvas></div>
        <!-- NOVO gráfico -->
        <div class="panel"><h3 style="margin:0 0 10px 0;font-size:16px">Abertos no mês — Shopee x Mercado Livre</h3><canvas id="chartCanal"></canvas></div>
        <div class="panel" style="grid-column:1/-1"><h3 style="margin:0 0 10px 0;font-size:16px">Abertos no mês — por transportadora</h3><canvas id="chartTransp"></canvas></div>
      </div>
      <div class="space"></div>
      <div class="badge">KPIs “abertos/…” usam a <u>data de abertura</u>. Percentuais usam tickets <u>encerrados</u> no mês.</div>
    </section>
  </main>

  <div class="watermark">Desenvolvido por Bruno Ferreira da Cruz</div>
</section>

<!-- MODAL (ticket) -->
<div class="modal" id="modal">
  <div class="card">
    <div class="row" style="align-items:center">
      <!-- título sem exibir ID -->
      <h2 id="modalTitle" style="margin:0;font-size:18px">Nova solicitação</h2>
      <div class="actions" style="margin-left:auto"><button class="btn-ghost" id="closeModal"><i class="fa fa-xmark"></i></button></div>
    </div>
    <div class="space"></div>

    <div class="grid-2">
      <!-- FORM -->
      <form id="frm" autocomplete="off" style="display:flex;flex-direction:column;gap:12px">
        <!-- ID permanece oculto para controle interno/Supabase -->
        <input type="hidden" id="ticketId">

        <div class="grid-form">
          <div><label>Solicitante</label><input id="solicitante" /></div>
          <div><label>Categoria</label><select id="categoriaSel"><option>Frota - Transportadora</option><option>SAK</option></select></div>
          <div><label>Prioridade</label><select id="prioridade"><option>Alta</option><option selected>Média</option><option>Baixa</option></select></div>
        </div>

        <div class="grid-row">
          <div>
            <label>Assunto</label>
            <select id="assunto" required>
              <option value="">Selecione…</option>
              <option>Cliente Ausente</option>
              <option>Solicitação contato</option>
              <option>End. não encontrado</option>
              <option>Arrependimento</option>
              <option>Atraso de entrega</option>
              <option>Mercado Fraude</option>
              <option>Ruptura de estoque</option>
              <option>Danificado</option>
              <option>Erro cadastro</option>
              <option>Solicitar Coleta</option>
              <option>Barrar Entrega</option>
              <option>Outras Informações</option>
            </select>
          </div>
          <div><label>Status</label><select id="status"><option>Aberto</option><option>Em tratativa</option><option>Pendente</option><option>Encerrado</option></select></div>
        </div>

        <!-- troquei para grid-4 e acrescentei Canal -->
        <div class="grid-4">
          <div><label>Código do cliente</label><input id="codigo" placeholder="Ex.: 12345"/></div>
          <div id="transportadoraWrap">
            <label>Transportadora</label>
            <input id="transportadora" list="lstTransportadora" placeholder="Ex.: Atual, Reunidas..."/>
            <datalist id="lstTransportadora">
              <option value="Atual"></option><option value="Correios / Sedex"></option><option value="Reunidas"></option>
              <option value="TTJB"></option><option value="Rede Sul"></option><option value="Brasil Web"></option>
              <option value="Zanotelli"></option><option value="Uber"></option><option value="Outros"></option>
            </datalist>
          </div>
          <div id="responsavelWrap"><label>Responsável</label>
            <select id="responsavel"><option></option><option>Bruno</option><option>Maurilio</option><option>Jessica</option><option>Anna</option></select>
          </div>
          <!-- NOVO CAMPO: Canal -->
          <div><label>Canal</label>
            <select id="canalSel">
              <option value=""></option>
              <option>Mercado Livre</option>
              <option>Shopee</option>
            </select>
          </div>
        </div>

        <div><label>Descrição</label><textarea id="descricao" rows="4" placeholder="Detalhe o que precisa"></textarea></div>

        <div class="grid-row">
          <div><label>Prazo (SLA) — Data</label><input id="prazo" type="date"/></div>
          <div><label>&nbsp;</label><div class="badge">Definido automaticamente (dias úteis) se vazio</div></div>
        </div>

        <div class="row" style="gap:8px">
          <button type="button" class="btn-warning btn-icon" id="btnConfirm" title="Confirmar (tratativa)"><i class="fa fa-check-double"></i></button>
          <button type="button" class="btn-danger btn-icon" id="btnDelete" title="Excluir"><i class="fa fa-trash"></i></button>
          <div style="flex:1"></div>
          <button class="btn-success" id="btnSave"><i class="fa fa-floppy-disk"></i> Salvar</button>
        </div>
      </form>

      <!-- CHAT do ticket -->
      <div>
        <label>Chat da Solicitação</label>
        <div class="chat-box">
          <div id="chatHistory" class="chat-history"></div>
          <div class="chat-input">
            <input id="chatText" placeholder="Digite uma mensagem e Enter (Shift+Enter para nova linha)"/>
            <button id="btnSendChat" class="btn-ghost btn-icon"><i class="fa fa-paper-plane"></i></button>
          </div>
        </div>
        <div style="margin-top:10px" class="muted small" id="chatHint">Mensagens ficam registradas no histórico do ticket.</div>
      </div>
    </div>
  </div>
</div>


<!-- Notificações -->
<div id="notifPanel" class="notif-panel hidden">
  <div class="notif-head">
    <strong><i class="fa fa-bell"></i> Notificações</strong>
    <button id="notifClose" class="btn-ghost btn-icon" title="Fechar"><i class="fa fa-xmark"></i></button>
  </div>
  <div id="notifList" class="notif-list"></div>
</div>

<!-- DM (chat usuários) -->
<div class="dm-launcher">
  <button id="dmFab" class="dm-fab btn-icon" title="Chat com usuários"><i class="fa fa-comments"></i><span id="dmBadge" class="badge-unread" style="display:none">0</span></button>
</div>
<div id="dmPanel" class="dm-panel">
  <div class="dm-head">
    <strong><i class="fa fa-comments"></i> Conversas</strong>
    <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
      <input id="dmSearch" placeholder="Buscar usuário..." style="width:180px">
      <button id="dmClose" class="btn-ghost btn-icon" title="Fechar"><i class="fa fa-xmark"></i></button>
    </div>
  </div>
  <div class="dm-body">
    <div id="dmUsers" class="dm-users"></div>
    <div class="dm-chat">
      <div id="dmHeader" class="small muted" style="padding:8px 10px;border-bottom:1px solid var(--border)">Selecione um usuário para conversar</div>
      <div id="dmHistory" class="dm-history"></div>
      <div class="dm-input">
        <input id="dmText" placeholder="Mensagem (Enter para enviar)" disabled>
        <button id="dmSend" class="btn-ghost btn-icon" disabled><i class="fa fa-paper-plane"></i></button>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
/* ===== Layout ===== */
function setHeadH(){
  const h=document.querySelector('header');
  const v=h? h.getBoundingClientRect().height : 96;
  document.documentElement.style.setProperty('--headH', Math.round(v)+'px')
}
window.addEventListener('load', setHeadH); 
window.addEventListener('resize', setHeadH);


/* ===== Enterprise State (tabs/chips/view) ===== */
var VIEW_KEY='ticket_view_mode';
var TAB_KEY='ticket_active_tab';
var activeTab = (localStorage.getItem(TAB_KEY) || 'Aberto');
var activeView = (localStorage.getItem(VIEW_KEY) || 'operacao');

// Estado rápido dos chips (fonte da verdade p/ filtros rápidos)
var quickFilters = { sla:'', categoria:'', canal:'', mine:false };


function applyView(v){
  activeView = v || 'operacao';
  document.body.setAttribute('data-view', activeView);
  try{ localStorage.setItem(VIEW_KEY, activeView); }catch(e){}
  // botões
  qsa('.view-btn').forEach(b=>b.classList.toggle('active', b.dataset.view===activeView));
  // colunas: aplica também no tbody (tds herdam classe via render)
  if(!window.__booting) render();
}
function applyTab(tab){
  activeTab = tab || 'Aberto';
  try{ localStorage.setItem(TAB_KEY, activeTab); }catch(e){}
  qsa('#statusTabs .tab-btn').forEach(b=>b.classList.toggle('active', b.dataset.tab===activeTab));
  // sincroniza filtro avançado
  var st = (activeTab==='Tudo') ? '' : (activeTab==='Pendente' ? 'Pendente' : (activeTab==='Encerrado' ? 'Encerrado' : (activeTab==='Em tratativa' ? 'Em tratativa' : 'Aberto')));
  var sel = document.getElementById('fStatus');
  if(sel) sel.value = st;
  currentPage = 1;
  if(!window.__booting) render();
}
function setChip(chip, value, on){
  // chip: sla/categoria/canal/mine

  // mantém estado em memória (chips são a verdade)
  if(chip==='mine'){ quickFilters.mine = !!on; }
  if(chip==='sla'){ quickFilters.sla = on ? value : ''; }
  if(chip==='categoria'){ quickFilters.categoria = on ? value : ''; }
  if(chip==='canal'){ quickFilters.canal = on ? value : ''; }

  if(chip==='mine'){
    var c = document.getElementById('fMine'); if(c) c.checked = !!on;
  }else if(chip==='sla'){
    var s = document.getElementById('fSLA'); if(s) s.value = on ? value : '';
  }else if(chip==='categoria'){
    var s2 = document.getElementById('fCategoria'); if(s2) s2.value = on ? value : '';
  }else if(chip==='canal'){
    var s3 = document.getElementById('fCanal'); if(s3) s3.value = on ? value : '';
  }
  currentPage=1;
  render();
  // UI
  qsa('#quickChips .chip').forEach(btn=>{
    if(btn.id==='chipReset') return;
    var same = btn.dataset.chip===chip && btn.dataset.value===value;
    if(same) btn.classList.toggle('active', !!on);
    // chips de mesmo grupo se excluem (sla/categoria/canal)
    var groupExclusive = ['sla','categoria','canal'].includes(chip);
    if(groupExclusive && btn.dataset.chip===chip && btn.dataset.value!==value && !!on){
      btn.classList.remove('active');
    }
    if(chip==='mine' && btn.dataset.chip==='mine'){
      btn.classList.toggle('active', !!(document.getElementById('fMine') && document.getElementById('fMine').checked));
    }
  });
}

function onChipClick(e, el){
  try{
    if(e){ e.preventDefault(); e.stopPropagation(); }
    var chip=el.dataset.chip, val=el.dataset.value;
    if(el.id==='chipReset'){ resetRapido(); return; }
    if(chip==='mine'){
      var c=document.getElementById('fMine');
      var on = !(c && c.checked);
      setChip('mine','1',on);
    }else{
      var isActive = el.classList.contains('active');
      setChip(chip,val,!isActive);
    }
  }catch(err){ console.error('chip click error', err); }
}

function debounce(fn, ms){
  var t;
  return function(){
    var args = arguments;
    clearTimeout(t);
    t = setTimeout(function(){ fn.apply(null, args); }, ms);
  };
}

var __searchDebounced = debounce(function(){
  saveFilters();
  currentPage=1;
  render();
},200);
function onSearchInput(e){
  __searchDebounced();
}

function resetRapido(){
  // limpa busca e filtros
  var s=document.getElementById('fSearch'); if(s) s.value='';
  ['fPrio','fCategoria','fCanal','fSLA','fPend','fResp'].forEach(id=>{var el=document.getElementById(id); if(el) el.value='';});
  var mine=document.getElementById('fMine'); if(mine) mine.checked=false;
  quickFilters = { sla:'', categoria:'', canal:'', mine:false };
  // limpa chips
  qsa('#quickChips .chip').forEach(b=>b.classList.remove('active'));
  // volta padrão
  applyView('operacao');
  applyTab('Aberto');
  // ordenação padrão
  sortField='default'; sortDir='asc';
  currentPage=1;
  render();
}
function wireEnterpriseUI(){
  // Tabs
  var tabs = document.getElementById('statusTabs');
  if(tabs){
    tabs.addEventListener('click', function(e){
      var b = e.target.closest('.tab-btn'); if(!b) return;
      applyTab(b.dataset.tab);
    });
  }
  // View buttons
  document.addEventListener('click', function(e){
    var vb = e.target.closest('.view-btn'); 
    if(vb){ applyView(vb.dataset.view); }
  });
  // Chips (handled by inline onclick)
  // KPIs
  var strip=document.getElementById('kpiStrip');
  if(strip){
    strip.addEventListener('click', function(e){
      var k = e.target.closest('.kpi-mini'); if(!k) return;
      var type=k.dataset.kpi;
      resetRapido();
      if(type==='late'){ applyTab('Tudo'); setChip('sla','late',true); }
      if(type==='risk'){ applyTab('Tudo'); setChip('sla','risk',true); }
      if(type==='unassigned'){ applyTab('Tudo'); window.__filterUnassigned=true; render(); }
      if(type==='pendDue'){ applyTab('Pendente'); document.getElementById('fPend').value='due'; render(); }
    });
  }
  // Drawer
  var btnAdv=document.getElementById('btnAdvanced');
  var drawer=document.getElementById('advDrawer');
  var close=document.getElementById('advClose');
  if(btnAdv && drawer){
    btnAdv.onclick=function(){ drawer.classList.add('show'); };
  }
  if(close && drawer){
    close.onclick=function(){ drawer.classList.remove('show'); };
  }
  if(drawer){
    drawer.addEventListener('click', function(e){
      if(e.target===drawer) drawer.classList.remove('show');
    });
  }
  var advApply=document.getElementById('advApply');
  var advClear=document.getElementById('advClear');
  var advMine=document.getElementById('advMine');
  if(advApply){ advApply.onclick=function(){ drawer.classList.remove('show'); currentPage=1; render(); }; }
  if(advClear){ advClear.onclick=function(){ ['fSearch','fStatus','fPrio','fCategoria','fSLA','fPend','fResp'].forEach(function(id){ var el=document.getElementById(id); if(el){ if(el.type==='checkbox') el.checked=false; else el.value=''; } }); window.__filterUnassigned=false; currentPage=1; render(); }; }
  if(advMine){ advMine.onclick=function(){ var c=document.getElementById('fMine'); if(c) c.checked=!c.checked; render(); }; }

  // iniciar estado salvo
  applyView(activeView);
  applyTab(activeTab);

  // fecha menus ao clicar fora
  document.addEventListener('click', function(e){
    if(!e.target.closest('.actions-wrap')) hideAllMoreMenus();
  });
}
/* ===== Helpers ===== */
const qs=s=>document.querySelector(s);
const qsa=(s,el)=>Array.prototype.slice.call((el||document).querySelectorAll(s));
const fmtDate=ts=>new Date(ts).toLocaleString('pt-BR');
const uid = ()=>Math.random().toString(36).slice(2,8).toUpperCase();
function escapeHtml(str){
  str=(str||'');
  return str.replace(/[&<>\"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]))
}
function toast(msg){
  var c=document.getElementById('toast');
  if(!c){
    c=document.createElement('div');
    c.id='toast';
    document.body.appendChild(c);
  }
  var el=document.createElement('div');
  el.className='t';
  el.textContent=msg;
  c.appendChild(el);
  requestAnimationFrame(()=>el.classList.add('show'));
  setTimeout(()=>{
    el.classList.remove('show');
    setTimeout(()=>el.remove(),250);
  },3000);
}

function canUseNativeNotif(){
  return typeof window!=='undefined' && 'Notification' in window;
}
function askNotifyPermission(){
  try{
    if(!canUseNativeNotif()) return;
    if(Notification.permission==='default'){
      Notification.requestPermission().catch(()=>{});
    }
  }catch(e){}
}
function showNativeNotification(title,opts){
  try{
    if(!canUseNativeNotif()) return;
    if(Notification.permission==='granted'){
      var n=new Notification(title||'',opts||{});
      n.onclick=function(){
        try{ window.focus(); }catch(e){}
        this.close();
      };
    }else if(Notification.permission==='default'){
      Notification.requestPermission().then(function(p){
        if(p==='granted') showNativeNotification(title,opts);
      }).catch(()=>{});
    }
  }catch(e){}
}

function prioToDays(p){return p==='Alta'?1: p==='Média'?3:5}

/* dias úteis */
function addBusinessDays(base, days){
  var d=new Date(base); d.setHours(0,0,0,0);
  var added=0;
  while(added<days){
    d.setDate(d.getDate()+1);
    var wd=d.getDay(); // 0=domingo,6=sábado
    if(wd!==0 && wd!==6) added++;
  }
  return d;
}

function ensureSLA(prazo,prioridade,abertoEm){
  if(prazo) return prazo;
  var base=new Date(abertoEm||Date.now());
  var dias=prioToDays(prioridade||'Média');
  var dt=addBusinessDays(base,dias);
  return dt.toISOString().slice(0,10);
}

function ensureSLAForForm(prazo,prioridade,abertoEm){
  var base=new Date(abertoEm||Date.now());
  var dias=prioToDays(prioridade||'Média');
  var minDate=addBusinessDays(base,dias).toISOString().slice(0,10);
  if(!prazo) return minDate;
  if(prazo<minDate){
    alert('Para prioridade "'+(prioridade||'Média')+'", o prazo mínimo é '+minDate+'. Ajuste o SLA antes de salvar.');
    throw new Error('SLA abaixo do mínimo');
  }
  return prazo;
}

function slaStatus(dateStr,d){
  if(!dateStr)return{code:'',label:'—'};
  var due=new Date(dateStr+'T23:59:59');

  // Se estiver encerrado, trava o SLA na data de encerramento
  if(d && d.status==='Encerrado'){
    var closedAt=getClosedAt(d)||d.closedAt||d.abertoEm||new Date();
    // positivo => fechou depois do prazo (vencido)
    var diffH=(new Date(closedAt)-due)/36e5;
    if(diffH>0)return{code:'late',label:'Vencido'};
    return{code:'ok',label:'No prazo'};
  }

  // Em aberto: usa hoje como referência (contador correndo)
  var today=new Date();today.setHours(23,59,59,999);
  var diffH=(due-today)/36e5;
  if(diffH<0)return{code:'late',label:'Vencido'};
  if(diffH<=12)return{code:'risk',label:'Risco'};
  return{code:'ok',label:'No prazo'};
}

/* tooltip SLA */
function slaTooltip(dateStr,d){
  if(!dateStr) return '';
  var due = new Date(dateStr+'T23:59:59');
  var dataPrazo = new Date(dateStr).toLocaleDateString('pt-BR');

  // Encerrado: não continua contando, trava no momento do fechamento
  if(d && d.status==='Encerrado'){
    var closedAt = getClosedAt(d) || d.closedAt || d.abertoEm || new Date();
    var closedDt = new Date(closedAt);
    var diffH = Math.round((closedDt - due)/36e5); // >0 = fechou depois do prazo
    var dataFech = closedDt.toLocaleDateString('pt-BR');

    if(diffH<=0){
      return 'Encerrado em '+dataFech+' — dentro do prazo (SLA '+dataPrazo+')';
    }else{
      return 'Encerrado em '+dataFech+' — '+diffH+'h após o vencimento (SLA '+dataPrazo+')';
    }
  }

  // Em aberto: contador correndo
  var now = new Date();
  var diffMs = due - now;
  var diffH = Math.round(diffMs/36e5);

  if(diffH>=0){
    return 'Vence em '+dataPrazo+' — faltam '+diffH+'h';
  }else{
    return 'Venceu em '+dataPrazo+' — há '+Math.abs(diffH)+'h';
  }
}

function statusBadge(s){
  var map={'Aberto':'status-aberto','Em tratativa':'status-tratativa','Pendente':'status-pendente','Encerrado':'status-encerrado'};
  return '<span class="badge '+(map[s]||'')+'"><i class="fa fa-circle"></i>'+s+'</span>'
}
function prioBadge(p){return '<span class="badge prio-lite '+(p==='Alta'?'prio-alta':p==='Média'?'prio-media':'prio-baixa')+'">'+p+'</span>'}
const ym=d=>d.toISOString().slice(0,7);
const startOfDay=dt=>{var d=new Date(dt);d.setHours(0,0,0,0);return d}
const today0=()=>{var d=new Date();d.setHours(0,0,0,0);return d}
var DEFAULT_EMAIL_DOMAIN="koerich.com.br";

/* sort + paginação estado */
var sortField='default';
var sortDir='asc';
var pageSize=50;
var currentPage=1;
var statusTab='Abertos';

/* filtros salvos / tema */
const FILTER_KEY_BASE='ticket_filters_';
const THEME_KEY='ticket_theme';

/* ===== Config + Supabase ===== */
var SUPA_URL=(window.ENV&&window.ENV.SUPABASE_URL)||'';
var SUPA_KEY=(window.ENV&&window.ENV.SUPABASE_ANON_KEY)||'';
var supa=(SUPA_URL&&SUPA_KEY)?supabase.createClient(SUPA_URL,SUPA_KEY):null;
const supaReady=()=>!!supa;

/* ===== Flag de coluna CANAL ===== */
var HAS_CANAL=false;

/* ===== Sessão ===== */
const SESSION_KEY='ticket_session_v1';
const setSession=u=>localStorage.setItem(SESSION_KEY,JSON.stringify(u));
const currentUser=()=>{try{return JSON.parse(localStorage.getItem(SESSION_KEY)||'')}catch(e){return null}}
const clearSession=()=>localStorage.removeItem(SESSION_KEY);


const NOTIF_PREFIX='ticket_notif_';
let notifications=[];
const notifKey=()=>{
  var me=currentUser()||{};
  return NOTIF_PREFIX+(me.id||'anon');
};
function loadNotifications(){
  try{
    notifications=JSON.parse(localStorage.getItem(notifKey())||'[]');
  }catch(e){
    notifications=[];
  }
}
function saveNotifications(){
  try{
    localStorage.setItem(notifKey(),JSON.stringify(notifications||[]));
  }catch(e){}
}
function renderNotificationsIcon(){
  var el=document.getElementById('notifCount');
  if(!el) return;
  var unread=(notifications||[]).filter(n=>!n.read).length;
  if(unread>0){
    el.textContent=unread>9?'9+':String(unread);
    el.classList.remove('hidden');
  }else{
    el.classList.add('hidden');
  }
}
// === Regras de quem deve ser avisado ===
function isUserRelatedToTicketFront(d){
  if (!d) return false;
  var me = currentUser() || {};
  var meName = me.name || '';

  // abriu o ticket
  if (d.openedBy && d.openedBy === me.id) return true;

  // é solicitante
  if ((d.solicitante || '') === meName) return true;

  // é responsável
  if ((d.responsavel || '') === meName) return true;

  return false;
}

// dispara toast + sino + notificação nativa
function notifyTicketEventFront(d, msg, type){
  if (!d) return;
  // só notifica se esse usuário tem relação com o ticket
  if (!isUserRelatedToTicketFront(d)) return;

  addNotification(d, msg, type || 'info');
  toast(msg);

  // se a aba não está visível, manda Notification do navegador
  if (document.visibilityState !== 'visible'){
    showNativeNotification('Ticket ' + d.id, {
      body: msg,
      tag: 'ticket-' + d.id
    });
  }
}
function markNotificationRead(id){
  var idx=(notifications||[]).findIndex(n=>n.id===id);
  if(idx>-1){
    notifications[idx].read=true;
    saveNotifications();
    renderNotificationsIcon();
  }
}
function addNotification(ticket,message,type){
  if(!ticket || !ticket.id) return;
  notifications=notifications||[];
  var n={
    id:uid(),
    ticketId:ticket.id,
    message:message||'Atualização na solicitação',
    type:type||'info',
    ts:Date.now(),
    read:false
  };
  notifications.unshift(n);
  if(notifications.length>50) notifications=notifications.slice(0,50);
  saveNotifications();
  renderNotificationsIcon();
}
function renderNotificationsList(){
  var panel=document.getElementById('notifPanel');
  var list=document.getElementById('notifList');
  if(!panel || !list) return;
  if(!notifications || notifications.length===0){
    list.innerHTML='<div class="notif-empty">Sem notificações.</div>';
  }else{
    list.innerHTML=(notifications||[]).map(function(n){
      var dt=new Date(n.ts).toLocaleString('pt-BR');
      return '<div class="notif-item'+(n.read?' notif-read':'')+'" data-id="'+n.id+'" data-ticket="'+n.ticketId+'">\
        <div class="notif-msg">'+escapeHtml(n.message||'')+'</div>\
        <div class="notif-meta">'+dt+'</div>\
      </div>';
    }).join('');
  }
  var items=document.querySelectorAll('#notifList .notif-item');
  items.forEach(function(el){
    el.onclick=function(){
      var id=el.getAttribute('data-id');
      var tk=el.getAttribute('data-ticket');
      markNotificationRead(id);
      if(tk && window.openEdit){
        window.openEdit(tk);
      }
      hideNotifPanel();
    };
  });
}
function showNotifPanel(){
  var panel=document.getElementById('notifPanel');
  if(!panel) return;
  renderNotificationsList();
  panel.classList.remove('hidden');
}
function hideNotifPanel(){
  var panel=document.getElementById('notifPanel');
  if(!panel) return;
  panel.classList.add('hidden');
}
function toggleNotifPanel(){
  var panel=document.getElementById('notifPanel');
  if(!panel) return;
  if(panel.classList.contains('hidden')) showNotifPanel();
  else hideNotifPanel();
}


/* ===== Estado ===== */
var data=[]; var lastReadMap={};
var __filterUnassigned=false;
var __booting=true;
var chartAbertos=null, chartConcluidos=null, chartTransp=null, chartCanal=null;

/* ===== Perfis e DM ===== */
const ENABLE_DM = false; // DM desativado

var profiles=[];  // {id, display_name, role, username}
var dmCache=[];   // [{id,sender,receiver,body,created_at}]
var dmTarget=null;
var dmUnread=0;
function dmKey(me,other){return 'dm_lastread_'+me+'_'+other}
var dmSeen=new Set();
function markSeen(sig){dmSeen.add(sig);setTimeout(()=>dmSeen.delete(sig),5000)}

/* ========= Filtros armazenados ========= */
function saveFilters(){
  var u=currentUser(); if(!u) return;
  var obj={
    search: qs('#fSearch').value || '',
    status: qs('#fStatus').value || '',
    prio: qs('#fPrio').value || '',
    categoria: qs('#fCategoria').value || '',
    sla: qs('#fSLA').value || '',
    pend: qs('#fPend').value || '',
    mine: !!qs('#fMine').checked,
    hideClosed: !!qs('#fHideClosed').checked
  };
  localStorage.setItem(FILTER_KEY_BASE+u.id, JSON.stringify(obj));
}
function loadFilters(){
  var u=currentUser(); if(!u) return;
  var raw=localStorage.getItem(FILTER_KEY_BASE+u.id); if(!raw) return;
  try{
    var f=JSON.parse(raw);
    if('search' in f) qs('#fSearch').value = f.search;
    if('status' in f) qs('#fStatus').value = f.status;
    if('prio' in f) qs('#fPrio').value = f.prio;
    if('categoria' in f) qs('#fCategoria').value = f.categoria;
    if('sla' in f) qs('#fSLA').value = f.sla;
    if('pend' in f) qs('#fPend').value = f.pend;
    if('mine' in f){
      qs('#fMine').checked = f.mine;
      qs('#tgMine').classList.toggle('active', f.mine);
    }
    if('hideClosed' in f){
      qs('#fHideClosed').checked = f.hideClosed;
      qs('#tgHideClosed').classList.toggle('active', f.hideClosed);
    }
  }catch(e){}

  // sincroniza tabs/visão com filtros salvos (sem reescrever filtros)
  try{
    var st = qs('#fStatus').value || '';
    if(st==='Aberto' || st==='Em tratativa' || st==='Pendente'){
      statusTab = st;
    }else if(st==='Encerrado'){
      statusTab = 'Encerrado';
    }else{
      statusTab = 'Tudo';
    }
    qsa('#statusTabs .tab-btn').forEach(b=>b.classList.toggle('active', b.dataset.tab===statusTab));
    qsa('.view-btn').forEach(b=>b.classList.toggle('active', b.dataset.view===activeView));
  }catch(e){}
}

/* ========= Tema (claro/escuro) ========= */
function applyTheme(theme){
  var body=document.body;
  var icon=qs('#themeIcon');
  if(theme==='light'){
    body.classList.add('theme-light');
    if(icon){icon.classList.remove('fa-moon');icon.classList.add('fa-sun')}
  }else{
    body.classList.remove('theme-light');
    if(icon){icon.classList.remove('fa-sun');icon.classList.add('fa-moon')}
  }
  localStorage.setItem(THEME_KEY, theme);
}
function initTheme(){
  var saved = localStorage.getItem(THEME_KEY) || 'dark';
  applyTheme(saved);
}

/* ========= TICKETS: load ========= */
async function loadFromSupabase(){
  if(!supaReady()){toast('Config Supabase ausente.'); data=[]; render(); return;}

  // tenta com a coluna 'canal'
  var sel='id,aberto_em,solicitante,categoria,assunto,prioridade,descricao,status,responsavel,prazo,codigo,transportadora,canal,pendente,retomar_em,opened_by,closed_at';
  var resp=await supa.from('tickets').select(sel);
  var tks=resp.data; var error=resp.error;
  if(!error){ HAS_CANAL=true; }
  if(error){
    // fallback sem 'canal'
    HAS_CANAL=false;
    sel='id,aberto_em,solicitante,categoria,assunto,prioridade,descricao,status,responsavel,prazo,codigo,transportadora,pendente,retomar_em,opened_by,closed_at';
    resp=await supa.from('tickets').select(sel);
    tks=resp.data; error=resp.error;
  }
  if(error){
    // fallback mínimo
    sel='id,aberto_em,solicitante,categoria,assunto,prioridade,descricao,status,responsavel,prazo,codigo,closed_at';
    resp=await supa.from('tickets').select(sel); tks=resp.data; error=resp.error;
  }
  if(error){
    console.error('load tickets error:', error);
    toast('Não consegui listar tickets (SELECT). Provável RLS/policy no Supabase: ' + (error.message||''));
    // IMPORTANTE: não sobrescreve o que já está em tela se o SELECT falhar
    return;
  }

  tks.sort((a,b)=>new Date(b.aberto_em)-new Date(a.aberto_em));

  // mensagens do ticket
  // (otimização V2.4) não carregamos histórico na lista; o chat é carregado só ao abrir o ticket.

  // last_reads
  lastReadMap={};
  var me=currentUser(); if(me){var lr=await supa.from('last_reads').select('ticket_id,last_read_at').eq('user_id',me.id); (lr.data||[]).forEach(r=>lastReadMap[r.ticket_id]=new Date(r.last_read_at).getTime())}

  data=tks.map(t=>({
    id:String(t.id), abertoEm:new Date(t.aberto_em).getTime(), solicitante:t.solicitante, categoria:t.categoria, assunto:t.assunto,
    prioridade:t.prioridade, descricao:t.descricao||'', status:t.status, responsavel:t.responsavel||'', prazo:t.prazo?new Date(t.prazo).toISOString().slice(0,10):'',
    codigo:t.codigo||'', transportadora:t.transportadora||'', canal: (t.canal||''), pendente:!!t.pendente, retomar_em:t.retomar_em?new Date(t.retomar_em).toISOString().slice(0,10):'',
    openedBy:t.opened_by||null, closedAt:t.closed_at?new Date(t.closed_at).getTime():null, historico:[]
  }));
}

/* ========= TICKETS: persist ========= */
async function supaUpsertTicket(rec){
  if(!supaReady())return;
  var me=currentUser();
  var payload={
    id:String(rec.id), 
    aberto_em:new Date(rec.abertoEm).toISOString(), 
    solicitante:rec.solicitante, 
    categoria:rec.categoria,
    assunto:rec.assunto, 
    prioridade:rec.prioridade, 
    descricao:rec.descricao||null, 
    status:rec.status, 
    responsavel:rec.responsavel||null,
    prazo:rec.prazo||null, 
    codigo:rec.codigo||null, 
    transportadora:rec.transportadora||null, 
    pendente:!!rec.pendente, 
    retomar_em:rec.retomar_em||null,
    opened_by: rec.openedBy || null, 
    closed_at:rec.closedAt?new Date(rec.closedAt).toISOString():null
  };
  if (HAS_CANAL) payload.canal = rec.canal || null; // só envia se a coluna existir
  var r=await supa.from('tickets').upsert(payload); 
  if(r.error){console.error(r.error); toast('Sem permissão para salvar (RLS/policies?)')}
}
async function supaDeleteTicket(id){ if(!supaReady())return; var r=await supa.from('tickets').delete().eq('id',id); if(r.error){console.error(r.error); toast('Sem permissão para excluir')}}
async function supaAddMessage(ticketId, text){
  if (!supaReady()) return;

  const { data: auth } = await supa.auth.getUser();
  const userId   = auth?.user?.id || null;
  const userName = (currentUser()?.name || '—');

  const { data: ins, error } = await supa
    .from('messages')
    .insert({
      ticket_id: String(ticketId),
      body: text,
      sender: userId,
      sender_name: userName
    })
    .select()
    .single();

  if (error) {
    console.error('insert message error:', error);
    return;
  }

  await loadTicketChat(ticketId);
}
async function supaMarkRead(ticketId){ ticketId = String(ticketId); if(!supaReady())return; var u=currentUser(); if(!u)return; var nowIso=new Date().toISOString(); await supa.from('last_reads').upsert({ticket_id:(String)(ticketId),user_id:u.id,last_read_at:nowIso}); lastReadMap[ticketId]=new Date(nowIso).getTime()}
/* ========= Realtime + fallback ========= */
var __rtOK={messages:false,tickets:false,dm:(!ENABLE_DM)}; 
var __pollId=null;

async function refreshNow(){
  await loadFromSupabase();
  render();
}

function setPollTimer(){
  if(__pollId) clearInterval(__pollId);
  var ms=(document.visibilityState==='visible')?800:8000;
  __pollId=setInterval(()=>{
    // polling só como fallback se realtime falhar
    if(!__rtOK.messages || !__rtOK.tickets){
      refreshNow();
    }
    if(ENABLE_DM && !__rtOK.dm){
      loadDM(true);
    }
  }, ms);
}

function setupRealtime(){
  if(!supaReady()) return;

  // limpa canais antigos antes de reabrir
  try{
    supa.getChannels().forEach(ch=>supa.removeChannel(ch));
  }catch(e){}

  /* === REALTIME: MENSAGENS DO TICKET === */
  supa.channel('realtime-messages')
    .on(
      'postgres_changes',
      {event:'INSERT',schema:'public',table:'messages'},
      payload=>{
        var m   = payload.new;
        var tid = String(m.ticket_id);

        // ticket na estrutura do front
        var d = data.find(x => String(x.id) === tid);

        // se ainda não temos o ticket em memória, faz refresh e sai
        if(!d){
          refreshNow();
          return;
        }

        // atualiza histórico local
        d.historico = d.historico || [];
        d.historico.push({
          at:  new Date(m.created_at).getTime(),
          txt: m.body,
          user: m.sender_name || '—'
        });

        render();

        var me     = currentUser() || {};
        var meName = me.name || '';

        // não avisa quem enviou
        if (meName === (m.sender_name || '')) return;

        // dispara sino + native notification só pra quem é relacionado ao ticket
        notifyTicketEventFront(
          d,
          'Nova mensagem no ticket ' + tid,
          'message'
        );
      }
    )
    .subscribe(status=>__rtOK.messages=(status==='SUBSCRIBED'));

  /* === REALTIME: TICKETS (criação e update) === */
  supa.channel('realtime-tickets')
    .on(
      'postgres_changes',
      {event:'INSERT',schema:'public',table:'tickets'},
      payload=>{
        var tNew = payload.new;
        var id   = String(tNew.id);

        refreshNow();

        // tenta achar o ticket no array atual
        var d = data.find(x => String(x.id) === id);
        if (!d) {
          d = {
            id: id,
            solicitante: tNew.solicitante || '',
            responsavel: tNew.responsavel || '',
            openedBy: tNew.opened_by || null
          };
        }

        notifyTicketEventFront(
          d,
          'Nova solicitação criada (ticket ' + id + ')',
          'ticket_new'
        );
      }
    )
    .on(
      'postgres_changes',
      {event:'UPDATE',schema:'public',table:'tickets'},
      payload=>{
        var tNew = payload.new;
        var id   = String(tNew.id);

        // pega estado ANTES de atualizar
        var prev = data.find(x => String(x.id) === id);

        refreshNow();

        var msg = null;

        if (prev) {
          if (prev.status !== tNew.status) {
            msg = 'Ticket ' + id + ' mudou de "' + prev.status + '" para "' + tNew.status + '"';
          } else if ((prev.responsavel || '') !== (tNew.responsavel || '')) {
            msg = 'Ticket ' + id + ' teve o responsável alterado para "' + (tNew.responsavel || '-') + '"';
          } else {
            msg = 'Ticket ' + id + ' foi atualizado';
          }
        } else {
          msg = 'Ticket ' + id + ' foi atualizado';
        }

        var d = prev || {
          id: id,
          solicitante: tNew.solicitante || '',
          responsavel: tNew.responsavel || '',
          openedBy: tNew.opened_by || null
        };

        notifyTicketEventFront(
          d,
          msg,
          'ticket_update'
        );
      }
    )
    .subscribe(status=>__rtOK.tickets=(status==='SUBSCRIBED'));

  /* === REALTIME: DM ENTRE USUÁRIOS === */
  if(ENABLE_DM){
    supa.channel('realtime-dm')
      .on(
        'postgres_changes',
        {event:'INSERT',schema:'public',table:'dm_messages'},
        p=>onDmInsert(p.new)
      )
      .subscribe(status=>__rtOK.dm=(status==='SUBSCRIBED'));
  }setPollTimer();
}

document.addEventListener('visibilitychange', setPollTimer);
window.addEventListener('focus', ()=>{refreshNow(); loadDM(true)});
window.addEventListener('online', ()=>{ setupRealtime(); refreshNow(); loadDM(true) });
/* ========= Render Lista ========= */
const prioRank=p=>p==='Alta'?0: p==='Média'?1:2;
function getUnreadCount(d){
  var last=lastReadMap[d.id]||0;
  var me=(currentUser()||{}).name||'';
  return (d.historico||[]).filter(h=>h.at>last && h.user!==me).length
}

/* ordenação configurável */
function sortRows(rows){
  function scorePend(x){
    var isP=(x.status==='Pendente'), r=x.retomar_em? startOfDay(x.retomar_em):null, t=today0();
    var venc = (isP && r && r < t)? 2 : 0;
    var hoje = (isP && r && r.getTime()===t.getTime())? 1 : 0;
    return (venc*100)+(hoje*10);
  }

  if(sortField==='default'){
    return rows.sort((a,b)=>{
      var s=scorePend(b)-scorePend(a); if(s) return s;
      return prioRank(a.prioridade)-prioRank(b.prioridade) || b.abertoEm-a.abertoEm;
    });
  }

  const dirMult = (sortDir==='asc'?1:-1);

  return rows.sort((a,b)=>{
    let va=a[sortField], vb=b[sortField];

    // campos especiais
    if(sortField==='prioridade'){
      return (prioRank(va)-prioRank(vb))*dirMult;
    }
    if(sortField==='abertoEm'){
      return (va-vb)*dirMult;
    }
    if(sortField==='prazo'){
      var da = va? new Date(va).getTime():0;
      var db = vb? new Date(vb).getTime():0;
      return (da-db)*dirMult;
    }

    // string genérica
    va = (va||'').toString().toLowerCase();
    vb = (vb||'').toString().toLowerCase();
    if(va<vb) return -1*dirMult;
    if(va>vb) return  1*dirMult;
    return 0;
  });
}

function updateKPIs(){
  var late=0, risk=0, unassigned=0, pendDue=0;
  var today = new Date(); today.setHours(0,0,0,0);
  data.forEach(function(d){
    var st = d.status||'';
    if(st==='Encerrado') return;
    var slaObj = slaStatus(d.prazo,d);
    if(slaObj.code==='late') late++;
    else if(slaObj.code==='risk') risk++;
    if((d.responsavel||'').trim()==='') unassigned++;
    if(st==='Pendente'){
      var r = d.retomarEm ? new Date(d.retomarEm) : null;
      if(r && r.getTime() < today.getTime()) pendDue++;
    }
  });
  var el;
  el=document.getElementById('kpiLate'); if(el) el.textContent=late;
  el=document.getElementById('kpiRisk'); if(el) el.textContent=risk;
  el=document.getElementById('kpiUnassigned'); if(el) el.textContent=unassigned;
  el=document.getElementById('kpiPendDue'); if(el) el.textContent=pendDue;
}

function syncQuickUI(){
  // lê filtros atuais (avançados)
  var sla=(qs('#fSLA')&&qs('#fSLA').value)||'';
  var cat=(qs('#fCategoria')&&qs('#fCategoria').value)||'';
  var canalF=(qs('#fCanal')&&qs('#fCanal').value)||'';
  var mine=!!(qs('#fMine')&&qs('#fMine').checked);

  // aplica overrides dos chips (chips = fonte da verdade)
  if(typeof quickFilters!=='undefined' && quickFilters){
    if(quickFilters.sla) sla = quickFilters.sla;
    if(quickFilters.categoria) cat = quickFilters.categoria;
    if(quickFilters.canal) canalF = quickFilters.canal;
    if(quickFilters.mine) mine = true;
  }

  // reflete na UI
  qsa('#quickChips .chip').forEach(function(b){
    if(b.id==='chipReset') return;
    var ch=b.dataset.chip, v=b.dataset.value;
    var on=false;
    if(ch==='mine') on=mine;
    if(ch==='sla') on=(sla && sla===v);
    if(ch==='categoria') on=(cat && cat===v);
    if(ch==='canal') on=(canalF && canalF===v);
    b.classList.toggle('active', !!on);
  });
}

function updateSortIcons(){
  qsa('th.sortable').forEach(th=>{
    var f=th.dataset.field;
    var icon=th.querySelector('.sort-icon');
    if(!icon) return;
    if(f===sortField){
      icon.textContent = (sortDir==='asc'?'▲':'▼');
    }else{
      icon.textContent = '';
    }
  });
}

function render(){
  // aplica modo de visualização
  var tblEl=qs('#tbl');
  if(tblEl){tblEl.classList.remove('mode-operacao','mode-detalhado','mode-gestao'); tblEl.classList.add('mode-'+(activeView||'operacao'));}
  var term=(qs('#fSearch')&&qs('#fSearch').value||'').toLowerCase().trim();
  var st=(qs('#fStatus')&&qs('#fStatus').value)||'';
  var pr=(qs('#fPrio')&&qs('#fPrio').value)||'';
  var cat=(qs('#fCategoria')&&qs('#fCategoria').value)||'';
  var canalF=(qs('#fCanal')&&qs('#fCanal').value)||'';
  var respF=(qs('#fResp')&&qs('#fResp').value)||'';
  var sla=(qs('#fSLA')&&qs('#fSLA').value)||'';
  var pend=(qs('#fPend')&&qs('#fPend').value)||'';
  var mine=!!(qs('#fMine')&&qs('#fMine').checked);
  var hideClosed=false;

  // overrides dos chips (fonte da verdade)
  if(typeof quickFilters!=='undefined' && quickFilters){
    if(quickFilters.sla) sla = quickFilters.sla;
    if(quickFilters.categoria) cat = quickFilters.categoria;
    if(quickFilters.canal) canalF = quickFilters.canal;
    if(quickFilters.mine) mine = true;
  }

  var rows=data.filter(d=>{
    var sLA=slaStatus(d.prazo).code;
    var searchable=[d.solicitante,d.assunto,d.descricao,d.codigo,d.transportadora,d.canal].join(' ').toLowerCase();

    var isPend=(d.status!=='Encerrado');
    var retoma=d.retomar_em? startOfDay(d.retomar_em) : null;
    var isPendDue=isPend && retoma && retoma < today0();

    // Busca: se digitou, filtra pelo termo (e ainda aplica chips/tabs/avançados)
    if(term){
      if(searchable.indexOf(term)===-1) return false;
    }
// Sem termo de busca: aplica filtros normalmente
    if(hideClosed && d.status==='Encerrado') return false;

    if(st && d.status!==st) return false;
    if(pr && d.prioridade!==pr) return false;
    if(cat && d.categoria!==cat) return false;
    if(canalF && (d.canal||'')!==canalF) return false;
    if(respF && (d.responsavel||'')!==respF) return false;
    if(sla && sLA!==sla) return false;
    if(window.__filterUnassigned){
      var st2=d.status||'';
      if(st2==='Encerrado') return false;
      if((d.responsavel||'').trim()!=='') return false;
    }
    if(pend==='pend' && !isPend) return false;
    if(pend==='due' && !isPendDue) return false;

    if(mine){
      var me = currentUser()||{};
      var byOwner = d.openedBy && d.openedBy===me.id;
      var bySolic = (d.solicitante||'')===(me.name||'');
      var byResp  = (d.responsavel||'')===(me.name||'');
      if(!byOwner && !bySolic && !byResp) return false;
    }
    return true;
  });

  rows = sortRows(rows);

  var tbody=qs('#tbody');
  if(!rows.length){
    tbody.innerHTML='<tr><td colspan="11" class="muted">Nenhum registro encontrado</td></tr>';
    qs('#pager').innerHTML='';
    updateSortIcons();
    return;
  }

  /* paginação */
  var total = rows.length;
  var totalPages = Math.max(1, Math.ceil(total/pageSize));
  if(currentPage>totalPages) currentPage = totalPages;
  if(currentPage<1) currentPage = 1;
  var start = (currentPage-1)*pageSize;
  var end   = Math.min(start+pageSize, total);
  var pageRows = rows.slice(start,end);

  tbody.innerHTML=pageRows.map(d=>{
    var slaObj=slaStatus(d.prazo,d);
    var tooltip = slaTooltip(d.prazo,d);
    var slaClass = (slaObj.code==='late'?'sla-late':(slaObj.code==='risk'?'sla-risk':'sla-ok'));
    var slaPill='<span class="badge sla-pill '+slaClass+'" title="'+(tooltip || d.prazo || '')+'">'+slaObj.label+'</span>';
    var showConfirm=d.status==='Aberto';
    var unread=d.status==='Em tratativa'?getUnreadCount(d):0;
    var unreadBadge=unread>0?'<span class="badge-unread" title="'+unread+' nova(s)">'+unread+'</span>':'';
    var primaryHtml='';
    if(d.status==='Aberto'){
      primaryHtml='<button class="btn-warning btn-icon" title="Confirmar (vai para Em tratativa)" onclick="confirmTicket(\''+d.id+'\')"><i class="fa fa-check-double"></i></button>';
    }else if(d.status==='Pendente'){
      primaryHtml='<button class="btn-warning btn-icon" title="Retomar agora" onclick="resumeTicket(\''+d.id+'\')"><i class="fa fa-play"></i></button>';
    }else{
      primaryHtml='<button class="btn-ghost btn-icon" title="Abrir" onclick="openEdit(\''+d.id+'\')"><i class="fa fa-pen-to-square"></i>'+unreadBadge+'</button>';
    }

    
    var primaryBtn = primaryHtml;
    // Menu contextual (limpa a linha: deixa só ação principal + ⋮)
    var items=[];
    function mi(icon, label, fn){
      return '<div class="more-item" onclick="'+fn+'; hideAllMoreMenus(); event.stopPropagation();"><i class="fa '+icon+'"></i><span>'+label+'</span></div>';
    }
    // Abrir quase sempre existe
    if(d.status!=='Aberto'){ items.push(mi('fa-pen-to-square','Abrir','openEdit(\''+d.id+'\')')); }
    else { items.push(mi('fa-pen-to-square','Abrir','openEdit(\''+d.id+'\')')); }

    if(d.status!=='Encerrado'){
      items.push(mi('fa-check','Encerrar','closeTicket(\''+d.id+'\')'));
      items.push(mi('fa-clock','Adiar','snoozeTicket(\''+d.id+'\')'));
    }
    if(d.status==='Aberto'){
      // confirmar já é primário, então não repete no menu
    }
    if(d.status==='Pendente'){
      // retomar é primário, então não repete no menu
    }
    items.push(mi('fa-trash','Excluir','removeTicket(\''+d.id+'\')'));
    var moreHtml = items.length ? ('<div class="more-menu" id="more-'+d.id+'" onclick="event.stopPropagation();">'+items.join('')+'</div>') : '';

    var catCell = d.categoria==='SAK' ? '<span class="badge sak-badge">SAK</span>'
                 : d.categoria==='Frota - Transportadora' ? '<span class="badge frota-badge">Frota - Transportadora</span>'
                 : (d.categoria||'-');

    return '<tr>\
      <td class="col-abertoEm">'+fmtDate(d.abertoEm)+'</td>\
      <td class="col-solicitante">'+ (d.solicitante||'-') +'</td>\
      <td class="col-assunto">'+ (d.assunto||'-') +'</td>\
      <td class="col-codigo">'+ (d.codigo||'<span class="muted">—</span>') +'</td>\
      <td class="col-categoria">'+catCell+'</td>\
      <td class="col-canal">'+ (d.canal||'<span class="muted">—</span>') +'</td>\
      <td class="col-prioridade">'+prioBadge(d.prioridade||'-')+'</td>\
      <td class="col-status">'+statusBadge(d.status||'-')+'</td>\
      <td class="col-sla">'+ (d.prazo? slaPill : '<span class="muted">—</span>') +'</td>\
      <td class="col-resp">'+ (d.responsavel||'<span class="muted">—</span>') +'</td>\
      <td class="table-actions col-acoes">\
        <div class="actions-wrap">\
          '+primaryBtn+'\
          '+(moreHtml?('<button class="btn-ghost btn-icon" title="Mais" onclick="toggleMore(event,\''+d.id+'\');"><i class="fa fa-ellipsis-vertical"></i></button>'+moreHtml):'')+'\
        </div>\
      </td>\
    </tr>';
  }).join('');

  updateKPIs();
  syncQuickUI();

  /* render paginação */
  var pager=qs('#pager');
  var infoText='Mostrando '+(start+1)+'–'+end+' de '+total;
  var hasPrev=currentPage>1;
  var hasNext=currentPage<totalPages;
  var pagesHtml='';
  // mostra no máx 5 páginas no controle
  var from=Math.max(1,currentPage-2);
  var to=Math.min(totalPages,from+4);
  for(var p=from;p<=to;p++){
    pagesHtml+='<button class="pager-btn" '+(p===currentPage?'style="font-weight:600;border-color:var(--primary)"':'')+' onclick="goPage('+p+')">'+p+'</button>';
  }
  pager.innerHTML=
    '<span class="muted">'+infoText+'</span>'+
    '<div class="pager-pages">'+
      '<button class="pager-btn" onclick="goPage(1)" '+(hasPrev?'':'disabled')+'>«</button>'+
      '<button class="pager-btn" onclick="goPage('+(currentPage-1)+')" '+(hasPrev?'':'disabled')+'>‹</button>'+
      pagesHtml+
      '<button class="pager-btn" onclick="goPage('+(currentPage+1)+')" '+(hasNext?'':'disabled')+'>›</button>'+
      '<button class="pager-btn" onclick="goPage('+totalPages+')" '+(hasNext?'':'disabled')+'>»</button>'+
    '</div>';

  updateSortIcons();
}

/* pagina change + sort setter */
function goPage(p){
  currentPage = p;
  render();
}
function setSort(field){
  if(sortField===field){
    sortDir = (sortDir==='asc'?'desc':'asc');
  }else{
    sortField = field;
    sortDir = (field==='abertoEm' ? 'desc' : 'asc');
  }
  currentPage = 1;
  render();
}


/* ===== Actions menu (kebab) ===== */
function closeAllMenus(){
  document.querySelectorAll('.menu.show').forEach(m=>m.classList.remove('show'));
}

function hideAllMoreMenus(){
  document.querySelectorAll('.more-menu.show').forEach(function(m){ m.classList.remove('show'); });
}
function toggleMore(ev,id){
  try{ if(ev){ ev.stopPropagation(); ev.preventDefault(); } }catch(e){}
  // aceita chamada antiga toggleMore(id)
  if(typeof id==='undefined'){ id=ev; ev=null; }
  hideAllMoreMenus();
  var el = document.getElementById('more-'+id);
  if(el){ el.classList.toggle('show'); }
}

function toggleRowMenu(id, ev){
  try{ ev && ev.stopPropagation(); ev && ev.preventDefault(); }catch(e){}
  closeAllMenus();
  var el=document.getElementById('menu-'+id);
  if(el) el.classList.toggle('show');
}
document.addEventListener('click', function(e){
  // fecha menus ao clicar fora
  if(!e.target.closest('.actions-menu')) closeAllMenus();
  if(!e.target.closest('.more-menu') && !e.target.closest('.fa-ellipsis-vertical') && !e.target.closest('[title="Mais"]')) hideAllMoreMenus();
});

/* bind cabeçalhos sortáveis */
qsa('th.sortable').forEach(th=>{
  th.addEventListener('click', function(){
    var f=this.dataset.field;
    if(f) setSort(f);
  });
});

/* ========= Render Encerrados ========= */
function renderClosedPage(){
  var term=(qs('#fClosed').value||'').toLowerCase().trim();
  var rows=data.filter(d=>{ 
    if(d.status!=='Encerrado')return false;
    if(!term) return true;
    var searchable=[d.solicitante,d.assunto,d.descricao,d.codigo,d.transportadora,d.canal].join(' ').toLowerCase();
    return searchable.indexOf(term)>-1;
  }).sort((a,b)=>b.abertoEm-a.abertoEm);

  var tbody=qs('#tbodyClosed');
  if(!rows.length){tbody.innerHTML='<tr><td colspan="9" class="muted">Nenhum encerrado encontrado</td></tr>';return;}
  tbody.innerHTML=rows.map(d=>{
    var catCell = d.categoria==='SAK' ? '<span class="badge sak-badge">SAK</span>'
                 : d.categoria==='Frota - Transportadora' ? '<span class="badge frota-badge">Frota - Transportadora</span>'
                 : (d.categoria||'-');
    return '<tr>\n\
      <td>'+fmtDate(d.abertoEm)+'</td>\n\
      <td>'+ (d.solicitante||'-') +'</td>\n\
      <td>'+ (d.assunto||'-') +'</td>\n\
      <td>'+ (d.codigo||'<span class="muted">—</span>') +'</td>\n\
      <td>'+catCell+'</td>\n\
      <td>'+ (d.canal||'<span class="muted">—</span>') +'</td>\n\
      <td>'+prioBadge(d.prioridade||'-')+'</td>\n\
      <td>'+statusBadge(d.status||'-')+'</td>\n\
      <td>'+ (d.responsavel||'<span class="muted">—</span>') +'</td>\n\
    </tr>';
  }).join('');
}

/* ========= KPIs ========= */

function getClosedAt(d){
  if (d.closedAt) {
    return d.closedAt;
  }
  var h=(d.historico||[]).slice().sort((a,b)=>a.at-b.at);
  for(var i=0;i<h.length;i++){
    var it=h[i]; 
    if((it.txt||'').toLowerCase().indexOf('encerrado')>-1) return it.at;
  }
  // fallback para tickets antigos sem closedAt/histórico
  if(d.status==='Encerrado'){
    if(d.prazo){
      // usa o final do dia do prazo como aproximação
      return new Date(d.prazo+'T23:59:59').getTime();
    }
    if(d.abertoEm){
      return d.abertoEm;
    }
  }
  return null;
}

function renderKPIs(){
  var input=qs('#kpiMonth'); if(!input.value){input.value=ym(new Date())}
  var sel=input.value; qs('#mKpiMesLabel').textContent=sel;

  var baseAbertos=data.filter(d=>ym(new Date(d.abertoEm))===sel);
  qs('#mKpiAberto').textContent    = baseAbertos.filter(d=>d.status==='Aberto').length;
  qs('#mKpiTratativa').textContent = baseAbertos.filter(d=>d.status==='Em tratativa').length;
  qs('#mKpiPendente').textContent  = baseAbertos.filter(d=>d.status==='Pendente').length;
  qs('#mKpiEncerrado').textContent = baseAbertos.filter(d=>d.status==='Encerrado').length;

  var closedThisMonth=data.map(d=>({d,closedAt:getClosedAt(d)})).filter(x=>x.closedAt && ym(new Date(x.closedAt))===sel);
  var closedWithSLA=closedThisMonth.filter(x=>!!x.d.prazo);
  var denom=closedWithSLA.length;
  var onTime=closedWithSLA.filter(x=>new Date(x.d.prazo+'T23:59:59')>=new Date(x.closedAt)).length;
  var pctOn=denom?Math.round(onTime/denom*100):0;
  var pctLate=denom?100-pctOn:0;
  qs('#mKpiFechadosMes').textContent=closedThisMonth.length;
  qs('#mKpiFechadosBase').textContent='com SLA: '+denom;
  qs('#mKpiPctPrazo').textContent=pctOn+'%';
  qs('#mKpiQtdPrazo').textContent=onTime+' de '+denom;
  qs('#mKpiPctVenc').textContent=pctLate+'%';
  qs('#mKpiQtdVenc').textContent=(denom-onTime)+' de '+denom;

  var categorias=[...new Set(data.map(d=>d.categoria||'—'))].sort();
  function porCat(c){return baseAbertos.filter(d=>d.categoria===c)}
  var valsAberto=categorias.map(c=>porCat(c).filter(d=>d.status==='Aberto').length);
  var valsTrat=categorias.map(c=>porCat(c).filter(d=>d.status==='Em tratativa').length);
  var valsPend=categorias.map(c=>porCat(c).filter(d=>d.status==='Pendente').length);
  var valsEnc=categorias.map(c=>porCat(c).filter(d=>d.status==='Encerrado').length);
  var ctx1=document.getElementById('chartAbertos').getContext('2d');
  if(chartAbertos)chartAbertos.destroy();
  chartAbertos=new Chart(ctx1,{type:'bar',data:{labels:categorias,datasets:[{label:'Aberto',data:valsAberto},{label:'Em tratativa',data:valsTrat},{label:'Pendente',data:valsPend},{label:'Encerrado',data:valsEnc}]},options:{plugins:{legend:{position:'bottom'}},scales:{y:{beginAtZero:true,ticks:{precision:0}}}}});

  function closedByCat(c){return closedThisMonth.filter(x=>x.d.categoria===c)}
  var valsPrazo=categorias.map(c=>closedByCat(c).filter(x=>new Date(x.d.prazo+'T23:59:59')>=new Date(x.closedAt)).length);
  var valsVenc=categorias.map(c=>closedByCat(c).filter(x=>new Date(x.d.prazo+'T23:59:59')< new Date(x.closedAt)).length);
  var ctx2=document.getElementById('chartConcluidos').getContext('2d');
  if(chartConcluidos)chartConcluidos.destroy();
  chartConcluidos=new Chart(ctx2,{type:'bar',data:{labels:categorias,datasets:[{label:'No prazo',data:valsPrazo},{label:'Vencidos',data:valsVenc}]},options:{plugins:{legend:{position:'bottom'}},scales:{y:{beginAtZero:true,ticks:{precision:0}}}}});

  // NOVO: Shopee x Mercado Livre
  var qtdShopee = baseAbertos.filter(d=>(d.canal||'')==='Shopee').length;
  var qtdMeli   = baseAbertos.filter(d=>(d.canal||'')==='Mercado Livre').length;
  var ctxC=document.getElementById('chartCanal').getContext('2d');
  if(chartCanal) chartCanal.destroy();
  chartCanal=new Chart(ctxC,{type:'bar',data:{labels:['Mercado Livre','Shopee'],datasets:[{label:'Abertos',data:[qtdMeli,qtdShopee]}]},options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{precision:0}}}}});

  var baseTransp=baseAbertos.filter(d=>(d.transportadora||'').trim()!=='');
  var mapa={}; baseTransp.forEach(d=>{var k=d.transportadora.trim(); mapa[k]=(mapa[k]||0)+1});
  var transp=Object.keys(mapa).sort((a,b)=>mapa[b]-mapa[a]);
  var valsTransp=transp.map(t=>mapa[t]);
  var ctx3=document.getElementById('chartTransp').getContext('2d');
  if(chartTransp)chartTransp.destroy();
  chartTransp=new Chart(ctx3,{type:'bar',data:{labels:transp,datasets:[{label:'Abertos',data:valsTransp}]},options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{precision:0}}}}});
}

/* ========= Modal + Form (tickets) ========= */
function openModal(show){var m=qs('#modal'); if(show){m.classList.add('show');m.style.display='grid'}else{m.classList.remove('show');m.style.display='none'}}

/* Admin pode editar tudo; não-admin mantém restrição */
function setEditable(edit){
  var form=qs('#frm');
  form.classList.toggle('readonly',!edit);
  qsa('#frm input,#frm select,#frm textarea').forEach(el=>{ if(el.id==='ticketId') return; el.readOnly = !edit; el.disabled = !edit; });
  var me=currentUser()||{};
  if(!(me.role==='admin')){
    qs('#solicitante').readOnly = true;
    qs('#solicitante').disabled = true;
  }
}
function enablePriorityOnly(){
  qsa('#frm input, #frm select, #frm textarea').forEach(el=>{ if(['ticketId','prioridade'].includes(el.id)) return; el.readOnly=true; el.disabled=true });
  var p=qs('#prioridade'); p.disabled=false; p.readOnly=false; p.style.pointerEvents='auto'; p.style.opacity='1';
  qs('#btnSave').classList.remove('hidden');
}
function toggleResponsavelByCategoria(){
  var frota = qs('#categoriaSel').value==='Frota - Transportadora';
  qs('#responsavelWrap').classList.toggle('hidden', qs('#categoriaSel').value==='SAK');
  qs('#transportadoraWrap').classList.toggle('hidden', !frota);
}
function resetForm(){
  qs('#ticketId').value='';
  qs('#solicitante').value=(currentUser()||{}).name||'';
  qs('#categoriaSel').value='Frota - Transportadora';
  qs('#assunto').value=''; qs('#prioridade').value='Média'; qs('#descricao').value='';
  qs('#status').value='Aberto'; qs('#responsavel').value=''; qs('#transportadora').value='';
  qs('#prazo').value=''; qs('#codigo').value=''; qs('#canalSel').value='';
  qs('#chatHistory').innerHTML=''; qs('#chatText').value='';
  qs('#btnDelete').style.display=((currentUser()||{}).role==='admin')?'inline-flex':'none';
  qs('#btnConfirm').disabled=true; qs('#btnSave').classList.remove('hidden');
  setEditable(true); toggleResponsavelByCategoria();
}

function renderTicketChat(list){
  const u = (currentUser()||{}).name || '';
  const chunks = [];
  let lastDay = null, lastWho = null;
  (list||[]).slice().sort((a,b)=>a.at-b.at).forEach(h=>{
    const d   = new Date(h.at);
    const day = d.toISOString().slice(0,10);
    const who = (h.user===u ? 'me' : 'them');
    if (day !== lastDay){
      chunks.push({ t:'sep', label: d.toLocaleDateString('pt-BR') });
      lastDay = day; lastWho = null;
    }
    chunks.push({
      t:'msg',
      who,
      txt: (h.txt||''),
      time: d.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}),
      grouped: (who===lastWho)
    });
    lastWho = who;
  });
  qs('#chatHistory').innerHTML = chunks.map(c=>{
    if (c.t==='sep') return `<div class="sep"><span>${c.label}</span></div>`;
    return `<div class="bubble ${c.who}${c.grouped?' grouped':''}">${escapeHtml(c.txt)}<time>${c.time}</time></div>`;
  }).join('');
  const div = qs('#chatHistory');
  if (div) div.scrollTop = div.scrollHeight;
}

async function loadTicketChat(ticketId){
  if (!supa) return;
  const d    = Array.isArray(data) ? data.find(x => String(x.id) === String(ticketId)) : null;
  const key1 = (ticketId + "");
  let   key2 = d && d.codigo ? (d.codigo + "") : null;
  if (!key2) {
    const tr = await supa.from('tickets').select('codigo').eq('id', ticketId).single();
    if (!tr.error && tr.data && tr.data.codigo) key2 = tr.data.codigo + "";
  }
  const keys = (key2 && key2 !== key1) ? [key1, key2] : [key1];
  const r = await supa
    .from('messages')
    .select('ticket_id, body, sender_name, created_at')
    .in('ticket_id', keys)
    .order('created_at', { ascending: true });
  if (r.error){ console.error('loadTicketChat error:', r.error, 'keys=', keys); renderTicketChat([]); return; }
  const list = (r.data || []).map(m => ({
    at:  new Date(m.created_at).getTime(),
    txt: m.body,
    user: (m.sender_name || '—')
  }));
  if (d) d.historico = list;
  renderTicketChat(list);
}

function setSelectValue(sel,value){
  if(!sel)return; var has=[].some.call(sel.options,o=>o.value===value);
  if(value && !has){var o=document.createElement('option');o.value=value;o.textContent=value+' (legado)'; sel.appendChild(o)}
  sel.value=value||sel.value;
}
function openNew(){resetForm();qs('#modalTitle').textContent='Nova solicitação';openModal(true)}
async function subscribeTicketChannel(ticketId){
  ticketId = String(ticketId);

  if (!supa) return;
  if (ticketChannels.has(ticketId)) return;
  var ch = supa.channel('ticket-'+ticketId);
  ch.on('broadcast', { event: 'chat' }, payload=>{
    var d = data.find(x=>x.id === ticketId);
    if (!d) return;
    var p = (payload && payload.payload) ? payload.payload : {};
    var at = p.at, txt = p.txt, user = p.user;
    var exists = (d.historico||[]).some(h=>h.at===at && h.txt===txt && h.user===user);
    if (!exists){
      d.historico.push({ at: at, txt: txt, user: user });
      if (qs('#ticketId').value === ticketId) loadTicketChat(ticketId);
      render();
    }
  });
  await ch.subscribe();
  ticketChannels.set(ticketId, ch);
}
var ticketChannels = new Map();
async function openEdit(id){
  id = String(id);

  var d=data.find(x=>String(x.id)===id); if(!d)return;
  resetForm(); qs('#modalTitle').textContent='Editar solicitação'; qs('#ticketId').value=d.id;
  qs('#solicitante').value=d.solicitante||((currentUser()||{}).name||'');
  qs('#categoriaSel').value=d.categoria||'Frota - Transportadora';
  setSelectValue(qs('#assunto'), d.assunto||''); qs('#prioridade').value=d.prioridade||'Média';
  qs('#descricao').value=d.descricao||''; qs('#status').value=d.status||'Aberto'; qs('#responsavel').value=d.responsavel||'';
  qs('#prazo').value=d.prazo||''; qs('#codigo').value=d.codigo||''; qs('#transportadora').value=d.transportadora||'';
  qs('#canalSel').value=d.canal||'';
  await loadTicketChat(d.id); qs('#btnDelete').style.display=((currentUser()||{}).role==='admin')?'inline-flex':'none';
  qs('#btnConfirm').disabled=d.status!=='Aberto';

  var isAdmin = ((currentUser()||{}).role === 'admin');
  if(isAdmin){ setEditable(true); } else { setEditable(false); enablePriorityOnly(); }

  toggleResponsavelByCategoria();
  await supaMarkRead(d.id); await subscribeTicketChannel(d.id); render(); openModal(true);
}
function collectForm(){
  var id=String(qs('#ticketId').value||uid()); var now=Date.now();
  var exists=data.find(x=>String(x.id)===id); var abertoEm=exists?exists.abertoEm:now; var prevClosedAt=exists?exists.closedAt||null:null;
  var rawPrazo=qs('#prazo').value; var prioridadeSel=qs('#prioridade').value;
  var prazo=exists?ensureSLA(rawPrazo,prioridadeSel,abertoEm):ensureSLAForForm(rawPrazo,prioridadeSel,abertoEm);
  var categoria=qs('#categoriaSel').value; var responsavel=qs('#responsavel').value.trim(); if(categoria==='SAK') responsavel='';
  return {
    id:id, abertoEm:abertoEm,
    solicitante:qs('#solicitante').value.trim(),
    categoria:categoria, assunto:qs('#assunto').value.trim(),
    prioridade:qs('#prioridade').value,
    descricao:qs('#descricao').value.trim(),
    status:qs('#status').value,
    closedAt: (qs('#status').value==='Encerrado' ? (prevClosedAt||now) : prevClosedAt),
    responsavel:responsavel,
    prazo:prazo,
    codigo:qs('#codigo').value.trim(),
    transportadora:qs('#transportadora').value.trim(),
    canal: qs('#canalSel').value.trim(),
    pendente: exists? !!exists.pendente : false,
    retomar_em: exists? (exists.retomar_em||'') : '',
    openedBy: exists? exists.openedBy : ((currentUser()||{}).id || null),
    historico: exists? exists.historico : [{at:abertoEm,txt:'Ticket aberto por '+(qs('#solicitante').value.trim()||'usuário'),user:(qs('#solicitante').value.trim()||'usuário')}]
  }
}
async function save(e){
  e.preventDefault();

  var solicitante    = qs('#solicitante').value.trim();
  var categoria      = qs('#categoriaSel').value;
  var prioridade     = qs('#prioridade').value;
  var assunto        = qs('#assunto').value.trim();
  var status         = qs('#status').value;
  var codigo         = qs('#codigo').value.trim();
  var canal          = qs('#canalSel').value.trim();
  var descricao      = qs('#descricao').value.trim();
  var transportadora = qs('#transportadora').value.trim();
  var isFrota        = (categoria === 'Frota - Transportadora');

  // validação dos campos obrigatórios
  if (
    !solicitante ||
    !categoria ||
    !prioridade ||
    !assunto ||
    !status ||
    !codigo ||
    !canal ||
    !descricao ||
    (isFrota && !transportadora)
  ){
    alert('Preencha todos os campos obrigatórios antes de salvar. Para categoria "Frota - Transportadora", Transportadora também é obrigatória.');
    return;
  }

  // Responsável pode ficar em branco (será definido no Confirmar)

  var rec = collectForm();

  var i = data.findIndex(x=>String(x.id)===String(rec.id));
  if (i >= 0) {
    data[i] = Object.assign({}, data[i], rec);
  } else {
    data.push(rec);
  }

  await supaUpsertTicket(rec);

  await addHistory(
    rec.id,
    (i >= 0 ? 'Atualizado' : 'Criado') + ' por ' + (((currentUser() || {}).name) || 'sistema')
  );

  // Garantir que o ticket recém-criado apareça na lista mesmo se havia filtros ativos
  if (i < 0) {
    try {
      // limpa filtros que normalmente escondem o novo ticket
      qs('#fStatus').value = '';
      qs('#fPrio').value = '';
      qs('#fCategoria').value = '';
      qs('#fSLA').value = '';
      qs('#fPend').value = '';

      // mantém o "ocultar encerrados" ligado (não afeta tickets abertos)
      // e desliga "só meus" caso esteja atrapalhando (ex.: sessão inconsistente)
      qs('#fMine').checked = false;
      qs('#tgMine').classList.remove('active');

      // busca automaticamente pelo código do cliente do ticket criado
      qs('#fSearch').value = (rec.codigo || rec.id || '').toString();

      saveFilters();
      currentPage = 1;
    } catch (e) {}
  }

  render();
  openEdit(rec.id);
}
async function addHistory(id,text,ts){
  id = String(id);

  var d=data.find(x=>String(x.id)===id); if(!d)return;
  var stamp = ts || Date.now();
  d.historico=d.historico||[]; d.historico.push({at:stamp,txt:text,user:((currentUser()||{}).name)||''});
  await loadTicketChat(d.id);
  await supaAddMessage(id,text);
}
async function removeTicket(id){
  id = String(id);
 if(((currentUser()||{}).role)!=='admin'){alert('Apenas administradores podem excluir.');return;} if(!confirm('Deseja excluir esta solicitação?'))return; data=data.filter(x=>String(x.id)!==id); await supaDeleteTicket(id); render(); openModal(false)}

async function snoozeTicket(id){
  id = String(id);

  var d=data.find(x=>String(x.id)===id); if(!d)return;
  var pad=n=>String(n).padStart(2,'0');
  var def=d.retomar_em || (function(){var k=new Date();k.setDate(k.getDate()+1);return k.getFullYear()+'-'+pad(k.getMonth()+1)+'-'+pad(k.getDate())})();
  var val=prompt('Retomar em (AAAA-MM-DD):',def); if(!val)return;
  d.pendente=true; d.retomar_em=val; d.status='Pendente';
  await supaUpsertTicket(d); await addHistory(id,'Adiado (status Pendente) até '+new Date(val).toLocaleDateString('pt-BR')); render();
}
async function resumeTicket(id){
  id = String(id);

  var d=data.find(x=>String(x.id)===id); if(!d)return;
  d.retomar_em=''; d.status='Em tratativa';
  d.pendente = true;
  await supaUpsertTicket(d); await addHistory(id,'Retomado (status Em tratativa)'); render()
}

async function closeTicket(id){
  id = String(id);

  var d=data.find(x=>String(x.id)===id); if(!d)return;
  if(d.status==='Encerrado'){
    toast('Esta solicitação já está encerrada.');
    return;
  }
  if(!confirm('Deseja encerrar esta solicitação?')) return;

  var me=currentUser()||{};
  var meName=me.name||'usuário';

  // garante responsável definido
  if(!d.responsavel){
    d.responsavel = meName;
  }
  // garante SLA definido
  d.prazo = ensureSLA(d.prazo, d.prioridade, d.abertoEm);

  // remove pendência/retomada e marca como encerrado
  d.retomar_em = '';
  d.status = 'Encerrado';
  d.pendente = false;
  d.closedAt = Date.now();

  await supaUpsertTicket(d);
  await addHistory(id,'Encerrado por '+meName);
  render();
}
async function confirmTicket(id){
  id = String(id);

  var d = data.find(x=>String(x.id)===id);
  if (!d) return;

  // só faz sentido confirmar se ainda está em Aberto
  if (d.status !== 'Aberto') {
    toast('Ticket já não está em Aberto.');
    return;
  }

  var me     = currentUser() || {};
  var meName = me.name || 'usuário';
  var oldStatus = d.status;

  // define responsável automaticamente para quem confirmou
  if (d.categoria === 'SAK' || d.categoria === 'Frota - Transportadora') {
    d.responsavel = meName;
    toast('Responsável definido: ' + d.responsavel);
  }

  d.status = 'Em tratativa';

  await supaUpsertTicket(d);

  await addHistory(
    id,
    'Confirmado por ' + meName +
    ' — responsável definido para ' + (d.responsavel || 'não definido') +
    ' (status ' + oldStatus + ' ➜ Em tratativa)'
  );

  render();
}

/* Bindings tickets */
document.getElementById('btnDelete').onclick=function(){removeTicket(qs('#ticketId').value)};
document.getElementById('btnConfirm').onclick=async function(){
  var id=qs('#ticketId').value; if(!id){alert('Salve primeiro para confirmar.');return;} 
  await confirmTicket(id); await openEdit(id)
};
document.getElementById('frm').addEventListener('submit',save); 
document.getElementById('btnSave').addEventListener('click',save);
document.getElementById('closeModal').addEventListener('click',function(){openModal(false)}); 
document.getElementById('categoriaSel').addEventListener('change',toggleResponsavelByCategoria);
document.getElementById('btnNew').addEventListener('click',function(e){e.preventDefault();e.stopPropagation();openNew()});

/* filtros + salvar filtros */
['#fStatus','#fPrio','#fCategoria','#fSLA','#fPend'].forEach(id=>{
  qs(id).addEventListener('change',function(){
    saveFilters();
    currentPage=1;
    render();
  });
});
qs('#fSearch').addEventListener('input', debounce(function(){ saveFilters(); currentPage=1; render(); },200));




qs('#btnClear').onclick=function(){
  qs('#fSearch').value='';qs('#fStatus').value='';qs('#fPrio').value='';qs('#fCategoria').value='';
  qs('#fSLA').value='';qs('#fPend').value='';
  qs('#fMine').checked=false;qs('#tgMine').classList.remove('active');
  qs('#fHideClosed').checked=true;qs('#tgHideClosed').classList.add('active');
  saveFilters();
  currentPage=1;
  render()
};


/* ===== Status Tabs + Quick Chips (v2.6) ===== */
function setActive(el, on){ if(!el) return; el.classList.toggle('active', !!on); }
function applyStatusTab(tab){
  statusTab = tab || 'Abertos';
  // UI active
  qsa('#statusTabs .tab-btn').forEach(b=>b.classList.toggle('active', b.dataset.tab===statusTab));
  // aplica filtros
  if(statusTab==='Tudo'){
    qs('#fStatus').value='';
    qs('#fHideClosed').checked=false;
    qs('#tgHideClosed').classList.toggle('active', false);
  }else if(statusTab==='Encerrado'){
    qs('#fStatus').value='Encerrado';
    qs('#fHideClosed').checked=false;
    qs('#tgHideClosed').classList.toggle('active', false);
  }else{
    qs('#fStatus').value = statusTab; // Aberto / Em tratativa / Pendente
    // por padrão esconde encerrados quando não estou na aba Encerrados/Tudo
    qs('#fHideClosed').checked=true;
    qs('#tgHideClosed').classList.toggle('active', true);
  }
  saveFilters();
  currentPage=1;
  render();
}


/* Toggle compactos (ícones) */
qs('#tgMine').onclick=function(){
  var c=qs('#fMine');c.checked=!c.checked;
  this.classList.toggle('active',c.checked);
  saveFilters();
  currentPage=1;
  render()
};
qs('#tgHideClosed').onclick=function(){
  var c=qs('#fHideClosed');c.checked=!c.checked;
  this.classList.toggle('active',c.checked);
  saveFilters();
  currentPage=1;
  render()
};

/* Chat do ticket (instant) */
async function sendChat(){
  var id = qs('#ticketId').value;
  if (!id) {
    alert('Salve primeiro para conversar.');
    return;
  }

  var txt = qs('#chatText').value;
  if (!txt || !txt.trim()) return;

  var ts = Date.now();

  // Só registra a mensagem no histórico/chat. NÃO muda status.
  await addHistory(id, txt.trimEnd(), ts);
  qs('#chatText').value = '';

  await supaMarkRead(id);
  render();

  var ch = ticketChannels.get(id);
  if (ch) {
    ch.send({
      type: 'broadcast',
      event: 'chat',
      payload: {
        at: ts,
        txt: txt.trimEnd(),
        user: ((currentUser() || {}).name || '')
      }
    });
  }

  var divEl = qs('#chatHistory');
  if (divEl) divEl.scrollTop = divEl.scrollHeight;
}
  
qs('#btnSendChat').onclick=sendChat; 
qs('#chatText').addEventListener('keydown',e=>{
  if(e.key==='Enter'){
    if(e.shiftKey){
      // permite quebra de linha
      return;
    }
    e.preventDefault();
    sendChat();
  }
});

/* Export XLSX (mantive ID no export, útil para auditoria) */
function buildHistoricoString(hist){return (hist||[]).sort((a,b)=>a.at-b.at).map(h=>new Date(h.at).toLocaleString('pt-BR')+' — '+(h.user||'')+': '+(h.txt||'')).join('\n')}
function exportXLSX(){
  var rows=data.slice().sort((a,b)=>{const pr=p=>p==='Alta'?0:(p==='Média'?1:2); return pr(a.prioridade)-pr(b.prioridade) || b.abertoEm-a.abertoEm});
  var header=['ID','Aberto em','Solicitante','Categoria','Assunto','Prioridade','Descrição','Status','Responsável','Prazo (SLA)','Código cliente','Transportadora','Canal','Pendente?','Retomar em','Histórico (chat)'];
  var aoa=[header];
  rows.forEach(r=>aoa.push([
    r.id, new Date(r.abertoEm), r.solicitante||'', r.categoria||'', r.assunto||'', r.prioridade||'', r.descricao||'', r.status||'', r.responsavel||'',
    r.prazo?new Date(r.prazo+'T00:00:00'):'', r.codigo||'', r.transportadora||'', r.canal||'', 
    r.status==='Pendente'?'Sim':'Não', r.retomar_em||'', buildHistoricoString(r.historico)
  ]));
  var ws=XLSX.utils.aoa_to_sheet(aoa,{cellDates:true}); 
  ws['!cols']=[
    {wch:8},{wch:19},{wch:14},{wch:22},{wch:24},
    {wch:22},{wch:28},{wch:14},{wch:12},{wch:12},
    {wch:16},{wch:18},{wch:10},{wch:10},{wch:12},{wch:60}
  ];
  var wb=XLSX.utils.book_new(); 
  XLSX.utils.book_append_sheet(wb,ws,'Tickets'); 
  XLSX.writeFile(wb,'solicitacoes_'+new Date().toISOString().slice(0,10)+'.xlsx');
}
qs('#btnExportXLSX').onclick=exportXLSX;
qs('#btnNotif').onclick=toggleNotifPanel;
qs('#notifClose').onclick=hideNotifPanel;

/* Navegação: KPIs / Encerrados */
qs('#btnKPIs').onclick=function(){qs('#listPage').classList.add('hidden');qs('#closedPage').classList.add('hidden');qs('#kpiPage').classList.remove('hidden');renderKPIs();setHeadH()};
qs('#btnClosed').onclick=function(){qs('#listPage').classList.add('hidden');qs('#kpiPage').classList.add('hidden');qs('#closedPage').classList.remove('hidden');renderClosedPage();setHeadH()};
qs('#btnBackList').onclick=function(){qs('#closedPage').classList.add('hidden');qs('#listPage').classList.remove('hidden');setHeadH();render()};
qs('#btnBackList2').onclick=function(){qs('#kpiPage').classList.add('hidden');qs('#listPage').classList.remove('hidden');setHeadH();render()};
qs('#fClosed').addEventListener('input',debounce(renderClosedPage,200));

qs('#btnApplyKpi').onclick=function(){
  renderKPIs();
};
/* Diagnóstico */
function showDiag(){
  var b=qs('#diagBar'); b.classList.remove('hidden');
  qs('#diagEnv').textContent   = 'Projeto: '+(SUPA_URL||'N/D');
  var cu=(currentUser()||{}).id||'sem sessão';
  qs('#diagUser').textContent  = 'Usuário: '+cu;
  qs('#diagCount').textContent = 'Tickets retornados: '+(data?data.length:0);
  qs('#diagErr').textContent   = supaReady()? '' : 'config.js ausente/sem chaves';
}
qs('#btnDiag').onclick=showDiag; 
qs('#diagClose').onclick=function(){qs('#diagBar').classList.add('hidden')};

/* ========= Perfis / DM ========= */
async function loadProfiles(){
  if(!supaReady())return;
  var r=await supa.from('profiles').select('id,display_name,role,username').order('display_name');
  profiles=r.data||[];
}
function renderDmUsers(){
  var me=currentUser(); var term=(qs('#dmSearch').value||'').toLowerCase();
  var list=profiles.filter(p=>p.id!==me.id && ((p.display_name||'').toLowerCase().indexOf(term)>-1));
  var host=qs('#dmUsers');
  host.innerHTML=list.map(p=>{
    var unread=countDmUnread(p.id);
    var badge=unread>0?'<span class="badge-unread" style="position:static;margin-left:auto">'+unread+'</span>':'';
    return '<div class="item" onclick="openDm(\''+p.id+'\')"><i class="fa fa-user"></i> <div>'+escapeHtml(p.display_name||p.username||'')+'</div>'+badge+'</div>';
  }).join('') || '<div class="item muted">Nenhum usuário encontrado</div>';
}
function setDmBadge(){
  dmUnread = profiles.reduce((acc,p)=>acc + countDmUnread(p.id), 0);
  var b=qs('#dmBadge'); if(dmUnread>0){b.style.display='inline-grid'; b.textContent=dmUnread}else{b.style.display='none'}
}
function dmLastRead(userId){var me=currentUser(); return +(localStorage.getItem(dmKey(me.id,userId))||0)}
function markDmRead(userId){var me=currentUser(); localStorage.setItem(dmKey(me.id,userId), Date.now().toString()); setDmBadge(); renderDmUsers()}
function msgsWith(userId){var me=currentUser(); return dmCache.filter(m=>(m.sender===me.id && m.receiver===userId) || (m.sender===userId && m.receiver===me.id)).sort((a,b)=>new Date(a.created_at)-new Date(b.created_at))}
function countDmUnread(userId){var last=dmLastRead(userId); return msgsWith(userId).filter(m=>m.sender===userId && new Date(m.created_at).getTime()>last ).length}

async function loadDM(silent){
  if(!supaReady())return;
  var me=currentUser(); if(!me) return;
  var r=await supa.from('dm_messages').select('id,sender,receiver,body,created_at').or('sender.eq.'+me.id+',receiver.eq.'+me.id).order('created_at',{ascending:true});
  if(r.error){ if(!silent){toast('DM indisponível. Crie a tabela "dm_messages" (sender uuid, receiver uuid, body text, created_at).')} return; }
  dmCache=r.data||[];
  setDmBadge(); renderDmUsers(); if(dmTarget) renderDmChat(dmTarget);
}
function onDmInsert(row){
  var sig = [row.sender,row.receiver,row.body].join('|');
  if (dmSeen.has(sig)) return;
  markSeen(sig);
  var me=currentUser(); if(!me) return;
  if(row.sender===me.id || row.receiver===me.id){
    dmCache.push(row);
    if(dmTarget && (row.sender===dmTarget || row.receiver===dmTarget)) renderDmChat(dmTarget);
    setDmBadge(); renderDmUsers();
    if(row.receiver===me.id && (!dmTarget || dmTarget!==row.sender)){
      toast('Nova mensagem de usuário');
      if(document.visibilityState!=='visible'){
        showNativeNotification('Nova mensagem direta',{
          body:(row.body||'').slice(0,80),
          tag:'dm-'+row.sender
        });
      }
    }
  }
}
async function subscribeDmChannel(otherId){
  if (!supa) return;
  var me = currentUser(); if (!me) return;
  var room = [me.id, otherId].sort().join('_');
  if (dmChannels.has(room)) return;

  var ch = supa.channel('dm-'+room);
  ch.on('broadcast', { event:'dm' }, payload=>{
    var m = payload && payload.payload ? payload.payload : {};
    var sig = [m.sender,m.receiver,m.body].join('|');
    if (dmSeen.has(sig)) return;
    markSeen(sig);
    dmCache.push({ id: m.id||uid(), sender: m.sender, receiver: m.receiver, body: m.body, created_at: new Date().toISOString() });
    if (dmTarget && (m.sender===dmTarget || m.receiver===dmTarget)) renderDmChat(dmTarget);
    setDmBadge(); renderDmUsers();
  });
  await ch.subscribe();
  dmChannels.set(room, ch);
}
var dmChannels = new Map();
function openDm(userId){
  dmTarget=userId;
  var user=profiles.find(p=>p.id===userId);
  qs('#dmHeader').textContent='Conversando com: ' + (user? (user.display_name||user.username||user.id) : userId);
  qs('#dmText').disabled=false; qs('#dmSend').disabled=false;
  renderDmChat(userId); subscribeDmChannel(userId); markDmRead(userId);
}
function renderDmChat(userId){
  const me = currentUser();
  const hist = qs('#dmHistory');
  const list = msgsWith(userId).sort((a,b)=> new Date(a.created_at)-new Date(b.created_at));

  const chunks = [];
  let lastDay = null, lastWho = null;
  list.forEach(m=>{
    const d = new Date(m.created_at);
    const dayKey = d.toISOString().slice(0,10);
    if(dayKey !== lastDay){
      chunks.push({type:'sep', label: d.toLocaleDateString('pt-BR')});
      lastDay = dayKey;
      lastWho = null;
    }
    const who = (m.sender===me.id) ? 'me' : 'them';
    const grouped = (who === lastWho);
    const time = d.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
    chunks.push({type:'msg', who: who, body: (m.body||''), time: time, grouped: grouped});
    lastWho = who;
  });

  hist.innerHTML = chunks.length ? chunks.map(c=>{
    if(c.type==='sep'){
      return `<div class="dm-sep"><span>${c.label}</span></div>`;
    }
    const cls = `bubble ${c.who} dm${c.grouped ? ' grouped':''}`;
    const txt = escapeHtml(c.body).replace(/\r?\n/g,'\n');
    return `<div class="${cls}"><div>${txt}</div><time>${c.time}</time></div>`;
  }).join('') : '<div class="muted small" style="padding:10px">Sem mensagens. Inicie a conversa.</div>';

  requestAnimationFrame(()=>{
    const nearBottom = (hist.scrollHeight - hist.clientHeight - hist.scrollTop) < 120;
    if(nearBottom) hist.scrollTop = hist.scrollHeight;
  });
}
async function sendDM(){
  const txt = (qs('#dmText').value||'').trimEnd();
  if(!txt || !dmTarget) return;

  const me=currentUser();
  const payload={sender:me.id,receiver:dmTarget,body:txt};
  const r=await supa.from('dm_messages').insert(payload);
  if(r.error){toast('Não foi possível enviar DM (policies/estrutura).');return;}

  qs('#dmText').value='';
  const room = [me.id, dmTarget].sort().join('_');
  const ch = dmChannels.get(room);
  if (ch){
    const sig = [me.id, dmTarget, txt].join('|'); markSeen(sig);
    ch.send({ type:'broadcast', event:'dm', payload:{ sender: me.id, receiver: dmTarget, body: txt, id: uid() } });
  }
  const hist = qs('#dmHistory');
  requestAnimationFrame(()=>{ hist.scrollTop = hist.scrollHeight; });
}

/* DM bindings */
qs('#dmSend').onclick=sendDM; 
qs('#dmText').addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();sendDM()}});
qs('#dmFab').onclick=function(){qs('#dmPanel').classList.toggle('show'); renderDmUsers(); if(dmTarget) markDmRead(dmTarget)};
qs('#dmClose').onclick=function(){qs('#dmPanel').classList.remove('show')};
qs('#dmSearch').addEventListener('input',debounce(renderDmUsers,150));

/* Tema binding */
qs('#btnTheme').onclick=function(){
  var current = document.body.classList.contains('theme-light') ? 'light' : 'dark';
  applyTheme(current==='light'?'dark':'light');
};
qs('#btnNotif').onclick=toggleNotifPanel;
if(qs('#notifClose')) qs('#notifClose').onclick=hideNotifPanel;


/* ========= Boot & Login ========= */
function showLogin(){qs('#loginSection').style.display='grid';qs('#appSection').style.display='none'}
function showApp(){qs('#loginSection').style.display='none';qs('#appSection').style.display='block';var u=currentUser();qs('#whoami').textContent=(u?u.name:'')+' • '+(u?u.role:'')}


const APP_VERSION = document.querySelector('meta[name="app-version"]')?.content || 'dev';
const VERSION_KEY = 'ci_interno_app_version';
function ensureLatestVersion(){
  try{
    const last = localStorage.getItem(VERSION_KEY);
    if(last && last !== APP_VERSION){
      localStorage.setItem(VERSION_KEY, APP_VERSION);
      alert('Sistema atualizado. A página será recarregada.');
      setTimeout(()=>location.reload(true), 300);
      return false;
    }
    localStorage.setItem(VERSION_KEY, APP_VERSION);
    return true;
  }catch(e){
    return true;
  }
}

async function boot(){ if(!ensureLatestVersion()) return; initTheme();
  var u=currentUser(); 
  if(!u){showLogin();return;} 
  showApp(); 
  await loadFromSupabase();
  if(ENABLE_DM){
    await loadProfiles();
    await loadDM(true);
  }
  loadFilters();
  wireEnterpriseUI();
  loadNotifications();
  renderNotificationsIcon();
  __booting=false;
  render(); 
  setupRealtime(); 
  setHeadH();
  if(window.askNotifyPermission) askNotifyPermission();
}
boot();

qs('#btnLogout').onclick=async function(){ if(supaReady()) await supa.auth.signOut(); clearSession(); showLogin()};

qs('#btnLogin').onclick=async function(){
  var login=(qs('#loginUser').value||'').trim().toLowerCase();
  var pass=qs('#loginPass').value;
  if(!supaReady()){alert('config.js não carregado ou incompleto (SUPABASE_URL/KEY).');return;}
  var email=login.indexOf('@')>-1?login:(login+'@'+DEFAULT_EMAIL_DOMAIN);

  var authResp=await supa.auth.signInWithPassword({email:email,password:pass});
  if(authResp.error){alert(authResp.error.message||'Usuário ou senha inválidos.');return;}

  var profileResp=await supa.from('profiles').select('*').eq('id',authResp.data.user.id).maybeSingle();
  var profile=profileResp.data;
  if(!profile){
    var username=email.split('@')[0];
    var display_name=username.replace(/[._-]+/g,' ').replace(/\b\w/g,c=>c.toUpperCase());
    await supa.from('profiles').upsert({id:authResp.data.user.id,username:username,display_name:display_name,role:'operador'});
    var pr2=await supa.from('profiles').select('*').eq('id',authResp.data.user.id).single(); profile=pr2.data;
  }
  var user={id:authResp.data.user.id,username:profile.username,name:profile.display_name,role:profile.role};
  setSession(user); 
  await loadFromSupabase();
  if(ENABLE_DM){
    await loadProfiles();
    await loadDM(true);
  }
  showApp(); 
  loadFilters();
  render(); 
  setupRealtime(); 
  
  loadNotifications();
  renderNotificationsIcon();
  setHeadH();
  askNotifyPermission();
}
boot();;

/* expose debug/global */
window.openEdit=openEdit; 
window.closeTicket=closeTicket; 
window.confirmTicket=confirmTicket;
window.snoozeTicket=snoozeTicket; 
window.resumeTicket=resumeTicket;
window.openDm=openDm;
window.goPage=goPage;
window.setSort=setSort;
</script>
</body>
</html>
