<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Controle Interno de Solicações</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<link rel="icon" href="logo.png"/>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="config.js"></script>

<style>
  :root{
    --bg:#0f1216; 
    --panel:#151a21; 
    --panel-2:#1b222b; 
    --text:#e9eef5; 
    --muted:#9aacbf;
    --primary:#4f8cff; 
    --success:#21c38a; 
    --warning:#ffbf47; 
    --danger:#ff5d5d; 
    --badge:#2a3442;
    --border:#263040; 
    --shadow:0 10px 30px rgba(0,0,0,.35); 
    --radius:16px;
    --headH:96px;
  }
  body.theme-light{
    --bg:#f3f4f6;
    --panel:#ffffff;
    --panel-2:#f9fafb;
    --text:#111827;
    --muted:#6b7280;
    --badge:#e5e7eb;
    --border:#d1d5db;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{
    margin:0;
    font-family:"Inter",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    background:radial-gradient(circle at top left,#1f2937,#020617);
    color:var(--text);
    min-height:100vh;
  }
  body.theme-light{
    background:radial-gradient(circle at top left,#e5e7eb,#ffffff);
  }
  header{
    position:fixed;top:0;left:0;right:0;z-index:20;
    backdrop-filter:blur(14px);
    background:linear-gradient(90deg,rgba(15,23,42,.95),rgba(15,23,42,.85));
    border-bottom:1px solid rgba(148,163,184,.3);
  }
  body.theme-light header{
    background:linear-gradient(90deg,rgba(243,244,246,.98),rgba(249,250,251,.94));
    border-bottom-color:rgba(209,213,219,.8);
  }
  header .inner{
    max-width:1280px;margin:0 auto;padding:16px 20px;
    display:flex;align-items:center;gap:14px;
  }
  h1{
    font-size:18px;letter-spacing:.02em;
  }
  .tagline{
    font-size:12px;color:var(--muted)
  }
  .logo-circle{
    width:40px;height:40px;border-radius:999px;
    display:grid;place-items:center;
    background:radial-gradient(circle at 30% 30%,#4f46e5,#0ea5e9);
    box-shadow:0 10px 25px rgba(59,130,246,.5);
    color:#fff;font-weight:700;font-size:18px;
  }
  .head-right{
    margin-left:auto;display:flex;align-items:center;gap:10px;
  }
  .theme-toggle{
    border:1px solid rgba(148,163,184,.5);
    background:rgba(15,23,42,.4);
    border-radius:999px;
    padding:6px 10px;
    display:flex;align-items:center;gap:8px;
    font-size:12px;color:var(--muted);cursor:pointer;
  }
  body.theme-light .theme-toggle{
    background:rgba(255,255,255,.9);
  }
  .user-pill{
    display:flex;align-items:center;gap:8px;
    padding:6px 10px;border-radius:999px;
    background:rgba(15,23,42,.8);
    border:1px solid rgba(148,163,184,.5);
    font-size:12px;
  }
  body.theme-light .user-pill{
    background:#ffffff;border-color:#e5e7eb;
  }
  .user-pill img{
    width:26px;height:26px;border-radius:50%;
    object-fit:cover;border:2px solid rgba(148,163,184,.7);
  }
  .user-pill span{max-width:140px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  main{
    max-width:1280px;margin:0 auto;padding:calc(var(--headH) + 16px) 20px 24px;
    display:flex;flex-direction:column;gap:18px;
  }
  .wrap{
    display:flex;gap:16px;align-items:flex-start;
  }
  .col-main{flex:3;display:flex;flex-direction:column;gap:16px}
  .col-side{flex:2;display:flex;flex-direction:column;gap:16px}
  .panel{
    background:linear-gradient(135deg,rgba(15,23,42,.96),rgba(15,23,42,.88));
    border-radius:var(--radius);
    border:1px solid rgba(148,163,184,.3);
    box-shadow:var(--shadow);
    padding:16px;
  }
  body.theme-light .panel{
    background:linear-gradient(135deg,#ffffff,#f9fafb);
    border-color:#e5e7eb;
  }
  .panel-fill{min-height:220px}
  .panel-header{
    display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;
  }
  .panel-header h2{
    font-size:16px;display:flex;align-items:center;gap:8px;
  }
  .panel-header h2 i{
    font-size:14px;color:var(--primary);
  }
  .panel-header small{color:var(--muted);font-size:12px}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .row-right{margin-left:auto;display:flex;gap:8px;align-items:center}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
  .filters{
    display:grid;
    grid-template-columns:1.2fr 1fr 1fr 1fr .9fr 1fr auto auto;
    gap:10px
  }

/* responsividade filtros */
@media (max-width: 1200px){
  .filters{
    grid-template-columns:repeat(4,minmax(0,1fr));
  }
}
@media (max-width: 900px){
  .filters{
    grid-template-columns:repeat(2,minmax(0,1fr));
  }
}
@media (max-width: 600px){
  .filters{
    grid-template-columns:1fr;
  }
  .filters > *{
    min-width:0;
  }
}
  input,select,textarea{
    width:100%;padding:10px 12px;border-radius:12px;
    border:1px solid var(--border);background:#0f1319;color:var(--text);
    outline:none;font-size:14px
  }
  body.theme-light input,
  body.theme-light select,
  body.theme-light textarea{
    background:#ffffff;
  }

  .table-wrap{
    flex:1;min-height:240px;overflow:auto;
    border-radius:12px;border:1px solid var(--border);
    background:var(--panel-2)
  }
  /* expansor até a margem do card/painel */
  .table-wrap.edge{margin:0 -16px;border-left:none;border-right:none;border-radius:0}
  table{width:100%;border-collapse:collapse}
  thead th{
    text-align:left;padding:12px;font-size:13px;
    letter-spacing:.02em;text-transform:uppercase;
    color:var(--muted);border-bottom:1px solid var(--border);
    background:rgba(15,23,42,.9);position:sticky;top:0;z-index:1
  }
  body.theme-light thead th{
    background:#f3f4f6;
  }
  thead th .th-label{
    display:flex;align-items:center;gap:4px;cursor:pointer;
  }
  thead th .sort-icon{
    font-size:11px;opacity:.4;
  }
  tbody td{
    padding:12px;border-bottom:1px solid var(--border);
    vertical-align:middle;font-size:14px
  }
  tbody tr:hover{
    background:rgba(255,255,255,.02)
  }
  body.theme-light tbody tr:hover{
    background:rgba(15,23,42,.04)
  }

  /* destaque visual para pendências com retomar_em */
  .row-pendente-vencida{
    border-left:4px solid var(--danger);
    background:rgba(255,93,93,.06);
  }
  .row-pendente-hoje{
    border-left:4px solid var(--warning);
    background:rgba(255,191,71,.06);
  }
  body.theme-light .row-pendente-vencida{
    background:rgba(255,93,93,.10);
  }
  body.theme-light .row-pendente-hoje{
    background:rgba(255,191,71,.14);
  }

  .badge{
    display:inline-flex;align-items:center;gap:6px;
    padding:6px 10px;border-radius:999px;
    background:var(--badge);color:var(--muted);
    font-size:11px;text-transform:uppercase;letter-spacing:.06em;
  }
  .badge i{font-size:10px}
  .badge.sla-ok{color:var(--success);background:rgba(34,197,94,.12);border:1px solid rgba(34,197,94,.4)}
  .badge.sla-risk{color:var(--warning);background:rgba(234,179,8,.18);border:1px solid rgba(234,179,8,.5)}
  .badge.sla-late{color:var(--danger);background:rgba(248,113,113,.18);border:1px solid rgba(248,113,113,.5)}
  body.theme-light .badge{
    background:#e5e7eb;color:#4b5563;
  }
  .badge.prio-alta{background:rgba(248,113,113,.16);color:#fecaca;border:1px solid rgba(248,113,113,.6)}
  .badge.prio-media{background:rgba(251,191,36,.18);color:#facc15;border:1px solid rgba(251,191,36,.6)}
  .badge.prio-baixa{background:rgba(52,211,153,.16);color:#6ee7b7;border:1px solid rgba(52,211,153,.6)}
  .badge.status-aberto{background:rgba(56,189,248,.14);color:#7dd3fc;border:1px solid rgba(56,189,248,.7)}
  .badge.status-tratativa{background:rgba(129,140,248,.16);color:#a5b4fc;border:1px solid rgba(129,140,248,.7)}
  .badge.status-pendente{background:rgba(251,191,36,.16);color:#fcd34d;border:1px solid rgba(251,191,36,.7)}
  .badge.status-encerrado{background:rgba(34,197,94,.16);color:#bbf7d0;border:1px solid rgba(34,197,94,.7)}

  .badge.sak-badge{
    background:linear-gradient(135deg,rgba(124,58,237,.16),rgba(59,130,246,.16));
    border:1px solid rgba(129,140,248,.8);
    color:#e0e7ff;font-weight:500;
  }
  .badge.frota-badge{
    background:linear-gradient(135deg,rgba(34,197,94,.16),rgba(52,211,153,.18));
    border:1px solid rgba(16,185,129,.7);
    color:#bbf7d0;font-weight:500;
  }

  .btn{
    border:none;border-radius:999px;
    padding:8px 14px;font-size:13px;
    background:rgba(148,163,184,.2);color:var(--text);
    display:inline-flex;align-items:center;gap:6px;
    cursor:pointer;
  }
  .btn-primary{
    background:linear-gradient(135deg,#4f46e5,#2563eb);
    color:#fff;font-weight:500;
    box-shadow:0 10px 25px rgba(37,99,235,.5);
  }
  .btn-primary-outline{
    background:transparent;border:1px solid rgba(148,163,184,.6);
    color:var(--muted)
  }
  .btn-ghost{
    border-radius:999px;border:1px solid rgba(148,163,184,.4);
    background:transparent;color:var(--muted);
    padding:6px 10px;font-size:12px;
  }
  .btn-ghost i{font-size:12px}
  .btn-danger{
    background:rgba(248,113,113,.12);color:#fecaca;
    border:1px solid rgba(248,113,113,.7);
  }
  .btn-warning{
    background:rgba(251,191,36,.18);color:#facc15;
    border:1px solid rgba(251,191,36,.7);
  }
  .btn-icon{
    padding:6px;border-radius:999px;
    width:28px;height:28px;display:grid;place-items:center;
  }

  .spacer{flex:1}
  .muted{color:var(--muted);font-size:12px}
  .badge-pill{
    border-radius:999px;padding:4px 8px;font-size:11px;
    border:1px solid rgba(148,163,184,.4);
    color:var(--muted);
  }
  .pill-danger{border-color:rgba(248,113,113,.6);color:#fecaca}
  .pill-warning{border-color:rgba(234,179,8,.6);color:#facc15}
  .pill-ok{border-color:rgba(34,197,94,.6);color:#bbf7d0}

  .table-actions{white-space:nowrap;display:flex;gap:6px;align-items:center}
  .badge-unread{
    display:inline-flex;align-items:center;justify-content:center;
    min-width:18px;height:18px;border-radius:999px;
    background:#f97316;color:#fff;font-size:11px;font-weight:600;
    margin-left:4px;
  }

  .kpi-grid{
    display:grid;grid-template-columns:repeat(4,1fr);gap:12px;
  }
  @media (max-width:960px){
    .wrap{flex-direction:column}
    .kpi-grid{grid-template-columns:repeat(2,1fr)}
  }
  @media (max-width:640px){
    .kpi-grid{grid-template-columns:1fr}
  }
  .kpi-card{
    padding:12px 14px;border-radius:14px;
    background:radial-gradient(circle at top left,rgba(15,23,42,.9),rgba(15,23,42,.96));
    border:1px solid rgba(148,163,184,.3);
    box-shadow:0 8px 20px rgba(15,23,42,.7);
    font-size:13px;
  }
  body.theme-light .kpi-card{
    background:radial-gradient(circle at top left,#ffffff,#f9fafb);
    border-color:#e5e7eb;
    box-shadow:0 8px 20px rgba(15,23,42,.08);
  }
  .kpi-card small{color:var(--muted)} 
  .kpi-card strong{display:block;font-size:26px;margin-top:8px}
  .kpi-sub{font-size:12px;color:var(--muted);margin-top:6px}
  .charts{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
  @media (max-width:1100px){ .charts{grid-template-columns:1fr} }

  /* DM (chat usuários) */
  .dm-launcher{position:fixed;right:18px;bottom:18px;z-index:50}
  .dm-fab{
    width:56px;height:56px;border-radius:50%;
    display:grid;place-items:center;font-size:20px;
    background:var(--primary);color:#fff;
    box-shadow:0 12px 24px rgba(79,140,255,.35)
  }
  .dm-fab .badge-unread
  {position:absolute;top:-4px;right:-4px}
  .dm-panel{
    position:fixed;right:18px;bottom:86px;
    width:340px;max-height:520px;
    background:var(--panel);border-radius:16px;
    border:1px solid rgba(148,163,184,.4);
    box-shadow:0 18px 45px rgba(15,23,42,.9);
    display:flex;flex-direction:column;overflow:hidden;
    z-index:49;
  }
  .dm-header{
    padding:10px 12px;border-bottom:1px solid var(--border);
    display:flex;align-items:center;gap:8px;
  }
  .dm-header h3{font-size:14px;margin:0}
  .dm-body{display:flex;flex:1;min-height:260px}
  .dm-users{
    width:38%;border-right:1px solid var(--border);
    padding:6px;overflow:auto;font-size:13px;
  }
  .dm-user{
    padding:6px 8px;border-radius:10px;
    display:flex;align-items:center;gap:6px;
    cursor:pointer;font-size:13px;
  }
  .dm-user:hover{background:rgba(148,163,184,.14)}
  .dm-user.active{background:rgba(59,130,246,.18);color:#bfdbfe}
  .dm-user span{
    white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    flex:1;
  }
  .dm-chat{
    flex:1;display:flex;flex-direction:column;
  }
  .dm-messages{
    flex:1;overflow:auto;padding:8px 10px;
    font-size:13px;
  }
  .dm-bubble{
    max-width:80%;padding:7px 10px;border-radius:12px;
    margin-bottom:6px;
  }
  .dm-bubble.me{
    margin-left:auto;
    background:rgba(59,130,246,.2);
    border:1px solid rgba(59,130,246,.5);
  }
  .dm-bubble.other{
    background:rgba(15,23,42,.8);
    border:1px solid rgba(148,163,184,.4);
  }
  body.theme-light .dm-bubble.other{
    background:#f3f4f6;border-color:#d1d5db;
  }
  .dm-meta{font-size:11px;color:var(--muted);margin-top:2px}
  .dm-input{
    border-top:1px solid var(--border);
    padding:8px;
    display:flex;gap:6px;
  }
  .dm-input input{
    flex:1;
    border-radius:999px;
  }
  .dm-input button{
    border-radius:999px;
  }

  .hidden{display:none !important}
  .space{height:8px}
  .divider{
    height:1px;background:linear-gradient(90deg,transparent,rgba(148,163,184,.4),transparent);
    margin:10px 0;
  }
  .chip-group{
    display:flex;flex-wrap:wrap;gap:6px;margin-top:6px;
  }
  .chip{
    border-radius:999px;padding:4px 8px;font-size:11px;
    border:1px solid rgba(148,163,184,.5);
    color:var(--muted);cursor:pointer;
  }
  .chip.active{
    background:rgba(59,130,246,.18);color:#bfdbfe;
    border-color:rgba(59,130,246,.8);
  }

  .toast{
    position:fixed;bottom:16px;left:50%;transform:translateX(-50%);
    background:rgba(15,23,42,.92);color:#e5e7eb;
    padding:8px 14px;border-radius:999px;
    font-size:13px;border:1px solid rgba(148,163,184,.5);
    box-shadow:0 12px 30px rgba(15,23,42,.9);z-index:60;
  }
  body.theme-light .toast{
    background:#111827;color:#e5e7eb;
  }

  .badge-pending{
    border-radius:999px;
    padding:4px 8px;
    font-size:11px;
    border:1px dashed rgba(234,179,8,.8);
    color:#facc15;
    display:inline-flex;align-items:center;gap:4px;
  }

  .footer-brand{
    margin-top:12px;
    text-align:center;
    font-size:11px;
    color:var(--muted);
    opacity:.8;
  }
  .footer-brand span{
    font-style:italic;
  }
</style>
</head>
<body class="theme-dark">

<header>
  <div class="inner">
    <div class="logo-circle">CI</div>
    <div>
      <h1>Controle Interno de Solicitações</h1>
      <div class="tagline">Visão unificada de demandas, SLA e tratativas internas</div>
    </div>
    <div class="head-right">
      <button id="btnTheme" class="theme-toggle">
        <i class="fa fa-moon"></i><span>Tema</span>
      </button>
      <div class="user-pill">
        <img src="https://api.dicebear.com/7.x/identicon/svg?seed=CI" alt="avatar">
        <span id="currentUserName">Usuário</span>
      </div>
    </div>
  </div>
</header>

<!-- LISTA PRINCIPAL -->
<main id="mainPage" class="wrap">
  <div class="col-main">
    <section class="panel panel-fill">
      <div class="panel-header">
        <div>
          <h2><i class="fa fa-list-check"></i> Solicitações em aberto</h2>
          <small>Controle centralizado de tickets internos</small>
        </div>
        <div class="row-right">
          <button class="btn btn-primary" id="btnNew"><i class="fa fa-plus"></i> Nova solicitação</button>
          <button class="btn btn-primary-outline" id="btnGoClosed"><i class="fa fa-check-double"></i> Encerradas</button>
        </div>
      </div>

      <!-- Filtros -->
      <div class="filters">
        <div>
          <label>Busca geral</label>
          <input id="fSearch" placeholder="Buscar por solicitante, assunto, código, transportadora...">
        </div>
        <div>
          <label>Status</label>
          <select id="fStatus">
            <option value="">Todos</option>
            <option>Aberto</option>
            <option>Em tratativa</option>
            <option>Pendente</option>
            <option>Encerrado</option>
          </select>
        </div>
        <div>
          <label>Prioridade</label>
          <select id="fPrio">
            <option value="">Todas</option>
            <option>Alta</option>
            <option>Média</option>
            <option>Baixa</option>
          </select>
        </div>
        <div>
          <label>Categoria</label>
          <select id="fCategoria">
            <option value="">Todas</option>
            <option>Geral</option>
            <option>SAK</option>
            <option>TI</option>
            <option>Frota - Transportadora</option>
            <option>Outros</option>
          </select>
        </div>
        <div>
          <label>SLA</label>
          <select id="fSLA">
            <option value="">Todos</option>
            <option value="ok">No prazo</option>
            <option value="risk">Risco</option>
            <option value="late">Vencido</option>
          </select>
        </div>
        <div>
          <label>Pendência</label>
          <select id="fPend">
            <option value="">Todas</option>
            <option value="pend">Somente pendentes</option>
            <option value="due">Pendentes vencidos</option>
          </select>
        </div>
        <div style="align-self:flex-end">
          <label>&nbsp;</label>
          <label style="font-size:12px;display:flex;align-items:center;gap:6px">
            <input type="checkbox" id="fMine" style="width:auto"> Só minhas
          </label>
        </div>
        <div style="align-self:flex-end">
          <label>&nbsp;</label>
          <label style="font-size:12px;display:flex;align-items:center;gap:6px">
            <input type="checkbox" id="fHideClosed" style="width:auto"> Ocultar encerradas (quando sem busca)
          </label>
        </div>
      </div>

      <div class="space"></div>

      <!-- Tabela -->
      <div class="table-wrap edge">
        <table>
          <thead>
            <tr>
              <th><div class="th-label" data-sort="abertoEm"><span>Abertura</span><i class="fa fa-sort sort-icon"></i></div></th>
              <th><div class="th-label" data-sort="solicitante"><span>Solicitante</span><i class="fa fa-sort sort-icon"></i></div></th>
              <th><div class="th-label" data-sort="assunto"><span>Assunto</span><i class="fa fa-sort sort-icon"></i></div></th>
              <th><div class="th-label" data-sort="codigo"><span>Código</span><i class="fa fa-sort sort-icon"></i></div></th>
              <th><div class="th-label" data-sort="categoria"><span>Categoria</span><i class="fa fa-sort sort-icon"></i></div></th>
              <th><div class="th-label" data-sort="canal"><span>Canal</span><i class="fa fa-sort sort-icon"></i></div></th>
              <th><div class="th-label" data-sort="prioridade"><span>Prioridade</span><i class="fa fa-sort sort-icon"></i></div></th>
              <th><div class="th-label" data-sort="status"><span>Status</span><i class="fa fa-sort sort-icon"></i></div></th>
              <th><div class="th-label" data-sort="prazo"><span>SLA</span><i class="fa fa-sort sort-icon"></i></div></th>
              <th><div class="th-label" data-sort="responsavel"><span>Responsável</span><i class="fa fa-sort sort-icon"></i></div></th>
              <th style="width:140px">Ações</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <!-- Paginação -->
      <div id="pager" class="row" style="margin-top:8px;align-items:center;justify-content:space-between;font-size:13px"></div>

      <div class="badge" style="margin-top:10px">SLA por prioridade: Alta 1 dia • Média 3 dias • Baixa 5 dias (dias úteis)</div>
    </section>
  </div>

  <!-- LADO DIREITO: KPIs / Gráficos -->
  <div class="col-side">
    <section class="panel">
      <div class="panel-header">
        <div>
          <h2><i class="fa fa-gauge-high"></i> Visão geral</h2>
          <small>Métricas do mês por status e cumprimento de SLA</small>
        </div>
        <div>
          <label style="font-size:11px;color:var(--muted)">Mês de referência</label>
          <input type="month" id="kpiMonth" style="max-width:140px;font-size:12px">
        </div>
      </div>

      <div class="kpi-grid">
        <div class="kpi-card"><small>Aberto (abertos no mês)</small><strong id="mKpiAberto">0</strong></div>
        <div class="kpi-card"><small>Em tratativa (abertos no mês)</small><strong id="mKpiTratativa">0</strong></div>
        <div class="kpi-card"><small>Pendente (abertos no mês)</small><strong id="mKpiPendente">0</strong></div>
        <div class="kpi-card"><small>Encerrado (abertos no mês)</small><strong id="mKpiEncerrado">0</strong></div>
      </div>

      <div class="space"></div>
      <div class="kpi-grid">
        <div class="kpi-card"><small>Concluídos no mês</small><strong id="mKpiFechados">0</strong><div class="kpi-sub" id="mKpiFechadosBase">com SLA: 0</div></div>
        <div class="kpi-card"><small>% concluídos no prazo</small><strong id="mKpiPrazo">0%</strong><div class="kpi-sub" id="mKpiQtdPrazo">0 de 0</div></div>
        <div class="kpi-card"><small>% concluídos vencidos</small><strong id="mKpiVenc">0%</strong><div class="kpi-sub" id="mKpiQtdVenc">0 de 0</div></div>
        <div class="kpi-card"><small>Mês selecionado</small><strong id="mKpiMesLabel">—</strong></div>
      </div>

      <div class="space"></div>
      <div class="charts">
        <div class="panel" style="padding:10px">
          <div style="font-size:12px;color:var(--muted);margin-bottom:4px">Distribuição por categoria</div>
          <canvas id="chartCategoria" height="140"></canvas>
        </div>
        <div class="panel" style="padding:10px">
          <div style="font-size:12px;color:var(--muted);margin-bottom:4px">Distribuição por canal / transportadora</div>
          <canvas id="chartCanal" height="140"></canvas>
        </div>
      </div>

      <div class="footer-brand">
        <span>Desenvolvido por Bruno Ferreira da Cruz</span>
      </div>
    </section>
  </div>
</main>

<!-- ENCERRADOS -->
<main id="closedPage" class="wrap hidden">
  <section class="panel panel-fill">
    <div class="row" style="align-items:center;margin-bottom:10px">
      <h2 style="margin:0;font-size:18px">Solicitações Encerradas</h2>
      <div style="margin-left:auto;display:flex;gap:10px;align-items:center">
        <input id="fClosed" placeholder="Buscar nas encerradas...">
        <button id="btnBackList" class="btn btn-primary-outline"><i class="fa fa-arrow-left"></i> Voltar</button>
      </div>
    </div>
    <div class="table-wrap edge">
      <table>
        <thead>
          <tr>
            <th>Abertura</th>
            <th>Solicitante</th>
            <th>Assunto</th>
            <th>Código</th>
            <th>Categoria</th>
            <th>Canal</th>
            <th>Prioridade</th>
            <th>Status</th>
            <th>SLA</th>
            <th>Responsável</th>
            <th>Encerrado em</th>
          </tr>
        </thead>
        <tbody id="tbodyClosed"></tbody>
      </table>
    </div>
  </section>
</main>

<!-- MODAL CADASTRO / EDIÇÃO -->
<div id="modal" class="hidden" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:40;background:rgba(15,23,42,.72);backdrop-filter:blur(10px)">
  <div style="width:880px;max-width:96%;max-height:90vh;overflow:auto;border-radius:18px;background:var(--panel);border:1px solid var(--border);box-shadow:0 18px 45px rgba(15,23,42,.95);padding:16px 18px">
    <div class="row" style="align-items:center;margin-bottom:8px">
      <h2 style="font-size:17px;display:flex;align-items:center;gap:8px"><i class="fa fa-pen-to-square" style="color:var(--primary)"></i> <span id="modalTitle">Nova solicitação</span></h2>
      <div class="row-right">
        <button id="btnExportChat" class="btn btn-ghost"><i class="fa fa-file-export"></i> Exportar histórico</button>
        <button id="btnCloseModal" class="btn btn-ghost"><i class="fa fa-times"></i></button>
      </div>
    </div>
    <div class="divider"></div>

    <div class="row" style="margin-bottom:10px">
      <div style="flex:1;min-width:200px">
        <label>Solicitante *</label>
        <input id="inpSolicitante" placeholder="Nome de quem solicitou">
      </div>
      <div style="flex:1;min-width:200px">
        <label>Responsável</label>
        <input id="inpResponsavel" placeholder="Quem está tratando (opcional)">
      </div>
      <div style="width:160px">
        <label>Canal</label>
        <select id="selCanal">
          <option value="">Selecione...</option>
          <option>Email</option>
          <option>Telefone</option>
          <option>WhatsApp</option>
          <option>Portal interno</option>
          <option>Presencial</option>
          <option>Transportadora</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-bottom:10px">
      <div style="flex:2;min-width:260px">
        <label>Assunto *</label>
        <input id="inpAssunto" placeholder="Resumo da solicitação">
      </div>
      <div style="flex:1;min-width:180px">
        <label>Código / Protocolo *</label>
        <input id="inpCodigo" placeholder="NF, chamado, pedido...">
      </div>
      <div style="width:140px">
        <label>Prioridade *</label>
        <select id="selPrioridade">
          <option value="">Selecione...</option>
          <option>Alta</option>
          <option>Média</option>
          <option>Baixa</option>
        </select>
      </div>
      <div style="width:190px">
        <label>Categoria *</label>
        <select id="selCategoria">
          <option value="">Selecione...</option>
          <option>Geral</option>
          <option>SAK</option>
          <option>TI</option>
          <option>Frota - Transportadora</option>
          <option>Outros</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-bottom:10px">
      <div style="width:160px">
        <label>Status *</label>
        <select id="selStatus">
          <option>Aberto</option>
          <option>Em tratativa</option>
          <option>Pendente</option>
          <option>Encerrado</option>
        </select>
      </div>
      <div style="width:160px">
        <label>Prazo (data limite / SLA)</label>
        <input type="date" id="inpPrazo">
      </div>
      <div style="flex:1;min-width:200px">
        <label>Transportadora (quando Frota)</label>
        <input id="inpTransportadora" placeholder="Nome da transportadora (se aplicável)">
      </div>
      <div style="width:190px">
        <label>Retomar em (quando Pendente)</label>
        <input type="date" id="inpRetomar">
      </div>
    </div>

    <div class="row" style="margin-bottom:10px">
      <div style="flex:1">
        <label>Descrição detalhada *</label>
        <textarea id="inpDescricao" rows="4" placeholder="Descreva a situação, contexto, impactos e qualquer informação relevante"></textarea>
      </div>
    </div>

    <div class="divider"></div>

    <!-- Chat histórico -->
    <div class="row" style="align-items:flex-start">
      <div style="flex:2;min-width:260px">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px">
          <label>Histórico / Comentários</label>
          <span class="muted" style="font-size:11px">Use para registrar tratativas e decisões</span>
        </div>
        <div id="history" style="border-radius:12px;border:1px solid var(--border);padding:8px 10px;max-height:220px;overflow:auto;background:var(--panel-2);font-size:13px"></div>
        <div style="margin-top:6px;display:flex;gap:6px">
          <input id="inpChat" placeholder="Adicionar atualização ao histórico...">
          <button id="btnAddChat" class="btn btn-primary"><i class="fa fa-paper-plane"></i></button>
        </div>
      </div>
      <div style="flex:1;min-width:220px">
        <label>Resumo / Insights</label>
        <div id="summaryBox" style="border-radius:12px;border:1px dashed rgba(148,163,184,.6);padding:8px 10px;font-size:13px;color:var(--muted);background:linear-gradient(135deg,rgba(15,23,42,.9),rgba(15,23,42,.96))">
          <div style="font-size:12px;margin-bottom:4px"><i class="fa fa-wand-magic-sparkles"></i> <strong>Resumo rápido</strong></div>
          <div id="summaryContent">Digite uma descrição e adicione comentários para gerar um resumo automático da tratativa.</div>
        </div>
      </div>
    </div>

    <div class="divider"></div>

    <div class="row" style="margin-top:8px">
      <span class="muted">Campos com * são obrigatórios</span>
      <div class="spacer"></div>
      <button id="btnDelete" class="btn btn-danger hidden"><i class="fa fa-trash"></i> Excluir</button>
      <button id="btnSave" class="btn btn-primary"><i class="fa fa-save"></i> Salvar</button>
    </div>
  </div>
</div>

<!-- DM FLOATING (entre usuários) -->
<div class="dm-launcher">
  <button id="btnDmToggle" class="dm-fab" title="Mensagens privadas">
    <i class="fa fa-comments"></i>
    <span id="badgeDm" class="badge-unread hidden">0</span>
  </button>
  <div id="dmPanel" class="dm-panel hidden">
    <div class="dm-header">
      <i class="fa fa-user-group" style="font-size:14px;color:var(--primary)"></i>
      <h3>Mensagens internas</h3>
      <div class="spacer"></div>
      <button id="btnCloseDm" class="btn-ghost btn-icon"><i class="fa fa-times"></i></button>
    </div>
    <div class="dm-body">
      <div class="dm-users" id="dmUsers"></div>
      <div class="dm-chat">
        <div id="dmMessages" class="dm-messages"></div>
        <div class="dm-input">
          <input id="dmInput" placeholder="Digite uma mensagem...">
          <button id="dmSend" class="btn btn-primary btn-icon"><i class="fa fa-paper-plane"></i></button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast hidden"></div>

<script>
/* ===== Layout ===== */
function setHeadH(){
  const h=document.querySelector('header');
  const v=h? h.getBoundingClientRect().height : 96;
  document.documentElement.style.setProperty('--headH', Math.round(v)+'px')
}
window.addEventListener('load', setHeadH); 
window.addEventListener('resize', setHeadH);

/* ===== Helpers ===== */
const qs=s=>document.querySelector(s);
const qsa=(s,el)=>Array.prototype.slice.call((el||document).querySelectorAll(s));
const fmtDate=ts=>new Date(ts).toLocaleString('pt-BR');
const uid = ()=>Math.random().toString(36).slice(2,8).toUpperCase();
function escapeHtml(str){
  if(!str) return '';
  return str.replace(/[&<>"']/g,function(ch){
    const map={ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'};
    return map[ch]||ch;
  });
}
function toDateInputValue(d){
  if(!d) return '';
  const z=new Date(d), off=z.getTimezoneOffset();
  const local=new Date(z.getTime() - (off*60*1000));
  return local.toISOString().slice(0,10);
}
function businessAdd(date, days){
  let d=new Date(date);
  let added=0;
  while(added<days){
    d.setDate(d.getDate()+1);
    const day=d.getDay();
    if(day!==0 && day!==6) added++;
  }
  return d;
}
function isBusinessDay(date){
  const day=date.getDay();
  return day!==0 && day!==6;
}
function addBusinessDays(startDate, days){
  let d=new Date(startDate);
  let added=0;
  while(added<days){
    d.setDate(d.getDate()+1);
    if(isBusinessDay(d)) added++;
  }
  return d;
}
function today(){ return new Date(); }
const ym=d=>d.toISOString().slice(0,7);
const startOfDay=dt=>{var d=new Date(dt);d.setHours(0,0,0,0);return d}
const today0=()=>{var d=new Date();d.setHours(0,0,0,0);return d}
var DEFAULT_EMAIL_DOMAIN="koerich.com.br";

/* sort + paginação estado */
var sortField='default', sortDir='desc';
var pageSize=12, currentPage=1;

/* ===== Tema / usuário fake (até ter login) ===== */
function loadTheme(){
  const t=localStorage.getItem('ci_theme')||'theme-dark';
  document.body.className=t;
}
function toggleTheme(){
  const cur=document.body.classList.contains('theme-light')?'theme-light':'theme-dark';
  const next=cur==='theme-light'?'theme-dark':'theme-light';
  document.body.classList.remove(cur);
  document.body.classList.add(next);
  localStorage.setItem('ci_theme',next);
}
loadTheme();

function fakeUsers(){
  return [
    {id:'u1',name:'Bruno Ferreira',email:'bruno@'+DEFAULT_EMAIL_DOMAIN,role:'admin'},
    {id:'u2',name:'Operador Logística',email:'logistica@'+DEFAULT_EMAIL_DOMAIN,role:'user'},
    {id:'u3',name:'Atendente SAC',email:'sac@'+DEFAULT_EMAIL_DOMAIN,role:'user'},
  ];
}
function currentUser(){
  const raw=localStorage.getItem('ci_user');
  if(raw){
    try{return JSON.parse(raw)}catch(e){}
  }
  const u=fakeUsers()[0];
  localStorage.setItem('ci_user',JSON.stringify(u));
  return u;
}
function setUser(u){
  localStorage.setItem('ci_user',JSON.stringify(u));
  renderUserPill();
}
function renderUserPill(){
  const me=currentUser();
  if(!me) return;
  qs('#currentUserName').textContent=me.name;
}
renderUserPill();

/* ===== Supabase client ===== */
let supa=null;
let HAS_CANAL=false;
function initSupabase(){
  if(typeof SUPABASE_URL==='string' && typeof SUPABASE_ANON_KEY==='string'){
    supa=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);
  }else{
    console.warn('config.js sem SUPABASE_URL / SUPABASE_ANON_KEY');
  }
}
initSupabase();
function supaReady(){return !!supa;}
function toast(msg,ms){
  ms=ms||3500;
  const el=qs('#toast');
  el.textContent=msg;
  el.classList.remove('hidden');
  setTimeout(()=>el.classList.add('hidden'),ms);
}

/* ===== Dados principais (tickets) ===== */
let data=[];
let lastReadMap={}; // ticketId -> timestamp
let charts={cat:null,canal:null};

/* SLA helpers */
function slaStatus(prazo, ticket){
  if(!prazo) return {code:'none',label:'Sem SLA'};
  const hoje=today0();
  const limit=startOfDay(prazo);
  const diff=(limit-hoje)/(1000*60*60*24);
  if(ticket && ticket.status==='Encerrado'){
    const closedAt=getClosedAt(ticket);
    if(!closedAt) return {code:'ok',label:'Encerrado'};
    const closedDay=startOfDay(closedAt);
    if(closedDay<=limit) return {code:'ok',label:'Cumprido'};
    return {code:'late',label:'Encerrado após prazo'};
  }
  if(diff<0) return {code:'late',label:'Vencido'};
  if(diff<=1) return {code:'risk',label:'Risco'};
  return {code:'ok',label:'No prazo'};
}
function slaTooltip(prazo, ticket){
  if(!prazo) return '';
  const dt=new Date(prazo);
  const base='Prazo: '+dt.toLocaleDateString('pt-BR');
  const st=slaStatus(prazo,ticket).code;
  if(st==='late') return base+' (já vencido)';
  if(st==='risk') return base+' (vence em breve)';
  if(st==='ok') return base+' (no prazo)';
  return base;
}

/* badges */
function prioBadge(p){
  if(p==='Alta') return '<span class="badge prio-alta"><i class="fa fa-flag"></i> Alta</span>';
  if(p==='Média')return '<span class="badge prio-media"><i class="fa fa-flag"></i> Média</span>';
  if(p==='Baixa')return '<span class="badge prio-baixa"><i class="fa fa-flag"></i> Baixa</span>';
  return '<span class="badge">'+(p||'-')+'</span>';
}
function statusBadge(s){
  if(s==='Aberto') return '<span class="badge status-aberto"><i class="fa fa-circle"></i> Aberto</span>';
  if(s==='Em tratativa') return '<span class="badge status-tratativa"><i class="fa fa-spinner"></i> Em tratativa</span>';
  if(s==='Pendente') return '<span class="badge status-pendente"><i class="fa fa-pause-circle"></i> Pendente</span>';
  if(s==='Encerrado') return '<span class="badge status-encerrado"><i class="fa fa-check-circle"></i> Encerrado</span>';
  return '<span class="badge">'+(s||'-')+'</span>';
}

/* Abrir / fechar páginas */
function showMain(){ qs('#mainPage').classList.remove('hidden'); qs('#closedPage').classList.add('hidden'); }
function showClosed(){ qs('#mainPage').classList.add('hidden'); qs('#closedPage').classList.remove('hidden'); renderClosedPage(); }

/* Local storage fallback (caso Supabase indisponível) */
const LS_KEY='ci_tickets';

function loadLocal(){
  try{
    const raw=localStorage.getItem(LS_KEY);
    data=raw? JSON.parse(raw):[];
  }catch(e){
    console.error(e);data=[];
  }
}
function saveLocal(){
  try{
    localStorage.setItem(LS_KEY,JSON.stringify(data));
  }catch(e){
    console.error(e);
  }
}

/* Supabase: tickets */
async function supaLoadTickets(){
  if(!supaReady()) { loadLocal(); renderAll(); return; }
  let r=await supa.from('tickets').select('*').order('abertoEm',{ascending:false});
  if(r.error){
    console.error(r.error); toast('Erro ao carregar tickets (usando localStorage)');
    loadLocal(); renderAll(); return;
  }
  data=r.data||[];
  var col = (data[0] && ('canal' in data[0]));
  HAS_CANAL = !!col;
  renderAll();
}
async function supaUpsertTicket(rec){
  if(!supaReady()) return;
  const payload={...rec};
  if (HAS_CANAL) payload.canal = rec.canal || null; // só envia se a coluna existir
  var r=await supa.from('tickets').upsert(payload); 
  if(r.error){console.error(r.error); toast('Sem permissão para salvar (RLS/policies?)')}
}
async function supaDeleteTicket(id){ if(!supaReady())return; var r=await supa.from('tickets').delete().eq('id',id); if(r.error){console.error(r.error); toast('Sem permissão para excluir')}}

/* Supabase: mensagens do ticket */
async function supaAddMessage(ticketId, text){
  if (!supaReady()) return;

  const { data: auth } = await supa.auth.getUser();
  const userId   = auth?.user?.id || null;
  const userName = (currentUser()?.name || '—');

  const { data: ins, error } = await supa
    .from('messages')
    .insert({
      ticket_id: ticketId,
      body: text,
      user: userName,
      user_id: userId
    })
    .select();

  if (error) {
    console.error(error);
    toast('Erro ao registrar histórico no Supabase');
    return;
  }
}
async function supaLoadMessages(ticketId){
  if (!supaReady()) return [];
  const { data, error } = await supa
    .from('messages')
    .select('id, body, user, created_at')
    .eq('ticket_id', ticketId)
    .order('created_at', { ascending: true });

  if (error) {
    console.error(error);
    return [];
  }
  return data || [];
}

/* Histórico: converte supa messages -> estrutura local (para render) */
function mapMessagesToHistorico(msgs){
  return msgs.map(m=>({
    at:new Date(m.created_at).getTime(),
    user:m.user||'—',
    text:m.body||''
  }));
}

/* find ticket */
function findTicket(id){ return data.find(d=>d.id===id); }

/* ===== Modal / edição ===== */
let editingId=null;

function openModal(){
  qs('#modal').classList.remove('hidden');
}
function closeModal(){
  qs('#modal').classList.add('hidden');
  editingId=null;
}

function fillForm(t){
  const me=currentUser();
  const isAdmin=(me && me.role==='admin');

  qs('#inpSolicitante').value=t.solicitante||'';
  qs('#inpResponsavel').value=t.responsavel||'';
  qs('#selCanal').value=t.canal||'';
  qs('#inpAssunto').value=t.assunto||'';
  qs('#inpCodigo').value=t.codigo||'';
  qs('#selPrioridade').value=t.prioridade||'';
  qs('#selCategoria').value=t.categoria||'';
  qs('#selStatus').value=t.status||'Aberto';
  qs('#inpPrazo').value= t.prazo ? toDateInputValue(t.prazo) : '';
  qs('#inpTransportadora').value=t.transportadora||'';
  qs('#inpRetomar').value=t.retomar_em ? toDateInputValue(t.retomar_em) : '';

  qs('#btnDelete').classList.toggle('hidden',!editingId || !isAdmin);

  // campos somente leitura para não-admin (exceto prioridade)
  const lockFields=['inpSolicitante','inpResponsavel','selCanal','inpAssunto','inpCodigo','selCategoria','selStatus','inpPrazo','inpTransportadora','inpRetomar'];
  lockFields.forEach(id=>{
    const el=qs('#'+id);
    if(!el) return;
    el.disabled=!isAdmin;
  });
  const prioEl=qs('#selPrioridade');
  if(prioEl) prioEl.disabled=false;

  renderHistory(t);
  qs('#modalTitle').textContent = editingId? 'Editar solicitação' : 'Nova solicitação';
  updateSummary(t);
}

function collectForm(){
  const me=currentUser();
  const isAdmin=(me && me.role==='admin');

  const solicitante=qs('#inpSolicitante').value.trim();
  const responsavel=qs('#inpResponsavel').value.trim();
  const canal=qs('#selCanal').value||'';
  const assunto=qs('#inpAssunto').value.trim();
  const codigo=qs('#inpCodigo').value.trim();
  const prioridade=qs('#selPrioridade').value;
  const categoria=qs('#selCategoria').value;
  const status=qs('#selStatus').value;
  const prazoStr=qs('#inpPrazo').value;
  const transportadora=qs('#inpTransportadora').value.trim();
  const retomarStr=qs('#inpRetomar').value;
  const descricao=qs('#inpDescricao').value.trim();

  if(!solicitante || !assunto || !codigo || !prioridade || !categoria || !status || !descricao){
    toast('Preencha todos os campos obrigatórios (*)');
    return null;
  }
  if(categoria==='Frota - Transportadora' && !transportadora){
    toast('Informe a transportadora para categoria "Frota - Transportadora"');
    return null;
  }

  let prazo=prazoStr? new Date(prazoStr).getTime():null;
  let retomar_em=retomarStr? new Date(retomarStr).getTime():null;

  // se prioridade for alta/média/baixa e não tiver prazo, sugere com base em dias úteis
  if(!prazo && prioridade){
    const base = new Date();
    const days = prioridade==='Alta'? 1 : prioridade==='Média'? 3 : 5;
    prazo = addBusinessDays(base, days).getTime();
  }

  const base={
    solicitante,
    responsavel,
    canal,
    assunto,
    codigo,
    prioridade,
    categoria,
    status,
    prazo,
    transportadora,
    retomar_em,
    descricao
  };
  if(editingId){
    const old=findTicket(editingId);
    return {...old,...base};
  }else{
    const me=currentUser()||{};
    return {
      id: uid(),
      abertoEm: Date.now(),
      historico:[],
      openedBy: me.id||null,
      ...base
    };
  }
}

/* histórico local + UI */
function renderHistory(t){
  const box=qs('#history');
  const hist=(t && t.historico)||[];
  if(!hist.length){
    box.innerHTML='<div class="muted">Nenhuma atualização registrada ainda.</div>';
    return;
  }
  box.innerHTML=hist.map(h=>{
    const dt=new Date(h.at).toLocaleString('pt-BR');
    return '<div style="margin-bottom:6px"><div><strong>'+escapeHtml(h.user||'')+'</strong> <span class="muted" style="font-size:11px">('+dt+')</span></div><div>'+escapeHtml(h.text||'')+'</div></div>'
  }).join('');
}
function addHistoryEntry(t, text){
  const me=currentUser();
  const entry={
    at:Date.now(),
    user: me? me.name : 'Usuário',
    text:text
  };
  t.historico = t.historico || [];
  t.historico.push(entry);
  renderHistory(t);
  updateSummary(t);
}

/* resumo simples (não-IA) com base na descrição + histórico */
function updateSummary(t){
  if(!t){
    qs('#summaryContent').textContent='Digite uma descrição e adicione comentários para gerar um resumo automático da tratativa.';
    return;
  }
  const partes=[];
  if(t.descricao){
    partes.push('Descrição: '+t.descricao);
  }
  if(t.historico && t.historico.length){
    const ult=t.historico[t.historico.length-1];
    partes.push('Última atualização por '+(ult.user||'')+' em '+new Date(ult.at).toLocaleString('pt-BR')+': '+(ult.text||''));
  }
  if(!partes.length){
    qs('#summaryContent').textContent='Sem informações suficientes para resumo.';
  }else{
    qs('#summaryContent').textContent=partes.join(' ');
  }
}

/* cadastrar / salvar */
async function saveTicket(){
  const rec=collectForm();
  if(!rec) return;

  if(editingId){
    const idx=data.findIndex(d=>d.id===editingId);
    if(idx>-1) data[idx]=rec; else data.push(rec);
  }else{
    data.push(rec);
  }
  saveLocal();
  await supaUpsertTicket(rec);
  renderAll();
  closeModal();
  toast('Solicitação salva com sucesso');
}

/* excluir */
async function deleteTicket(){
  if(!editingId) return;
  if(!confirm('Deseja realmente excluir esta solicitação?')) return;
  data=data.filter(d=>d.id!==editingId);
  saveLocal();
  await supaDeleteTicket(editingId);
  renderAll();
  closeModal();
  toast('Solicitação excluída');
}

/* Comentário no histórico (chat interno do ticket) */
async function addChat(){
  if(!editingId) return;
  const text=qs('#inpChat').value.trim();
  if(!text) return;
  const t=findTicket(editingId);
  if(!t) return;
  addHistoryEntry(t,text);
  qs('#inpChat').value='';
  saveLocal();
  await supaUpsertTicket(t);
  await supaAddMessage(t.id,text);
}

/* Exportar histórico básico (CSV) */
function exportHistory(){
  if(!editingId) return;
  const t=findTicket(editingId);
  if(!t || !t.historico || !t.historico.length){
    toast('Sem histórico para exportar');
    return;
  }
  const rows=[['Data','Usuário','Texto']];
  t.historico.forEach(h=>{
    rows.push([
      new Date(h.at).toLocaleString('pt-BR'),
      h.user||'',
      h.text||''
    ]);
  });
  const ws=XLSX.utils.aoa_to_sheet(rows);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Historico');
  XLSX.writeFile(wb,'historico_'+(t.codigo||t.id)+'.xlsx');
}

/* eventos modal */
document.addEventListener('DOMContentLoaded',()=>{
  qs('#btnNew').addEventListener('click',()=>{
    editingId=null;
    fillForm({
      solicitante:(currentUser()||{}).name||'',
      prioridade:'Média',
      categoria:'Geral',
      status:'Aberto',
      historico:[]
    });
    openModal();
  });
  qs('#btnCloseModal').addEventListener('click',closeModal);
  qs('#btnSave').addEventListener('click',saveTicket);
  qs('#btnDelete').addEventListener('click',deleteTicket);
  qs('#btnAddChat').addEventListener('click',addChat);
  qs('#btnExportChat').addEventListener('click',exportHistory);
  qs('#btnGoClosed').addEventListener('click',showClosed);
  qs('#btnBackList').addEventListener('click',showMain);
  qs('#btnTheme').addEventListener('click',toggleTheme);
});

/* ========= Render Lista ========= */
const prioRank=p=>p==='Alta'?0: p==='Média'?1:2;
function getUnreadCount(d){
  var last=lastReadMap[d.id]||0;
  var me=(currentUser()||{}).name||'';
  return (d.historico||[]).filter(h=>h.at>last && h.user!==me).length
}

/* ordenação configurável */
function sortRows(rows){
  function scorePend(x){
    var isP=(x.status==='Pendente'), r=x.retomar_em? startOfDay(x.retomar_em):null, t=today0();
    var venc = (isP && r && r < t)? 2 : 0;
    var hoje = (isP && r && r.getTime()===t.getTime())? 1 : 0;
    return (venc*100)+(hoje*10);
  }

  if(sortField==='default'){
    return rows.sort((a,b)=>{
      var s=scorePend(b)-scorePend(a); if(s) return s;
      return prioRank(a.prioridade)-prioRank(b.prioridade) || b.abertoEm-a.abertoEm;
    });
  }

  const dirMult = (sortDir==='asc'? 1 : -1);

  return rows.sort((a,b)=>{
    let va=a[sortField], vb=b[sortField];
    if(va==null && vb!=null) return 1;
    if(vb==null && va!=null) return -1;
    if(va==null && vb==null) return 0;
    if(va<vb) return -1*dirMult;
    if(va>vb) return  1*dirMult;
    return 0;
  });
}

function updateSortIcons(){
  qsa('th .sort-icon').forEach(ic=>{
    ic.className='fa fa-sort sort-icon';
  });
  if(sortField==='default') return;
  const th = qsa('th .th-label').find(el=>el.dataset.sort===sortField);
  if(!th) return;
  const icon=th.querySelector('.sort-icon');
  if(!icon) return;
  icon.className='fa fa-sort-'+(sortDir==='asc'?'up':'down')+' sort-icon';
}

/* define sort */
function setSort(field){
  if(sortField===field){
    sortDir=(sortDir==='asc'?'desc':'asc');
  }else{
    sortField=field;
    sortDir='asc';
  }
  currentPage=1;
  render();
}

let sortHandlersBound=false;
function bindSortHandlers(){
  if(sortHandlersBound) return;
  sortHandlersBound=true;
  qsa('th .th-label').forEach(el=>{
    el.addEventListener('click',()=>{
      const f=el.dataset.sort;
      if(f) setSort(f);
    });
  });
}

/* getClosedAt: procura histórico c/ status Encerrado, se existir */
function getClosedAt(d){
  if(!d || !d.historico) return null;
  // tenta achar a última entrada que indique encerramento (simples, baseado em texto)
  const enc = [...d.historico].reverse().find(h=>{
    const txt=(h.text||'').toLowerCase();
    return txt.includes('encerrado') || txt.includes('finalizado');
  });
  if(enc) return enc.at;
  // fallback: se está encerrado mas não tem histórico marcado,
  // usa data de abertura só para não "sumir" dos KPIs
  if (d.status === 'Encerrado') {
    return d.abertoEm;
  }
  return null;
}
function renderKPIs(){
  var input=qs('#kpiMonth'); if(!input.value){input.value=ym(new Date())}
  var sel=input.value; qs('#mKpiMesLabel').textContent=sel;

  var baseAbertos=data.filter(d=>ym(new Date(d.abertoEm))===sel);
  qs('#mKpiAberto').textContent    = baseAbertos.filter(d=>d.status==='Aberto').length;
  qs('#mKpiTratativa').textContent = baseAbertos.filter(d=>d.status==='Em tratativa').length;
  qs('#mKpiPendente').textContent  = baseAbertos.filter(d=>d.status==='Pendente').length;
  qs('#mKpiEncerrado').textContent = baseAbertos.filter(d=>d.status==='Encerrado').length;

  var closedThisMonth=data.map(d=>({d,closedAt:getClosedAt(d)})).filter(x=>x.closedAt && ym(new Date(x.closedAt))===sel);
  var closedWithSLA=closedThisMonth.filter(x=>!!x.d.prazo);

  var totalFechados=closedThisMonth.length;
  var fechadosNoPrazo=closedWithSLA.filter(x=>{
    var limit = startOfDay(x.d.prazo);
    var cd    = startOfDay(x.closedAt);
    return cd<=limit;
  }).length;
  var fechadosVencidos=closedWithSLA.filter(x=>{
    var limit = startOfDay(x.d.prazo);
    var cd    = startOfDay(x.closedAt);
    return cd>limit;
  }).length;

  qs('#mKpiFechados').textContent = totalFechados;
  qs('#mKpiFechadosBase').textContent = 'com SLA: '+closedWithSLA.length;
  qs('#mKpiQtdPrazo').textContent = fechadosNoPrazo+' de '+closedWithSLA.length;
  qs('#mKpiQtdVenc').textContent  = fechadosVencidos+' de '+closedWithSLA.length;

  var pctPrazo = closedWithSLA.length? Math.round((fechadosNoPrazo/closedWithSLA.length)*100):0;
  var pctVenc  = closedWithSLA.length? Math.round((fechadosVencidos/closedWithSLA.length)*100):0;
  qs('#mKpiPrazo').textContent = pctPrazo+'%';
  qs('#mKpiVenc').textContent  = pctVenc+'%';
}

/* charts */
function renderCharts(){
  var byCat={}, byCanal={};
  data.forEach(d=>{
    var cat=d.categoria||'Sem categoria';
    var canal=d.canal||d.transportadora||'N/A';
    byCat[cat]=(byCat[cat]||0)+1;
    byCanal[canal]=(byCanal[canal]||0)+1;
  });
  var catLabels=Object.keys(byCat);
  var catVals=catLabels.map(k=>byCat[k]);
  var canLabels=Object.keys(byCanal);
  var canVals=canLabels.map(k=>byCanal[k]);

  if(charts.cat) charts.cat.destroy();
  if(charts.canal) charts.canal.destroy();

  var ctx1=document.getElementById('chartCategoria').getContext('2d');
  charts.cat=new Chart(ctx1,{
    type:'doughnut',
    data:{
      labels:catLabels,
      datasets:[{data:catVals}]
    },
    options:{
      plugins:{
        legend:{display:true,position:'bottom',labels:{color:document.body.classList.contains('theme-light')?'#111827':'#e5e7eb',font:{size:11}}},
      }
    }
  });

  var ctx2=document.getElementById('chartCanal').getContext('2d');
  charts.canal=new Chart(ctx2,{
    type:'bar',
    data:{
      labels:canLabels,
      datasets:[{data:canVals}]
    },
    options:{
      scales:{
        x:{ticks:{color:document.body.classList.contains('theme-light')?'#111827':'#e5e7eb'}},
        y:{ticks:{color:document.body.classList.contains('theme-light')?'#111827':'#e5e7eb',precision:0,stepSize:1}}
      },
      plugins:{
        legend:{display:false}
      }
    }
  });
}

function render(){
  var term=(qs('#fSearch').value||'').toLowerCase().trim();
  var st=qs('#fStatus').value, pr=qs('#fPrio').value, cat=qs('#fCategoria').value, sla=qs('#fSLA').value;
  var pend=qs('#fPend').value; var mine=qs('#fMine').checked; var hideClosed=qs('#fHideClosed').checked;

  var rows=data.filter(d=>{
    var sLA=slaStatus(d.prazo).code;
    var searchable=[d.solicitante,d.assunto,d.descricao,d.codigo,d.transportadora,d.canal].join(' ').toLowerCase();

    var isPend=(d.status==='Pendente');
    var retoma=d.retomar_em? startOfDay(d.retomar_em) : null;
    var isPendDue=isPend && retoma && retoma < today0();

    if(term && searchable.indexOf(term)===-1) return false;
    if(!term && hideClosed && d.status==='Encerrado') return false;

    if(st && d.status!==st) return false;
    if(pr && d.prioridade!==pr) return false;
    if(cat && d.categoria!==cat) return false;
    if(sla && sLA!==sla) return false;
    if(pend==='pend' && !isPend) return false;
    if(pend==='due' && !isPendDue) return false;

    if(mine){
      var me = currentUser()||{};
      var byOwner = d.openedBy && d.openedBy===me.id;
      var bySolic = (d.solicitante||'')===(me.name||'');
      var byResp  = (d.responsavel||'')===(me.name||'');
      if(!byOwner && !bySolic && !byResp) return false;
    }
    return true;
  });

  rows = sortRows(rows);

  var tbody=qs('#tbody');
  if(!rows.length){
    tbody.innerHTML='<tr><td colspan="11" class="muted">Nenhum registro encontrado</td></tr>';
    qs('#pager').innerHTML='';
    updateSortIcons();
    return;
  }

  /* paginação */
  var total = rows.length;
  var totalPages = Math.max(1, Math.ceil(total/pageSize));
  if(currentPage>totalPages) currentPage = totalPages;
  if(currentPage<1) currentPage = 1;
  var start = (currentPage-1)*pageSize;
  var end   = Math.min(start+pageSize, total);
  var pageRows = rows.slice(start,end);

  tbody.innerHTML=pageRows.map(d=>{
    var slaObj=slaStatus(d.prazo,d);
    var tooltip = slaTooltip(d.prazo,d);
    var slaPill='<span class="badge" title="'+(tooltip || d.prazo || '')+'">'+slaObj.label+'</span>';
    var showConfirm=d.status==='Aberto';
    var unread=d.status==='Em tratativa'?getUnreadCount(d):0;
    var unreadBadge=unread>0?'<span class="badge-unread" title="'+unread+' nova(s)">'+unread+'</span>':'';
    var catCell = d.categoria==='SAK' ? '<span class="badge sak-badge">SAK</span>'
                 : d.categoria==='Frota - Transportadora' ? '<span class="badge frota-badge">Frota - Transportadora</span>'
                 : (d.categoria||'-');

    var rowClass='';
    var isPend=(d.status==='Pendente');
    var r=d.retomar_em? startOfDay(d.retomar_em):null;
    var t=today0();
    if(isPend && r){
      if(r < t) rowClass='row-pendente-vencida';
      else if(r.getTime()===t.getTime()) rowClass='row-pendente-hoje';
    }

    return '<tr'+(rowClass? ' class="'+rowClass+'"':'')+'>\
      <td>'+fmtDate(d.abertoEm)+'</td>\
      <td>'+ (d.solicitante||'-') +'</td>\
      <td>'+ (d.assunto||'-') +'</td>\
      <td>'+ (d.codigo||'<span class="muted">—</span>') +'</td>\
      <td>'+catCell+'</td>\
      <td>'+ (d.canal||'<span class="muted">—</span>') +'</td>\
      <td>'+prioBadge(d.prioridade||'-')+'</td>\
      <td>'+statusBadge(d.status||'-')+'</td>\
      <td>'+ (d.prazo? slaPill : '<span class="muted">—</span>') +'</td>\
      <td>'+ (d.responsavel||'<span class="muted">—</span>') +'</td>\
      <td class="table-actions">\
        '+(showConfirm?'<button class="btn-warning btn-icon" title="Confirmar recebimento" onclick="confirmTicket(\''+d.id+'\')"><i class="fa fa-check-double"></i></button>':'')+'\
        <button class="btn-ghost btn-icon" title="Abrir" onclick="openEdit(\''+d.id+'\')"><i class="fa fa-pen-to-square"></i>'+unreadBadge+'</button>\
        <button class="btn-ghost btn-icon" title="Encerrar" onclick="closeTicket(\''+d.id+'\')"><i class="fa fa-check"></i></button>\
        <button class="btn-ghost btn-icon" title="Adiar (definir pendência)" onclick="snoozeTicket(\''+d.id+'\')"><i class="fa fa-clock"></i></button>\
        '+(d.status==='Pendente'?'<button class="btn-ghost btn-icon" title="Retomar agora" onclick="resumeTicket(\''+d.id+'\')"><i class="fa fa-play"></i></button>':'')+'\
      </td>\
    </tr>';
  }).join('');

  /* paginação footer */
  var pager=qs('#pager');
  pager.innerHTML='';
  var info=document.createElement('div');
  info.textContent='Mostrando '+(start+1)+'–'+(end)+' de '+total+' registros';
  pager.appendChild(info);

  var nav=document.createElement('div');
  nav.className='row';
  var btnPrev=document.createElement('button');
  btnPrev.className='btn btn-ghost';
  btnPrev.innerHTML='<i class="fa fa-chevron-left"></i>';
  btnPrev.disabled=currentPage<=1;
  btnPrev.onclick=()=>{currentPage--; render();};
  var pageLabel=document.createElement('span');
  pageLabel.className='muted';
  pageLabel.textContent='Página '+currentPage+' de '+totalPages;
  var btnNext=document.createElement('button');
  btnNext.className='btn btn-ghost';
  btnNext.innerHTML='<i class="fa fa-chevron-right"></i>';
  btnNext.disabled=currentPage>=totalPages;
  btnNext.onclick=()=>{currentPage++; render();};
  nav.appendChild(btnPrev);
  nav.appendChild(pageLabel);
  nav.appendChild(btnNext);
  pager.appendChild(nav);

  updateSortIcons();
  renderKPIs();
  renderCharts();
  bindSortHandlers();
}

/* ========= Render Encerrados ========= */
function renderClosedPage(){
  var term=(qs('#fClosed').value||'').toLowerCase().trim();
  var rows=data.filter(d=>{ 
    if(d.status!=='Encerrado')return false;
    if(!term) return true;
    var searchable=[d.solicitante,d.assunto,d.descricao,d.codigo,d.transportadora,d.canal].join(' ').toLowerCase();
    return searchable.indexOf(term)>-1;
  }).sort((a,b)=>b.abertoEm-a.abertoEm);

  var tbody=qs('#tbodyClosed');
  if(!rows.length){
    tbody.innerHTML='<tr><td colspan="11" class="muted">Nenhum registro encerrado encontrado</td></tr>';
    return;
  }
  tbody.innerHTML=rows.map(d=>{
    var slaObj=slaStatus(d.prazo,d);
    var tooltip=slaTooltip(d.prazo,d);
    var slaPill='<span class="badge" title="'+(tooltip||d.prazo||'')+'">'+slaObj.label+'</span>';
    var closedAt=getClosedAt(d);
    return '<tr>\
      <td>'+fmtDate(d.abertoEm)+'</td>\
      <td>'+ (d.solicitante||'-') +'</td>\
      <td>'+ (d.assunto||'-') +'</td>\
      <td>'+ (d.codigo||'<span class="muted">—</span>') +'</td>\
      <td>'+ (d.categoria||'-') +'</td>\
      <td>'+ (d.canal||'<span class="muted">—</span>') +'</td>\
      <td>'+prioBadge(d.prioridade||'-')+'</td>\
      <td>'+statusBadge(d.status||'-')+'</td>\
      <td>'+ (d.prazo? slaPill : '<span class="muted">—</span>') +'</td>\
      <td>'+ (d.responsavel||'<span class="muted">—</span>') +'</td>\
      <td>'+ (closedAt? fmtDate(closedAt) : '<span class="muted">—</span>') +'</td>\
    </tr>';
  }).join('');
}

/* ========= Ações rápidas na tabela ========= */
function openEdit(id){
  const t=findTicket(id);
  if(!t) return;
  editingId=id;
  fillForm(t);
  openModal();
  // marca como lido (para badge de unread)
  lastReadMap[id]=Date.now();
  render();
}
async function closeTicket(id){
  const t=findTicket(id); if(!t) return;
  if(!confirm('Encerrar esta solicitação?')) return;
  t.status='Encerrado';
  addHistoryEntry(t,'Solicitação encerrada.');
  saveLocal();
  await supaUpsertTicket(t);
  render();
}
function confirmTicket(id){
  const t=findTicket(id); if(!t) return;
  t.status='Em tratativa';
  addHistoryEntry(t,'Recebida e em tratativa.');
  saveLocal();
  supaUpsertTicket(t);
  render();
}
function snoozeTicket(id){
  const t=findTicket(id); if(!t) return;
  const daysStr=prompt('Em quantos dias úteis deseja retomar? (ex: 2)');
  if(!daysStr) return;
  const days=parseInt(daysStr,10);
  if(isNaN(days)||days<=0){alert('Informe um número válido');return;}
  const base=new Date();
  const retomar=addBusinessDays(base,days);
  t.status='Pendente';
  t.retomar_em=retomar.getTime();
  addHistoryEntry(t,'Marcado como pendente. Retomar em '+retomar.toLocaleDateString('pt-BR')+'.');
  saveLocal();
  supaUpsertTicket(t);
  render();
}
function resumeTicket(id){
  const t=findTicket(id); if(!t) return;
  t.status='Em tratativa';
  t.retomar_em=null;
  addHistoryEntry(t,'Retomado da pendência.');
  saveLocal();
  supaUpsertTicket(t);
  render();
}

/* ========= Filtros / eventos gerais ========= */
document.addEventListener('DOMContentLoaded',()=>{
  ['fSearch','fStatus','fPrio','fCategoria','fSLA','fPend'].forEach(id=>{
    const el=qs('#'+id); if(el) el.addEventListener('input',()=>{currentPage=1;render();});
  });
  ['fMine','fHideClosed'].forEach(id=>{
    const el=qs('#'+id); if(el) el.addEventListener('change',()=>{currentPage=1;render();});
  });
  qs('#fClosed').addEventListener('input',renderClosedPage);
  qs('#kpiMonth').addEventListener('change',()=>{renderKPIs();renderCharts();});
});

/* ========= DM (chat entre usuários) ========= */
let dmOpen=false;
let dmTarget=null;
let dmCache=[];
let dmLastRead={};
let dmSeen=new Set();

function dmKey(meId,otherId){return 'ci_dm_last_'+meId+'_'+otherId;}
function loadDmLast(){
  const me=currentUser(); if(!me) return;
  dmLastRead={};
  fakeUsers().forEach(u=>{
    if(u.id===me.id) return;
    const key=dmKey(me.id,u.id);
    const raw=localStorage.getItem(key);
    dmLastRead[u.id]= raw ? parseInt(raw,10):0;
  });
}
function saveDmLast(userId,timestamp){
  const me=currentUser(); if(!me)return;
  localStorage.setItem(dmKey(me.id,userId), String(timestamp));
  dmLastRead[userId]=timestamp;
}
function dmLastReadFor(userId){
  const me=currentUser(); if(!me)return 0;
  return dmLastRead[userId] || parseInt(localStorage.getItem(dmKey(me.id,userId))||'0',10);
}
function dmUnreadCount(userId){
  const me=currentUser(); if(!me) return 0;
  const last=dmLastReadFor(userId);
  return dmCache.filter(m=>
    (m.sender===userId && m.receiver===me.id && new Date(m.created_at).getTime()>last)
  ).length;
}
function setDmBadge(){
  const me=currentUser(); if(!me) return;
  const total=fakeUsers().filter(u=>u.id!==me.id).reduce((sum,u)=>sum+dmUnreadCount(u.id),0);
  const badge=qs('#badgeDm');
  if(total>0){
    badge.textContent=total;
    badge.classList.remove('hidden');
  }else{
    badge.classList.add('hidden');
  }
}
function renderDmUsers(){
  const me=currentUser(); if(!me) return;
  const box=qs('#dmUsers');
  const users=fakeUsers().filter(u=>u.id!==me.id);
  box.innerHTML=users.map(u=>{
    const unread=dmUnreadCount(u.id);
    const badge=unread>0?'<span class="badge-unread" style="transform:scale(.8);margin-left:auto">'+unread+'</span>':'';
    const active=(dmTarget && dmTarget.id===u.id);
    return '<div class="dm-user'+(active?' active':'')+'" data-id="'+u.id+'">\
      <span>'+escapeHtml(u.name)+'</span>'+badge+'\
    </div>';
  }).join('');
  qsa('.dm-user',box).forEach(el=>{
    el.onclick=()=>{
      const id=el.getAttribute('data-id');
      const u=fakeUsers().find(x=>x.id===id);
      if(u){
        dmTarget=u;
        renderDmUsers();
        renderDmChat(u);
      }
    };
  });
}
function renderDmChat(user){
  const me=currentUser(); if(!me) return;
  const box=qs('#dmMessages');
  const msgs=msgsWith(user.id);
  if(!msgs.length){
    box.innerHTML='<div class="muted">Nenhuma mensagem ainda. Inicie uma conversa com '+escapeHtml(user.name)+'.</div>';
  }else{
    box.innerHTML=msgs.map(m=>{
      const isMe=(m.sender===me.id);
      const side=isMe?'me':'other';
      const dt=new Date(m.created_at).toLocaleString('pt-BR');
      return '<div class="dm-bubble '+side+'">\
        <div>'+escapeHtml(m.body||'')+'</div>\
        <div class="dm-meta">'+(isMe?'Você':escapeHtml(user.name))+' • '+dt+'</div>\
      </div>';
    }).join('');
  }
  box.scrollTop=box.scrollHeight;
  markDmRead(user.id);
}
function msgsWith(userId){
  var me=currentUser(); if(!me) return [];
  return dmCache.filter(m=>
    (m.sender===me.id && m.receiver===userId) ||
    (m.sender===userId && m.receiver===me.id)
  ).sort((a,b)=>new Date(a.created_at)-new Date(b.created_at));
}
function markDmRead(userId){
  const me=currentUser(); if(!me)return;
  const now=Date.now();
  saveDmLast(userId,now);
  setDmBadge();
}
async function sendDm(){
  const me=currentUser(); if(!me || !dmTarget) return;
  const inp=qs('#dmInput');
  const text=inp.value.trim();
  if(!text) return;
  inp.value='';
  if(!supaReady()){
    toast('DM requer Supabase configurado (tabela dm_messages)');
    return;
  }
  const { data: auth } = await supa.auth.getUser();
  const senderId = auth?.user?.id || me.id;
  const receiverId = dmTarget.id;

  const { data, error } = await supa
    .from('dm_messages')
    .insert({
      sender:senderId,
      receiver:receiverId,
      body:text
    })
    .select();

  if(error){
    console.error(error); toast('Erro ao enviar DM');
    return;
  }
  if(data && data[0]){
    dmCache.push(data[0]);
    renderDmChat(dmTarget);
    setDmBadge();
  }
}
async function loadDM(silent){
  if(!supaReady())return;
  var me=currentUser(); if(!me) return;
  var r=await supa.from('dm_messages').select('id,sender,receiver,body,created_at').or('sender.eq.'+me.id+',receiver.eq.'+me.id).order('created_at',{ascending:true});
  if(r.error){ if(!silent){toast('DM indisponível. Crie a tabela dm_messages (id uuid, sender uuid, receiver uuid, body text, created_at).')} return; }
  dmCache=r.data||[];
  setDmBadge(); renderDmUsers(); if(dmTarget) renderDmChat(dmTarget);
}
function onDmInsert(row){
  var sig = [row.sender,row.receiver,row.body].join('|');
  if (dmSeen.has(sig)) return;
  dmSeen.add(sig);
  var me=currentUser(); if(!me) return;
  dmCache.push(row);
  if(dmTarget && (row.sender===dmTarget.id || row.receiver===dmTarget.id)){
    renderDmChat(dmTarget);
  }
  setDmBadge();
}
function initDmRealtime(){
  if(!supaReady()) return;
  const me=currentUser(); if(!me) return;
  const channel = supa
    .channel('dm-realtime')
    .on('postgres_changes',{event:'INSERT',schema:'public',table:'dm_messages'},payload=>{
      onDmInsert(payload.new);
    })
    .subscribe();
}

document.addEventListener('DOMContentLoaded',()=>{
  loadDmLast();
  qs('#btnDmToggle').addEventListener('click',()=>{
    dmOpen=!dmOpen;
    qs('#dmPanel').classList.toggle('hidden',!dmOpen);
    if(dmOpen){
      renderDmUsers();
      setDmBadge();
    }
  });
  qs('#btnCloseDm').addEventListener('click',()=>{
    dmOpen=false;
    qs('#dmPanel').classList.add('hidden');
  });
  qs('#dmSend').addEventListener('click',sendDm);
  qs('#dmInput').addEventListener('keydown',ev=>{
    if(ev.key==='Enter'){ev.preventDefault();sendDm();}
  });

  loadDM(true);
  initDmRealtime();
});

/* ========= Init ========= */
function renderAll(){
  render();
  renderClosedPage();
}
document.addEventListener('DOMContentLoaded',()=>{
  supaLoadTickets();
});

/* expose debug/global */
window.openEdit=openEdit; 
window.closeTicket=closeTicket; 
window.confirmTicket=confirmTicket;
window.snoozeTicket=snoozeTicket; 
window.resumeTicket=resumeTicket;
window.openDm=()=>{dmOpen=true;qs('#dmPanel').classList.remove('hidden');renderDmUsers();};
window.goPage=pg=>{currentPage=pg;render();};
window.setSort=setSort;
</script>
</body>
</html>
