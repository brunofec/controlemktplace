<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Controle Interno de Solicitações</title>

<!-- Fonts & Icons -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<link rel="icon" href="logo.png"/>

<!-- Libs -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="config.js"></script>

<style>
  :root{
    --bg:#0f1216; --panel:#151a21; --panel-2:#1b222b; --text:#e9eef5; --muted:#9aacbf;
    --primary:#4f8cff; --success:#21c38a; --warning:#ffbf47; --danger:#ff5d5d; --badge:#2a3442;
    --border:#263040; --shadow:0 10px 30px rgba(0,0,0,.35); --radius:16px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1600px;margin:0 auto;padding:20px}
  header{position:sticky;top:0;z-index:5;backdrop-filter:saturate(160%) blur(10px);
    background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,0)); border-bottom:1px solid var(--border)}
  .row{display:flex;gap:14px;flex-wrap:wrap;align-items:center}
  .brand{display:flex;align-items:center;gap:10px}
  .brand h1{font-size:22px;margin:0}
  .logo-top{height:48px;object-fit:contain}
  .actions{margin-left:auto;display:flex;gap:10px;align-items:center}
  button,.btn{background:var(--primary);color:#fff;border:none;padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer;
    transition:.2s transform ease,.2s opacity ease,.2s box-shadow ease;box-shadow:0 8px 18px rgba(79,140,255,.25)}
  button:hover{transform:translateY(-1px)} .btn-ghost{background:transparent;border:1px solid var(--border);color:var(--text);box-shadow:none}
  .btn-danger{background:var(--danger);box-shadow:0 8px 18px rgba(255,93,93,.25)} .btn-success{background:var(--success)}
  .btn-warning{background:var(--warning);color:#10151b}
  .btn-icon{padding:8px 10px;border-radius:10px;min-width:36px; display:inline-flex; align-items:center; justify-content:center; position:relative}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
  .filters{display:grid;grid-template-columns:1.4fr 1fr 1fr 1fr .8fr;gap:10px}
  input,select,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#0f1319;color:var(--text);outline:none;font-size:14px}
  .table-wrap{overflow:auto}
  table{width:100%;border-collapse:collapse}
  thead th{text-align:left;padding:12px;font-size:13px;letter-spacing:.02em;color:var(--muted);background:#0f1319;border-bottom:1px solid var(--border)}
  tbody td{padding:12px;border-bottom:1px solid var(--border);vertical-align:middle;font-size:14px}
  tbody tr:hover{background:#0f141a}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:var(--badge);font-size:12px}
  .status-aberto{background:#24324a;color:#9fc2ff} .status-tratativa{background:#243f34;color:#7eedc0}
  .status-encerrado{background:#37313e;color:#e6b4ff}
  .prio-alta{border:1px solid var(--danger);color:#ff9f9f} .prio-media{border:1px solid var(--warning);color:#ffd58a} .prio-baixa{border:1px solid #6fb7ff;color:#a8d3ff}
  .table-actions{display:flex;gap:8px;flex-wrap:nowrap;white-space:nowrap}
  .muted{color:var(--muted)} .nowrap{white-space:nowrap}

  /* Destaques por categoria */
  .sak-row{background-image: linear-gradient(to right, rgba(255,159,71,.06), transparent)}
  .sak-badge{background:#402a14; color:#ffb26b; border:1px solid #5a3a1b}
  .frota-row{background-image: linear-gradient(to right, rgba(79,140,255,.06), transparent)}
  .frota-badge{background:#223348; color:#aeddff; border:1px solid #2f4e68}

  /* Badge do chat não lido */
  .badge-unread{position:absolute; top:-6px; right:-6px; background:#ff5d5d; color:#fff; border-radius:999px; font-size:10px;
    min-width:16px; height:16px; padding:0 4px; display:grid; place-items:center; box-shadow:0 0 0 2px var(--panel)}

  .watermark{position:fixed;left:50%;transform:translateX(-50%);bottom:8px;color:#7a8596;font-size:12px;opacity:.65;pointer-events:none}
  .space{height:14px}
  .hidden{display:none !important}
  .readonly input, .readonly select, .readonly textarea{pointer-events:none; opacity:.8}

  /* Modal */
  .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.45);z-index:20}
  .modal.show{display:grid}
  .modal .card{width:min(980px,96vw);max-height:92vh;overflow:auto;background:var(--panel);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:16px}
  .grid-2{display:grid;grid-template-columns:1.3fr .7fr;gap:14px}
  .grid-form{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  .grid-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}

  /* Chat */
  .chat-box{display:flex;flex-direction:column;height:520px;border:1px solid var(--border);border-radius:12px;background:#0e1318}
  .chat-history{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:8px}
  .bubble{max-width:88%;padding:10px 12px;border-radius:12px}
  .me{align-self:flex-end;background:#1a2430;border:1px solid #203042}
  .them{align-self:flex-start;background:#171321;border:1px solid #2a2538}
  .bubble time{display:block;font-size:11px;color:#9aacbf;margin-top:6px}
  .chat-input{display:flex;gap:8px;padding:10px;border-top:1px solid var(--border)}
  .chat-input input{flex:1}

  /* Toast */
  .toast{position:fixed;right:14px;bottom:14px;z-index:9999;display:flex;flex-direction:column;gap:8px}
  .toast .t{background:var(--panel-2);border:1px solid var(--border);padding:10px 12px;border-radius:10px;box-shadow:var(--shadow);opacity:0;transform:translateY(10px);transition:.25s}
  .toast .t.show{opacity:1;transform:translateY(0)}

  /* KPIs */
  .kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .kpi-card{background:var(--panel-2);border:1px solid var(--border);border-radius:14px;padding:16px}
  .kpi-card small{color:var(--muted)} .kpi-card strong{display:block;font-size:26px;margin-top:8px}
  .kpi-sub{font-size:12px;color:var(--muted);margin-top:6px}
  .charts{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
  @media (max-width:1100px){ .charts{grid-template-columns:1fr} }
  .login-head{flex-direction:column;align-items:center;gap:6px}
  .login-head h2{margin:0}
</style>
</head>
<body>

<!-- ===== LOGIN ===== -->
<section id="loginSection" style="min-height:100vh;display:none;place-items:center;padding:20px">
  <div style="width:min(420px,92vw);background:var(--panel);border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);padding:22px">
    <div class="row login-head">
      <img src="logo.png" class="logo-top" alt="Logo">
      <h2>Entrar</h2>
    </div>
    <p class="muted" style="font-size:12px">Seja Bem-Vindo!</p>
    <div class="space"></div>
    <div class="row" style="flex-direction:column;gap:10px">
      <input id="loginUser" placeholder="Usuário ou e-mail" autofocus>
      <input id="loginPass" placeholder="Senha" type="password">
      <button id="btnLogin" class="btn-success"><i class="fa fa-right-to-bracket"></i> Entrar</button>
    </div>
  </div>
</section>

<!-- ===== APP ===== -->
<section id="appSection" style="display:none">
  <header>
    <div class="wrap row">
      <div class="brand">
        <img src="logo.png" class="logo-top" alt="Logo">
        <h1>Controle Interno de Solicitações</h1>
      </div>
      <div class="actions">
        <span id="whoami" class="pill"></span>
        <button id="btnKPIs" class="btn-ghost"><i class="fa fa-chart-pie"></i> Painel KPIs</button>
        <button id="btnNew"><i class="fa fa-plus"></i> Nova</button>
        <button id="btnExportXLSX" class="btn-ghost" title="Exportar Excel (.xlsx)"><i class="fa fa-file-excel"></i> Exportar</button>
        <button id="btnLogout" class="btn-ghost"><i class="fa fa-right-from-bracket"></i> Sair</button>
      </div>
    </div>
  </header>

  <!-- LISTA -->
  <main id="listPage" class="wrap">
    <section class="panel">
      <div class="row" style="align-items:center;margin-bottom:10px">
        <div class="filters" style="flex:1">
          <input id="fSearch" placeholder="Buscar por ID, assunto, solicitante, cód. cliente..."/>
          <select id="fStatus"><option value="">Todos os status</option><option>Aberto</option><option>Em tratativa</option><option>Encerrado</option></select>
          <select id="fPrio"><option value="">Todas as prioridades</option><option>Alta</option><option>Média</option><option>Baixa</option></select>
          <select id="fCategoria"><option value="">Todas as categorias</option><option>Frota - Transportadora</option><option>SAK</option></select>
          <select id="fSLA"><option value="">SLA</option><option value="ok">No prazo</option><option value="risk">Risco (<=12h)</option><option value="late">Vencido</option></select>
        </div>
        <button id="btnClear" class="btn-ghost" title="Limpar filtros"><i class="fa fa-eraser"></i></button>
      </div>

      <div class="table-wrap">
        <table id="tbl">
          <thead>
            <tr>
              <th>ID</th><th>Aberto em</th><th>Solicitante</th><th>Assunto</th><th>Código cliente</th>
              <th>Categoria</th><th>Prioridade</th><th>Status</th><th>SLA</th><th>Resp.</th><th class="nowrap">Ações</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="badge" style="margin-top:10px">SLA por prioridade: Alta 1 dia • Média 3 dias • Baixa 5 dias</div>
    </section>
  </main>

  <!-- KPIs -->
  <main id="kpiPage" class="wrap hidden">
    <section class="panel">
      <div class="row" style="align-items:center;gap:12px">
        <h2 style="margin:0;font-size:18px">Painel — KPIs</h2>
        <div style="margin-left:auto;display:flex;gap:10px;align-items:center">
          <label class="muted" for="kpiMonth">Mês:</label><input id="kpiMonth" type="month"/>
          <button id="btnBackList" class="btn-ghost"><i class="fa fa-table"></i> Voltar à Tabela</button>
        </div>
      </div>
      <div class="space"></div>

      <div class="kpi-grid">
        <div class="kpi-card"><small>Aberto (abertos no mês)</small><strong id="mKpiAberto">0</strong></div>
        <div class="kpi-card"><small>Em tratativa (abertos no mês)</small><strong id="mKpiTratativa">0</strong></div>
        <div class="kpi-card"><small>Vencido (SLA) (abertos no mês)</small><strong id="mKpiVencido">0</strong></div>
        <div class="kpi-card"><small>Encerrado (abertos no mês)</small><strong id="mKpiEncerrado">0</strong></div>
      </div>

      <div class="space"></div>
      <div class="kpi-grid">
        <div class="kpi-card"><small>Concluídos no mês</small><strong id="mKpiFechadosMes">0</strong><div class="kpi-sub" id="mKpiFechadosBase">com SLA: 0</div></div>
        <div class="kpi-card"><small>% concluídos no prazo</small><strong id="mKpiPctPrazo">0%</strong><div class="kpi-sub" id="mKpiQtdPrazo">0 de 0</div></div>
        <div class="kpi-card"><small>% concluídos vencidos</small><strong id="mKpiPctVenc">0%</strong><div class="kpi-sub" id="mKpiQtdVenc">0 de 0</div></div>
        <div class="kpi-card"><small>Mês selecionado</small><strong id="mKpiMesLabel">—</strong><div class="kpi-sub">Base dos KPIs acima</div></div>
      </div>

      <div class="charts">
        <div class="panel"><h3 style="margin:0 0 10px 0;font-size:16px">Abertos no mês — por categoria</h3><canvas id="chartAbertos"></canvas></div>
        <div class="panel"><h3 style="margin:0 0 10px 0;font-size:16px">Concluídos no mês — No prazo x Vencidos (por categoria)</h3><canvas id="chartConcluidos"></canvas></div>
        <div class="panel" style="grid-column:1/-1"><h3 style="margin:0 0 10px 0;font-size:16px">Abertos no mês — por transportadora</h3><canvas id="chartTransp"></canvas></div>
      </div>

      <div class="space"></div>
      <div class="badge">Regras: KPIs “abertos/…” usam a <u>data de abertura</u>. Percentuais usam tickets <u>encerrados</u> no mês. Transportadora considera apenas tickets com transportadora preenchida.</div>
    </section>
  </main>

  <div class="watermark">Desenvolvido por Bruno Ferreira da Cruz</div>
</section>

<!-- MODAL -->
<div class="modal" id="modal">
  <div class="card">
    <div class="row" style="align-items:center">
      <h2 id="modalTitle" style="margin:0;font-size:18px">Nova solicitação</h2>
      <div class="actions" style="margin-left:auto"><button class="btn-ghost" id="closeModal"><i class="fa fa-xmark"></i></button></div>
    </div>
    <div class="space"></div>

    <div class="grid-2">
      <!-- FORM -->
      <form id="frm" autocomplete="off" style="display:flex;flex-direction:column;gap:12px">
        <input type="hidden" id="ticketId">

        <div class="grid-form">
          <div><label>Solicitante</label><input id="solicitante" readonly/></div>
          <div><label>Categoria</label><select id="categoriaSel"><option>Frota - Transportadora</option><option>SAK</option></select></div>
          <div><label>Prioridade</label><select id="prioridade"><option>Alta</option><option selected>Média</option><option>Baixa</option></select></div>
        </div>

        <div class="grid-row">
          <div>
            <label>Assunto</label>
            <select id="assunto" required>
              <option value="">Selecione…</option>
              <option>Cliente Ausente</option>
              <option>Solicitação contato</option>
              <option>End. não encontrado</option>
              <option>Arrependimento</option>
              <option>Atraso de entrega</option>
              <option>Mercado Fraude</option>
              <option>Ruptura de estoque</option>
              <option>Danificado</option>
              <option>Erro cadastro</option>
              <option>Solicitar Coleta</option>
              <option>Barrar Entrega</option>
            </select>
          </div>
          <div><label>Status</label><select id="status"><option>Aberto</option><option>Em tratativa</option><option>Encerrado</option></select></div>
        </div>

        <div class="grid-3">
          <div><label>Código do Cliente</label><input id="codigo" placeholder="Ex.: 12345"/></div>
          <div id="transportadoraWrap">
            <label>Transportadora</label>
            <input id="transportadora" list="lstTransportadora" placeholder="Ex.: Total Express"/>
            <datalist id="lstTransportadora">
              <option value="Total Express"></option>
              <option value="Correios / Sedex"></option>
              <option value="Jadlog"></option>
              <option value="Sequoia"></option>
              <option value="Loggi"></option>
              <option value="J&amp;T"></option>
              <option value="Kangu"></option>
              <option value="DHL"></option>
              <option value="Outros"></option>
            </datalist>
          </div>
          <div id="responsavelWrap"><label>Responsável</label>
            <select id="responsavel"><option></option><option>Bruno</option><option>Maurilio</option><option>Jessica</option><option>Anna</option></select>
          </div>
        </div>

        <div><label>Descrição</label><textarea id="descricao" rows="4" placeholder="Detalhe o que precisa"></textarea></div>

        <div class="grid-row">
          <div><label>Prazo (SLA) — Data</label><input id="prazo" type="date"/></div>
          <div><label>&nbsp;</label><div class="badge">Definido automaticamente se vazio</div></div>
        </div>

        <div class="row" style="gap:8px">
          <button type="button" class="btn-warning btn-icon" id="btnConfirm" title="Confirmar (tratativa)"><i class="fa fa-check-double"></i></button>
          <button type="button" class="btn-danger btn-icon" id="btnDelete" title="Excluir"><i class="fa fa-trash"></i></button>
          <div style="flex:1"></div>
          <button class="btn-success" id="btnSave"><i class="fa fa-floppy-disk"></i> Salvar</button>
        </div>
      </form>

      <!-- CHAT -->
      <div>
        <label>Chat da Solicitação</label>
        <div class="chat-box">
          <div id="chatHistory" class="chat-history"></div>
          <div class="chat-input">
            <input id="chatText" placeholder="Digite uma mensagem e Enter"/>
            <button id="btnSendChat" class="btn-ghost btn-icon"><i class="fa fa-paper-plane"></i></button>
          </div>
        </div>
        <div style="margin-top:10px" class="muted" id="chatHint">Mensagens ficam registradas no histórico do ticket.</div>
      </div>
    </div>
  </div>
</div>

<!-- Toaster -->
<div id="toast" class="toast"></div>

<script>
/* ========= Helpers ========= */
const qs=(s,el=document)=>el.querySelector(s);
const qsa=(s,el=document)=>[...el.querySelectorAll(s)];
const fmtDate=(ts)=> new Date(ts).toLocaleString('pt-BR');
const uid=()=> Math.random().toString(36).slice(2,8).toUpperCase();
const escapeHtml=(str='')=>str.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
const debounce=(fn,ms=150)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}}; 
function toast(msg){const c=qs('#toast');const el=document.createElement('div');el.className='t';el.textContent=msg;c.appendChild(el);requestAnimationFrame(()=>el.classList.add('show'));setTimeout(()=>{el.classList.remove('show');setTimeout(()=>c.removeChild(el),250)},3000)}
function prioToDays(p){if(p==='Alta')return 1;if(p==='Média')return 3;return 5;}
function ensureSLA(prazo,prioridade,abertoEm){if(prazo)return prazo;const base=new Date(abertoEm||Date.now());base.setHours(0,0,0,0);base.setDate(base.getDate()+prioToDays(prioridade||'Média'));return base.toISOString().slice(0,10)}
function slaStatus(dateStr){if(!dateStr)return{code:'',label:'—'};const today=new Date();today.setHours(23,59,59,999);const due=new Date(dateStr+'T23:59:59');const diffH=(due-today)/36e5;if(diffH<0)return{code:'late',label:'Vencido'};if(diffH<=12)return{code:'risk',label:'Risco'};return{code:'ok',label:'No prazo'}}
function statusBadge(s){const map={'Aberto':'status-aberto','Em tratativa':'status-tratativa','Encerrado':'status-encerrado'};return `<span class="badge ${map[s]||''}"><i class="fa fa-circle"></i>${s}</span>`}
function prioBadge(p){const cls=p==='Alta'?'prio-alta':p==='Média'?'prio-media':'prio-baixa';return `<span class="badge ${cls}">${p}</span>`}
const ym=d=>d.toISOString().slice(0,7);
const DEFAULT_EMAIL_DOMAIN="koerich.com.br";

/* ========= Sessão + Supabase ========= */
const SESSION_KEY='ticket_session_v1';
const setSession=u=>localStorage.setItem(SESSION_KEY,JSON.stringify(u));
const currentUser=()=>{try{return JSON.parse(localStorage.getItem(SESSION_KEY)||'')}catch{return null}};
const clearSession=()=>localStorage.removeItem(SESSION_KEY);
const supa=supabase.createClient(window.ENV.SUPABASE_URL,window.ENV.SUPABASE_ANON_KEY);

/* ========= Estado ========= */
let data=[]; let lastReadMap={};
let chartAbertos=null, chartConcluidos=null, chartTransp=null;

/* ========= DB ========= */
async function loadFromSupabase(){
  const {data:tks,error}=await supa.from('tickets').select('*').order('aberto_em',{ascending:false});
  if(error){console.error(error);alert('Falha ao carregar tickets.');return;}
  const ids=tks.map(t=>t.id);
  let msgsByTicket={};
  if(ids.length){
    const {data:msgs}=await supa.from('messages').select('*').in('ticket_id',ids).order('created_at',{ascending:true});
    (msgs||[]).forEach(m=>{(msgsByTicket[m.ticket_id]??=[]).push({at:new Date(m.created_at).getTime(),txt:m.body,user:m.sender_name||'—'})});
  }
  const me=currentUser(); lastReadMap={};
  if(me){const {data:lr}=await supa.from('last_reads').select('*').eq('user_id',me.id);(lr||[]).forEach(r=>lastReadMap[r.ticket_id]=new Date(r.last_read_at).getTime());}

  data=tks.map(t=>({
    id:t.id,
    abertoEm:new Date(t.aberto_em).getTime(),
    solicitante:t.solicitante,
    categoria:t.categoria,
    assunto:t.assunto,
    prioridade:t.prioridade,
    descricao:t.descricao||'',
    status:t.status,
    responsavel:t.responsavel||'',
    prazo:t.prazo?new Date(t.prazo).toISOString().slice(0,10):'',
    codigo:t.codigo||'',
    transportadora:t.transportadora||'',
    historico:msgsByTicket[t.id]||[]
  }));
}
async function supaUpsertTicket(rec){
  const payload={
    id:rec.id,
    aberto_em:new Date(rec.abertoEm).toISOString(),
    solicitante:rec.solicitante,
    categoria:rec.categoria,
    assunto:rec.assunto,
    prioridade:rec.prioridade,
    descricao:rec.descricao||null,
    status:rec.status,
    responsavel:rec.responsavel||null,
    prazo:rec.prazo||null,
    codigo:rec.codigo||null,
    transportadora:rec.transportadora||null,
    opened_by:currentUser()?.id||null,
    closed_at:rec.status==='Encerrado'?new Date().toISOString():null
  };
  const {error}=await supa.from('tickets').upsert(payload);
  if(error)console.error(error);
}
async function supaDeleteTicket(id){const {error}=await supa.from('tickets').delete().eq('id',id); if(error)console.error(error);}
async function supaAddMessage(ticketId,text){const u=currentUser();const payload={ticket_id:ticketId,sender:u?.id,sender_name:u?.name,body:text};const {error}=await supa.from('messages').insert(payload);if(error)console.error(error);}
async function supaMarkRead(ticketId){const u=currentUser();if(!u)return;const nowIso=new Date().toISOString();await supa.from('last_reads').upsert({ticket_id:ticketId,user_id:u.id,last_read_at:nowIso});lastReadMap[ticketId]=new Date(nowIso).getTime();}

/* ========= Realtime + fallback (2s/10s) ========= */
let __rtOK={messages:false,tickets:false}; let __pollId=null;

async function refreshNow(){await loadFromSupabase();render();}
function setPollTimer(){
  if(__pollId)clearInterval(__pollId);
  const ms=(document.visibilityState==='visible')?2000:10000;
  __pollId=setInterval(()=>{ if(!__rtOK.messages||!__rtOK.tickets){ refreshNow(); } },ms);
}
function setupRealtime(){
  // limpa canais antigos (evita duplicidade após login)
  supa.getChannels().forEach(ch=>supa.removeChannel(ch));

  supa.channel('realtime-messages')
    .on('postgres_changes',{event:'INSERT',schema:'public',table:'messages'},payload=>{
      const m=payload.new; const d=data.find(x=>x.id===m.ticket_id);
      if(d){
        d.historico.push({at:new Date(m.created_at).getTime(),txt:m.body,user:m.sender_name||'—'});
        render();
        if((currentUser()?.name||'')!==(m.sender_name||'')) toast(`Nova mensagem no ticket ${m.ticket_id}`);
      }
    })
    .subscribe(status=>{ __rtOK.messages=(status==='SUBSCRIBED'); });

  supa.channel('realtime-tickets')
    .on('postgres_changes',{event:'INSERT',schema:'public',table:'tickets'},async()=>{await refreshNow();})
    .on('postgres_changes',{event:'UPDATE',schema:'public',table:'tickets'},async()=>{await refreshNow();})
    .subscribe(status=>{ __rtOK.tickets=(status==='SUBSCRIBED'); });

  setPollTimer();
}
document.addEventListener('visibilitychange',setPollTimer);
window.addEventListener('focus',refreshNow);
window.addEventListener('online',()=>{setupRealtime();refreshNow();});

/* ========= Render Lista ========= */
const prioRank=p=>p==='Alta'?0:p==='Média'?1:2;
function getUnreadCount(d){const last=lastReadMap[d.id]||0;const me=currentUser()?.name||'';return (d.historico||[]).filter(h=>h.at>last&&h.user!==me).length;}
function render(){
  const term=qs('#fSearch').value.toLowerCase().trim();
  const st=qs('#fStatus').value, pr=qs('#fPrio').value, cat=qs('#fCategoria').value, sla=qs('#fSLA').value;
  const rows=data.filter(d=>{
    const sLA=slaStatus(d.prazo).code;
    const searchable=[d.id,d.solicitante,d.assunto,d.descricao,d.codigo,d.transportadora].join(' ').toLowerCase();
    return(!term||searchable.includes(term))&&(!st||d.status===st)&&(!pr||d.prioridade===pr)&&(!cat||d.categoria===cat)&&(!sla||sLA===sla);
  }).sort((a,b)=> prioRank(a.prioridade)-prioRank(b.prioridade) || b.abertoEm-a.abertoEm);

  qs('#tbody').innerHTML = rows.map(d=>{
    const slaObj=slaStatus(d.prazo);
    const slaPill=`<span class="badge" title="${d.prazo||''}">${slaObj.label}</span>`;
    const showConfirm=d.status==='Aberto';
    const unread=d.status==='Em tratativa'?getUnreadCount(d):0;
    const unreadBadge=unread>0?`<span class="badge-unread" title="${unread} nova(s)">${unread}</span>`:'';
    const rowCls = d.categoria==='SAK'?'sak-row' : d.categoria==='Frota - Transportadora'?'frota-row':'';
    const catCell = d.categoria==='SAK' ? `<span class="badge sak-badge">SAK</span>`
                 : d.categoria==='Frota - Transportadora' ? `<span class="badge frota-badge">Frota - Transportadora</span>`
                 : (d.categoria||'-');

    return `<tr class="${rowCls}">
      <td class="nowrap"><strong>${d.id}</strong></td>
      <td>${fmtDate(d.abertoEm)}</td>
      <td>${d.solicitante||'-'}</td>
      <td>${d.assunto||'-'}</td>
      <td>${d.codigo||'<span class="muted">—</span>'}</td>
      <td>${catCell}</td>
      <td>${prioBadge(d.prioridade||'-')}</td>
      <td>${statusBadge(d.status||'-')}</td>
      <td>${d.prazo? slaPill : '<span class="muted">—</span>'}</td>
      <td>${d.responsavel||'<span class="muted">—</span>'}</td>
      <td class="table-actions">
        ${showConfirm? `<button class="btn-warning btn-icon" title="Confirmar (vai para Em tratativa)" onclick="confirmTicket('${d.id}')"><i class="fa fa-check-double"></i></button>`:''}
        <button class="btn-ghost btn-icon" title="Abrir" onclick="openEdit('${d.id}')"><i class="fa fa-pen-to-square"></i>${unreadBadge}</button>
        <button class="btn-ghost btn-icon" title="Encerrar" onclick="closeTicket('${d.id}')"><i class="fa fa-check"></i></button>
      </td>
    </tr>`;
  }).join('') || `<tr><td colspan="11" class="muted">Nenhum registro encontrado</td></tr>`;
}

/* ========= KPIs ========= */
function getClosedAt(d){
  const h=(d.historico||[]).slice().sort((a,b)=>a.at-b.at);
  for(const e of h){ if((e.txt||'').toLowerCase().includes('encerrado')) return e.at; }
  return null;
}
function renderKPIs(){
  const input=qs('#kpiMonth'); if(!input.value){input.value=ym(new Date());}
  const sel=input.value; qs('#mKpiMesLabel').textContent=sel;

  const baseAbertos=data.filter(d=> ym(new Date(d.abertoEm))===sel );
  qs('#mKpiAberto').textContent    = baseAbertos.filter(d=>d.status==='Aberto').length;
  qs('#mKpiTratativa').textContent = baseAbertos.filter(d=>d.status==='Em tratativa').length;
  qs('#mKpiEncerrado').textContent = baseAbertos.filter(d=>d.status==='Encerrado').length;
  qs('#mKpiVencido').textContent   = baseAbertos.filter(d=> slaStatus(d.prazo).code==='late' && d.status!=='Encerrado').length;

  const closedThisMonth=data.map(d=>({d,closedAt:getClosedAt(d)})).filter(x=>x.closedAt&&ym(new Date(x.closedAt))===sel);
  const closedWithSLA=closedThisMonth.filter(x=>!!x.d.prazo);
  const denom=closedWithSLA.length;
  const onTime=closedWithSLA.filter(x=> new Date(x.d.prazo+'T23:59:59')>=new Date(x.closedAt)).length;
  const pctOn=denom?Math.round(onTime/denom*100):0;
  const pctLate=denom?100-pctOn:0;
  qs('#mKpiFechadosMes').textContent=closedThisMonth.length;
  qs('#mKpiFechadosBase').textContent=`com SLA: ${denom}`;
  qs('#mKpiPctPrazo').textContent=pctOn+'%';
  qs('#mKpiQtdPrazo').textContent=`${onTime} de ${denom}`;
  qs('#mKpiPctVenc').textContent=pctLate+'%';
  qs('#mKpiQtdVenc').textContent=`${denom-onTime} de ${denom}`;

  // gráfico por categoria
  const categorias=[...new Set(data.map(d=>d.categoria||'—'))].sort();
  const porCat=c=>baseAbertos.filter(d=>d.categoria===c);
  const valsAberto=categorias.map(c=>porCat(c).filter(d=>d.status==='Aberto').length);
  const valsTrat=categorias.map(c=>porCat(c).filter(d=>d.status==='Em tratativa').length);
  const valsEnc=categorias.map(c=>porCat(c).filter(d=>d.status==='Encerrado').length);

  const ctx1=document.getElementById('chartAbertos').getContext('2d');
  if(chartAbertos)chartAbertos.destroy();
  chartAbertos=new Chart(ctx1,{type:'bar',data:{labels:categorias,datasets:[{label:'Aberto',data:valsAberto},{label:'Em tratativa',data:valsTrat},{label:'Encerrado',data:valsEnc}]},options:{plugins:{legend:{position:'bottom'}},scales:{y:{beginAtZero:true,ticks:{precision:0}}}}});

  const closedByCat=c=>closedWithSLA.filter(x=>x.d.categoria===c);
  const valsPrazo=categorias.map(c=>closedByCat(c).filter(x=> new Date(x.d.prazo+'T23:59:59')>=new Date(x.closedAt)).length);
  const valsVenc=categorias.map(c=>closedByCat(c).filter(x=> new Date(x.d.prazo+'T23:59:59')< new Date(x.closedAt)).length);
  const ctx2=document.getElementById('chartConcluidos').getContext('2d');
  if(chartConcluidos)chartConcluidos.destroy();
  chartConcluidos=new Chart(ctx2,{type:'bar',data:{labels:categorias,datasets:[{label:'No prazo',data:valsPrazo},{label:'Vencidos',data:valsVenc}]},options:{plugins:{legend:{position:'bottom'}},scales:{y:{beginAtZero:true,ticks:{precision:0}}}}});

  // gráfico por transportadora (abertos no mês com transportadora preenchida)
  const baseTransp=baseAbertos.filter(d=> (d.transportadora||'').trim()!=='');
  const mapa={}; baseTransp.forEach(d=>{const k=d.transportadora.trim(); mapa[k]=(mapa[k]||0)+1;});
  const transp=Object.keys(mapa).sort((a,b)=>mapa[b]-mapa[a]);
  const valsTransp=transp.map(t=>mapa[t]);
  const ctx3=document.getElementById('chartTransp').getContext('2d');
  if(chartTransp)chartTransp.destroy();
  chartTransp=new Chart(ctx3,{type:'bar',data:{labels:transp,datasets:[{label:'Abertos',data:valsTransp}]},options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{precision:0}}}}});
}

/* ========= Modal + Form ========= */
function openModal(show=true){const m=qs('#modal'); if(!m)return; if(show){m.classList.add('show');m.style.display='grid';}else{m.classList.remove('show');m.style.display='none';}}
function setEditable(edit){
  const form=qs('#frm');
  form.classList.toggle('readonly',!edit);
  qsa('#frm input,#frm select,#frm textarea').forEach(el=>{if(['ticketId'].includes(el.id))return; el.readOnly=!edit; el.disabled=!edit;});
  qs('#solicitante').readOnly=true; qs('#solicitante').disabled=true;
}
function enablePriorityOnly(){
  qsa('#frm input, #frm select, #frm textarea').forEach(el=>{ if(['ticketId','prioridade'].includes(el.id))return; el.readOnly=true; el.disabled=true; });
  const p=qs('#prioridade'); p.disabled=false; p.readOnly=false; p.style.pointerEvents='auto'; p.style.opacity='1';
  qs('#btnSave').classList.remove('hidden');
}
function toggleResponsavelByCategoria(){
  const frota = qs('#categoriaSel').value==='Frota - Transportadora';
  qs('#responsavelWrap').classList.toggle('hidden', qs('#categoriaSel').value==='SAK');
  qs('#transportadoraWrap').classList.toggle('hidden', !frota);
}
function resetForm(){
  qs('#ticketId').value='';
  qs('#solicitante').value=currentUser()?.name||'';
  qs('#categoriaSel').value='Frota - Transportadora';
  qs('#assunto').value='';
  qs('#prioridade').value='Média';
  qs('#descricao').value='';
  qs('#status').value='Aberto';
  qs('#responsavel').value='';
  qs('#transportadora').value='';
  qs('#prazo').value='';
  qs('#codigo').value='';
  qs('#chatHistory').innerHTML=''; qs('#chatText').value='';
  qs('#btnDelete').style.display=(currentUser()?.role==='admin')?'inline-flex':'none';
  qs('#btnConfirm').disabled=true; qs('#btnSave').classList.remove('hidden');
  setEditable(true); toggleResponsavelByCategoria();
}
function renderChat(list){
  const u=currentUser()?.name||'';
  qs('#chatHistory').innerHTML=(list||[]).slice().sort((a,b)=>a.at-b.at).map(h=>`<div class="bubble ${h.user===u?'me':'them'}">${escapeHtml(h.txt)}<time>${new Date(h.at).toLocaleString('pt-BR')} • ${escapeHtml(h.user||'')}</time></div>`).join('');
  const div=qs('#chatHistory'); div.scrollTop=div.scrollHeight;
}
function setSelectValue(sel,value){if(!sel)return;const has=[...sel.options].some(o=>o.value===value); if(value&&!has){const o=document.createElement('option');o.value=value;o.textContent=value+' (legado)'; sel.appendChild(o);} sel.value=value||sel.value;}
function openNew(){resetForm();qs('#modalTitle').textContent='Nova solicitação';openModal(true);}
async function openEdit(id){
  const d=data.find(x=>x.id===id); if(!d)return;
  resetForm();
  qs('#modalTitle').textContent=`Solicitação ${d.id}`;
  qs('#ticketId').value=d.id;
  qs('#solicitante').value=d.solicitante||currentUser()?.name||'';
  qs('#categoriaSel').value=d.categoria||'Frota - Transportadora';
  setSelectValue(qs('#assunto'), d.assunto||'');
  qs('#prioridade').value=d.prioridade||'Média';
  qs('#descricao').value=d.descricao||'';
  qs('#status').value=d.status||'Aberto';
  qs('#responsavel').value=d.responsavel||'';
  qs('#prazo').value=d.prazo||'';
  qs('#codigo').value=d.codigo||'';
  qs('#transportadora').value=d.transportadora||'';
  renderChat(d.historico||[]);
  qs('#btnDelete').style.display=(currentUser()?.role==='admin')?'inline-flex':'none';
  qs('#btnConfirm').disabled=d.status!=='Aberto';
  setEditable(false); toggleResponsavelByCategoria(); enablePriorityOnly();
  await supaMarkRead(d.id); render(); openModal(true);
}
function collectForm(){
  const id=qs('#ticketId').value||uid();
  const now=Date.now(); const exists=data.find(x=>x.id===id); const abertoEm=exists?exists.abertoEm:now;
  const prazo=ensureSLA(qs('#prazo').value,qs('#prioridade').value,abertoEm);
  const categoria=qs('#categoriaSel').value;
  let responsavel=qs('#responsavel').value.trim(); if(categoria==='SAK') responsavel='';
  return{
    id, abertoEm,
    solicitante:qs('#solicitante').value.trim(),
    categoria, assunto:qs('#assunto').value.trim(),
    prioridade:qs('#prioridade').value,
    descricao:qs('#descricao').value.trim(),
    status:qs('#status').value,
    responsavel,
    prazo,
    codigo:qs('#codigo').value.trim(),
    transportadora:qs('#transportadora').value.trim(),
    historico: exists? exists.historico : [{at:abertoEm,txt:`Ticket aberto por ${qs('#solicitante').value.trim()||'usuário'}`,user:qs('#solicitante').value.trim()||'usuário'}]
  };
}
async function save(e){
  e.preventDefault();
  const rec=collectForm();
  if(!rec.solicitante || !rec.assunto){alert('Preencha Assunto. Solicitante vem do login.');return;}
  const i=data.findIndex(x=>x.id===rec.id);
  if(i>=0) data[i]={...data[i],...rec}; else data.push(rec);
  await supaUpsertTicket(rec);
  render();
  await addHistory(rec.id,`${i>=0?'Atualizado':'Criado'} por ${currentUser()?.name||'sistema'}`);
  openEdit(rec.id);
}
async function addHistory(id,text){const d=data.find(x=>x.id===id); if(!d)return; d.historico=d.historico||[]; d.historico.push({at:Date.now(),txt:text,user:currentUser()?.name||''}); renderChat(d.historico); await supaAddMessage(id,text);}
async function removeTicket(id){ if((currentUser()?.role)!=='admin'){alert('Apenas administradores podem excluir.');return;} if(!confirm('Deseja excluir esta solicitação?'))return; data=data.filter(x=>x.id!==id); await supaDeleteTicket(id); render(); openModal(false);}

/* ========= Ações ========= */
async function confirmTicket(id){
  const d=data.find(x=>x.id===id); if(!d)return;
  if(d.status==='Aberto'){
    d.status='Em tratativa';
    if(['SAK','Frota - Transportadora'].includes(d.categoria)){ d.responsavel=currentUser()?.name||d.responsavel||''; toast(`Responsável definido: ${d.responsavel}`); }
    await supaUpsertTicket(d);
    await addHistory(id,'Ticket confirmado e movido para Em tratativa');
    render();
  }
}
async function closeTicket(id){
  const d=data.find(x=>x.id===id); if(!d)return;
  if(d.status!=='Encerrado'){
    const old=d.status; d.status='Encerrado';
    await supaUpsertTicket(d);
    await addHistory(id,`Status alterado: ${old} ➜ Encerrado`);
    render();
  }
}

/* ========= Bindings ========= */
qs('#btnDelete').onclick=()=>removeTicket(qs('#ticketId').value);
qs('#btnConfirm').onclick=async()=>{const id=qs('#ticketId').value||(alert('Salve primeiro para confirmar.'),null); if(!id)return; await confirmTicket(id); await openEdit(id);};
qs('#frm').addEventListener('submit',save);
qs('#btnSave').addEventListener('click',save);
qs('#closeModal').addEventListener('click',()=>openModal(false));
qs('#categoriaSel').addEventListener('change',toggleResponsavelByCategoria);

// Nova
qs('#btnNew').addEventListener('click',e=>{e.preventDefault();e.stopPropagation();openNew();});

// Filtros em tempo real
qs('#fStatus').addEventListener('change',render);
qs('#fPrio').addEventListener('change',render);
qs('#fCategoria').addEventListener('change',render);
qs('#fSLA').addEventListener('change',render);
qs('#fSearch').addEventListener('input',debounce(render,200));
qs('#btnClear').onclick=()=>{qs('#fSearch').value='';qs('#fStatus').value='';qs('#fPrio').value='';qs('#fCategoria').value='';qs('#fSLA').value='';render();};

// Chat
async function sendChat(){const id=qs('#ticketId').value||(alert('Salve primeiro para conversar.'),null); if(!id)return; const txt=qs('#chatText').value.trim(); if(!txt)return; await addHistory(id,txt); qs('#chatText').value=''; await supaMarkRead(id); render();}
qs('#btnSendChat').onclick=sendChat;
qs('#chatText').addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();sendChat();}});

/* ========= Export Excel ========= */
function buildHistoricoString(hist){return (hist||[]).sort((a,b)=>a.at-b.at).map(h=>`${new Date(h.at).toLocaleString('pt-BR')} — ${h.user||''}: ${h.txt||''}`).join('\n');}
function exportXLSX(){
  const rows=data.slice().sort((a,b)=> prioRank(a.prioridade)-prioRank(b.prioridade) || b.abertoEm-a.abertoEm);
  const header=['ID','Aberto em','Solicitante','Categoria','Assunto','Prioridade','Descrição','Status','Responsável','Prazo (SLA)','Código/NF/DF','Transportadora','Histórico (chat)'];
  const aoa=[header];
  rows.forEach(r=>aoa.push([ r.id,new Date(r.abertoEm),r.solicitante||'',r.categoria||'',r.assunto||'',r.prioridade||'',r.descricao||'',r.status||'',r.responsavel||'',r.prazo?new Date(r.prazo+'T00:00:00'):'',r.codigo||'', r.transportadora||'', buildHistoricoString(r.historico) ]));
  const ws=XLSX.utils.aoa_to_sheet(aoa,{cellDates:true}); ws['!cols']=[{wch:8},{wch:19},{wch:14},{wch:22},{wch:24},{wch:10},{wch:28},{wch:14},{wch:12},{wch:12},{wch:16},{wch:18},{wch:60}];
  const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Tickets'); XLSX.writeFile(wb,`solicitacoes_${new Date().toISOString().slice(0,10)}.xlsx`);
}
qs('#btnExportXLSX').onclick=exportXLSX;

/* ========= Navegação KPIs ========= */
qs('#btnKPIs').onclick=()=>{qs('#listPage').classList.add('hidden');qs('#kpiPage').classList.remove('hidden');renderKPIs();};
qs('#btnBackList').onclick=()=>{qs('#kpiPage').classList.add('hidden');qs('#listPage').classList.remove('hidden');render();};
qs('#kpiMonth').addEventListener('input',renderKPIs);

/* ========= Boot & Login ========= */
function showLogin(){qs('#loginSection').style.display='grid';qs('#appSection').style.display='none';}
function showApp(){qs('#loginSection').style.display='none';qs('#appSection').style.display='block';const u=currentUser();qs('#whoami').textContent=`${u.name} • ${u.role}`;}

async function boot(){
  const u=currentUser(); if(!u){showLogin();return;}
  showApp(); await loadFromSupabase(); render(); setupRealtime();
}
boot();

qs('#btnLogout').onclick=async()=>{await supa.auth.signOut(); clearSession(); showLogin();};

qs('#btnLogin').onclick=async()=>{
  const login=qs('#loginUser').value.trim().toLowerCase();
  const pass=qs('#loginPass').value;
  const email=login.includes('@')?login:`${login}@${DEFAULT_EMAIL_DOMAIN}`;
  if(!window.ENV?.SUPABASE_URL||!window.ENV?.SUPABASE_ANON_KEY){alert('config.js não carregado ou chaves ausentes.');return;}

  const {data, error}=await supa.auth.signInWithPassword({email,password:pass});
  if(error){console.error('Auth error:',error);alert(error.message||'Usuário ou senha inválidos.');return;}

  let {data:profile}=await supa.from('profiles').select('*').eq('id',data.user.id).maybeSingle();
  if(!profile){
    const username=email.split('@')[0];
    const display_name=username.replace(/[._-]+/g,' ').replace(/\b\w/g,c=>c.toUpperCase());
    await supa.from('profiles').upsert({id:data.user.id,username,display_name,role:'operador'});
    ({data:profile}=await supa.from('profiles').select('*').eq('id',data.user.id).single());
  }
  const user={id:data.user.id,username:profile.username,name:profile.display_name,role:profile.role};
  setSession(user); await loadFromSupabase(); showApp(); render(); setupRealtime();
};

/* expose debug */
window.openEdit=openEdit; window.closeTicket=closeTicket; window.confirmTicket=confirmTicket;
</script>
</body>
</html>
